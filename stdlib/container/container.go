// Generated by Kukicha v0.0.9 (requires Go 1.26+)

package container

import (
	"archive/tar"
	"bufio"
	"bytes"
	"encoding/base64"
	"errors"
	"fmt"
	dockertypes "github.com/docker/docker/api/types"
	dockercontainer "github.com/docker/docker/api/types/container"
	dockerevents "github.com/docker/docker/api/types/events"
	dockerimage "github.com/docker/docker/api/types/image"
	"github.com/docker/docker/client"
	"github.com/docker/docker/pkg/stdcopy"
	ctxpkg "github.com/duber000/kukicha/stdlib/ctx"
	kukierrors "github.com/duber000/kukicha/stdlib/errors"
	"github.com/duber000/kukicha/stdlib/json"
	kukistring "github.com/duber000/kukicha/stdlib/string"
	"io"
	"os"
	"path/filepath"
	"time"
)

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:43
type Engine struct {
	cli *client.Client
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:47
type Config struct {
	host       string
	apiVersion string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:52
type ContainerInfo struct {
	id     string
	image  string
	status string
	state  string
	names  []string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:60
type ImageInfo struct {
	id   string
	tags []string
	size int64
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:66
type BuildOutput struct {
	imageID string
	output  string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:71
type Auth struct {
	username      string
	password      string
	serverAddress string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:77
type pullStatusMsg struct {
	Status string `json:"status"`
	ID     string `json:"id"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:82
type buildStreamMsg struct {
	Stream string         `json:"stream"`
	Aux    buildStreamAux `json:"aux"`
	Error  string         `json:"error"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:88
type buildStreamAux struct {
	ID string `json:"ID"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:92
type dockerAuthEntry struct {
	Auth string `json:"auth"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:96
type dockerConfig struct {
	Auths map[string]dockerAuthEntry `json:"auths"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:100
type ContainerEvent struct {
	id       string
	resource string
	action   string
	actor    string
	time     string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:108
func New() Config {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:109
	return Config{}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:112
func Host(cfg Config, host string) Config {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:113
	cfg.host = host
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:114
	return cfg
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:117
func APIVersion(cfg Config, version string) Config {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:118
	cfg.apiVersion = version
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:119
	return cfg
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:122
func Close(engine Engine) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:123
	return engine.cli.Close()
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:126
func ListContainers(engine Engine) ([]ContainerInfo, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:127
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:128
	containers, err := engine.cli.ContainerList(ctxpkg.Value(bg), dockercontainer.ListOptions{All: true})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:129
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:130
		return nil, kukierrors.Wrap(err, "container list")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:131
	result := make([]ContainerInfo, len(containers))
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:132
	for i, c := range containers {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:139
		result[i] = ContainerInfo{id: c.ID, image: c.Image, status: c.Status, state: c.State, names: c.Names}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:140
	return result, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:143
func ListImages(engine Engine) ([]ImageInfo, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:144
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:145
	images, err := engine.cli.ImageList(ctxpkg.Value(bg), dockerimage.ListOptions{All: true})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:146
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:147
		return nil, kukierrors.Wrap(err, "container list images")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:148
	result := make([]ImageInfo, len(images))
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:149
	for i, img := range images {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:154
		result[i] = ImageInfo{id: img.ID, tags: img.RepoTags, size: img.Size}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:155
	return result, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:158
func Stop(engine Engine, containerID string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:159
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:160
	err := engine.cli.ContainerStop(ctxpkg.Value(bg), containerID, dockercontainer.StopOptions{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:161
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:162
		return kukierrors.Wrap(err, "container stop")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:163
	return nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:166
func Remove(engine Engine, containerID string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:167
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:168
	err := engine.cli.ContainerRemove(ctxpkg.Value(bg), containerID, dockercontainer.RemoveOptions{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:169
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:170
		return kukierrors.Wrap(err, "container remove")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:171
	return nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:174
func Login(username string, password string, server string) Auth {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:175
	return Auth{username: username, password: password, serverAddress: server}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:178
func AuthEncode(auth Auth) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:183
	authJSON, _ := json.Marshal(map[string]string{"username": auth.username, "password": auth.password, "serveraddress": auth.serverAddress})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:184
	return base64.URLEncoding.EncodeToString(authJSON)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:187
func ContainerID(c ContainerInfo) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:188
	return c.id
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:191
func ContainerImage(c ContainerInfo) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:192
	return c.image
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:195
func ContainerStatus(c ContainerInfo) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:196
	return c.status
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:199
func ContainerState(c ContainerInfo) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:200
	return c.state
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:203
func ContainerNames(c ContainerInfo) []string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:204
	return c.names
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:207
func ImageID(img ImageInfo) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:208
	return img.id
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:211
func ImageTags(img ImageInfo) []string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:212
	return img.tags
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:215
func ImageSize(img ImageInfo) int64 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:216
	return img.size
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:219
func BuildImageID(b BuildOutput) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:220
	return b.imageID
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:223
func BuildLog(b BuildOutput) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:224
	return b.output
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:227
func EventID(event ContainerEvent) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:228
	return event.id
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:231
func EventResource(event ContainerEvent) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:232
	return event.resource
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:235
func EventAction(event ContainerEvent) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:236
	return event.action
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:239
func EventActor(event ContainerEvent) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:240
	return event.actor
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:243
func EventTime(event ContainerEvent) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:244
	return event.time
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:250
func containerLogs(cli *client.Client, containerID string, tail string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:251
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:252
	opts := dockercontainer.LogsOptions{ShowStdout: true, ShowStderr: true}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:253
	if tail != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:254
		opts.Tail = tail
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:255
	reader, err := cli.ContainerLogs(ctxpkg.Value(bg), containerID, opts)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:256
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:257
		return "", kukierrors.Wrap(err, "container logs")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:258
	defer reader.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:259
	stdout := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:260
	stderr := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:261
	_, copyErr := stdcopy.StdCopy(&stdout, &stderr, reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:262
	if copyErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:263
		raw, readErr := io.ReadAll(reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:264
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:265
			return "", kukierrors.Wrap(copyErr, "container logs")
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:266
		return string(raw), nil
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:267
	combined := stdout.String()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:268
	if stderr.Len() > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:269
		combined = (combined + stderr.String())
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:270
	return combined, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:273
func Logs(engine Engine, containerID string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:274
	return containerLogs(engine.cli, containerID, "")
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:277
func LogsTail(engine Engine, containerID string, lines int64) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:278
	return containerLogs(engine.cli, containerID, fmt.Sprintf("%d", lines))
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:281
func Run(engine Engine, img string, cmd []string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:282
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:286
	resp, err := engine.cli.ContainerCreate(ctxpkg.Value(bg), &dockercontainer.Config{Image: img, Cmd: cmd}, nil, nil, nil, "")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:287
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:288
		return "", kukierrors.Wrap(err, "container run create")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:289
	startErr := engine.cli.ContainerStart(ctxpkg.Value(bg), resp.ID, dockercontainer.StartOptions{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:290
	if startErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:291
		return "", kukierrors.Wrap(startErr, "container run start")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:292
	return resp.ID, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:295
func Inspect(engine Engine, containerID string) (ContainerInfo, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:296
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:297
	info, err := engine.cli.ContainerInspect(ctxpkg.Value(bg), containerID)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:298
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:299
		return ContainerInfo{}, kukierrors.Wrap(err, "container inspect")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:300
	names := make([]string, 0)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:301
	if info.Name != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:302
		names = append(names, kukistring.TrimPrefix(info.Name, "/"))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:303
	status := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:304
	state := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:305
	if info.State != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:306
		status = info.State.Status
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:307
		state = info.State.Status
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:308
	return ContainerInfo{id: info.ID, image: info.Config.Image, status: status, state: state, names: names}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:318
func Exec(engine Engine, containerID string, cmd []string, handles ...ctxpkg.Handle) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:319
	ctx := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:320
	if len(handles) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:321
		ctx = handles[0]
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:326
	createResp, err := engine.cli.ContainerExecCreate(ctxpkg.Value(ctx), containerID, dockertypes.ExecConfig{Cmd: cmd, AttachStdout: true, AttachStderr: true})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:327
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:328
		return "", kukierrors.Wrap(err, "container exec create")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:329
	attachResp, attachErr := engine.cli.ContainerExecAttach(ctxpkg.Value(ctx), createResp.ID, dockertypes.ExecStartCheck{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:330
	if attachErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:331
		return "", kukierrors.Wrap(attachErr, "container exec attach")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:332
	defer attachResp.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:333
	stdout := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:334
	stderr := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:335
	_, copyErr := stdcopy.StdCopy(&stdout, &stderr, attachResp.Reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:336
	if copyErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:337
		raw, readErr := io.ReadAll(attachResp.Reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:338
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:339
			return "", kukierrors.Wrap(copyErr, "container exec read")
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:340
		return string(raw), nil
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:341
	inspectResult, inspectErr := engine.cli.ContainerExecInspect(ctxpkg.Value(ctx), createResp.ID)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:342
	if inspectErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:343
		return "", kukierrors.Wrap(inspectErr, "container exec inspect")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:344
	combined := stdout.String()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:345
	if stderr.Len() > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:346
		combined = (combined + stderr.String())
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:347
	if inspectResult.ExitCode != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:348
		return combined, errors.New(fmt.Sprintf("container exec exit %v", inspectResult.ExitCode))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:349
	return combined, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:355
func Wait(engine Engine, containerID string, timeoutSeconds int64) (int64, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:356
	h := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:357
	if timeoutSeconds > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:358
		h = ctxpkg.WithTimeout(h, timeoutSeconds)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:359
	defer ctxpkg.Cancel(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:360
	goCtx := ctxpkg.Value(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:361
	waitCh, errCh := engine.cli.ContainerWait(goCtx, containerID, dockercontainer.WaitConditionNotRunning)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:362
	select {
	case err := <-errCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:364
		if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:365
			return -1, fmt.Errorf("container wait: %w", err)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:366
		return -1, errors.New("container wait: unknown wait error")
	case res := <-waitCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:368
		return res.StatusCode, nil
	}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:371
func WaitCtx(engine Engine, h ctxpkg.Handle, containerID string) (int64, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:372
	goCtx := ctxpkg.Value(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:373
	waitCh, errCh := engine.cli.ContainerWait(goCtx, containerID, dockercontainer.WaitConditionNotRunning)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:374
	select {
	case err := <-errCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:376
		if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:377
			return -1, fmt.Errorf("container wait: %w", err)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:378
		return -1, errors.New("container wait: unknown wait error")
	case res := <-waitCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:380
		return res.StatusCode, nil
	}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:385
func convertEvent(msg dockerevents.Message) ContainerEvent {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:386
	ts := time.Unix(msg.Time, 0).UTC().Format(time.RFC3339)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:387
	actor := msg.Actor.ID
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:388
	name, ok := msg.Actor.Attributes["name"]
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:389
	if ok && (name != "") {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:390
		actor = name
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:391
	return ContainerEvent{id: msg.ID, resource: string(msg.Type), action: string(msg.Action), actor: actor, time: ts}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:400
func eventsWithContext(engine Engine, h ctxpkg.Handle) ([]ContainerEvent, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:401
	goCtx := ctxpkg.Value(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:402
	msgCh, errCh := engine.cli.Events(goCtx, dockertypes.EventsOptions{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:403
	events := make([]ContainerEvent, 0)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:404
	for {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:405
		select {
		case <-goCtx.Done():
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:407
			return events, nil
		case err := <-errCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:409
			if (err == nil) || (goCtx.Err() != nil) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:410
				return events, nil
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:411
			return events, fmt.Errorf("container events: %w", err)
		case msg, ok := <-msgCh:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:413
			if !ok {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:414
				return events, nil
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:415
			events = append(events, convertEvent(msg))
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:416
	return events, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:420
func Events(engine Engine, timeoutSeconds int64) ([]ContainerEvent, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:421
	if timeoutSeconds <= 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:422
		timeoutSeconds = 15
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:423
	h := ctxpkg.WithTimeout(ctxpkg.Background(), timeoutSeconds)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:424
	defer ctxpkg.Cancel(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:425
	return eventsWithContext(engine, h)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:428
func EventsCtx(engine Engine, h ctxpkg.Handle) ([]ContainerEvent, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:429
	return eventsWithContext(engine, h)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:435
func Pull(engine Engine, ref string, handles ...ctxpkg.Handle) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:436
	bg := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:437
	if len(handles) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:438
		bg = handles[0]
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:439
	reader, err := engine.cli.ImagePull(ctxpkg.Value(bg), ref, dockerimage.PullOptions{})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:440
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:441
		return "", fmt.Errorf("container pull: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:442
	defer reader.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:443
	digest := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:444
	scanner := bufio.NewScanner(reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:445
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:446
		msg := pullStatusMsg{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:447
		unmarshalErr := json.Unmarshal(scanner.Bytes(), &msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:448
		if unmarshalErr == nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:449
			if kukistring.HasPrefix(msg.Status, "Digest:") {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:450
				digest = kukistring.TrimPrefix(msg.Status, "Digest: ")
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:451
	if digest == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:452
		digest = ref
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:453
	return digest, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:456
func PullAuth(engine Engine, ref string, auth Auth) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:461
	authJSON, jsonErr := json.Marshal(map[string]string{"username": auth.username, "password": auth.password, "serveraddress": auth.serverAddress})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:462
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:463
		return "", fmt.Errorf("container pull auth: %w", jsonErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:464
	encoded := base64.URLEncoding.EncodeToString(authJSON)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:467
	reader, err := engine.cli.ImagePull(ctxpkg.Value(ctxpkg.Background()), ref, dockerimage.PullOptions{RegistryAuth: encoded})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:468
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:469
		return "", fmt.Errorf("container pull: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:470
	defer reader.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:471
	digest := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:472
	scanner := bufio.NewScanner(reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:473
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:474
		msg := pullStatusMsg{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:475
		unmarshalErr := json.Unmarshal(scanner.Bytes(), &msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:476
		if unmarshalErr == nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:477
			if kukistring.HasPrefix(msg.Status, "Digest:") {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:478
				digest = kukistring.TrimPrefix(msg.Status, "Digest: ")
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:479
	if digest == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:480
		digest = ref
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:481
	return digest, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:486
func loadDockerAuth(serverAddress string) (string, string, string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:487
	home, homeErr := os.UserHomeDir()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:488
	if homeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:489
		return "", "", "", fmt.Errorf("container auth: %w", homeErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:490
	configPath := filepath.Join(home, ".docker", "config.json")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:491
	data, readErr := os.ReadFile(configPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:492
	if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:493
		return "", "", "", fmt.Errorf("container auth: %w", readErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:494
	config := dockerConfig{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:495
	unmarshalErr := json.Unmarshal(data, &config)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:496
	if unmarshalErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:497
		return "", "", "", fmt.Errorf("container auth parse: %w", unmarshalErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:498
	authEntry, ok := config.Auths[serverAddress]
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:499
	if !ok {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:505
		variations := []string{("https://" + serverAddress), ("http://" + serverAddress), kukistring.TrimPrefix(serverAddress, "https://"), kukistring.TrimPrefix(serverAddress, "http://")}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:506
		for _, v := range variations {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:507
			a, found := config.Auths[v]
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:508
			if found {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:509
				authEntry = a
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:510
				ok = true
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:511
				break
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:512
	if !ok {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:513
		return "", "", "", fmt.Errorf("container auth: no credentials found for %s", serverAddress)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:514
	if authEntry.Auth == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:515
		return "", "", "", fmt.Errorf("container auth: empty credentials for %s", serverAddress)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:516
	decoded, decodeErr := base64.StdEncoding.DecodeString(authEntry.Auth)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:517
	if decodeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:518
		return "", "", "", fmt.Errorf("container auth decode: %w", decodeErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:519
	parts := kukistring.SplitN(string(decoded), ":", 2)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:520
	if len(parts) != 2 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:521
		return "", "", "", fmt.Errorf("container auth: invalid credential format for %s", serverAddress)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:522
	return parts[0], parts[1], serverAddress, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:525
func LoginFromConfig(server string) (Auth, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:526
	username, password, addr, err := loadDockerAuth(server)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:527
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:528
		return Auth{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:529
	return Auth{username: username, password: password, serverAddress: addr}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:536
func newClient(host string) (*client.Client, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:537
	opts := []client.Opt{client.FromEnv, client.WithAPIVersionNegotiation()}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:538
	if host != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:539
		opts = append(opts, client.WithHost(host))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:540
	cli, err := client.NewClientWithOpts(opts...)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:541
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:542
		return nil, fmt.Errorf("container connect: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:543
	return cli, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:546
func Connect() (Engine, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:551
	socketPaths := []string{fmt.Sprintf("/run/user/%d/podman/podman.sock", os.Getuid()), "/var/run/docker.sock", "/run/podman/podman.sock"}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:552
	host := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:553
	for _, p := range socketPaths {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:554
		_, statErr := os.Stat(p)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:555
		if statErr == nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:556
			host = ("unix://" + p)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:557
			break
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:558
	cli, err := newClient(host)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:559
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:560
		return Engine{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:561
	return Engine{cli: cli}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:564
func ConnectRemote(host string) (Engine, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:565
	cli, err := newClient(host)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:566
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:567
		return Engine{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:568
	return Engine{cli: cli}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:571
func Open(cfg Config) (Engine, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:572
	opts := []client.Opt{client.FromEnv, client.WithAPIVersionNegotiation()}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:573
	if cfg.host != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:574
		opts = append(opts, client.WithHost(cfg.host))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:575
	if cfg.apiVersion != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:576
		opts = append(opts, client.WithVersion(cfg.apiVersion))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:577
	cli, err := client.NewClientWithOpts(opts...)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:578
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:579
		return Engine{}, fmt.Errorf("container open: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:580
	return Engine{cli: cli}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:584
func buildImage(cli *client.Client, contextPath string, tag string) (string, string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:585
	buf := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:586
	tw := tar.NewWriter(&buf)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:587
	absContextPath, absErr := filepath.Abs(contextPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:588
	if absErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:589
		return "", "", fmt.Errorf("container build: %w", absErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:619
	walkErr := filepath.WalkDir(absContextPath, func(walkPath string, d os.DirEntry, err error) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:591
		if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:592
			return err
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:593
		if d.IsDir() && (d.Name() == ".git") {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:594
			return filepath.SkipDir
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:596
		if d.Type() == os.ModeSymlink {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:597
			return nil
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:598
		relPath, relErr := filepath.Rel(absContextPath, walkPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:599
		if relErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:600
			return relErr
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:601
		if d.IsDir() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:602
			return nil
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:603
		info, infoErr := d.Info()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:604
		if infoErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:605
			return infoErr
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:606
		header, headerErr := tar.FileInfoHeader(info, "")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:607
		if headerErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:608
			return headerErr
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:609
		header.Name = relPath
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:610
		writeErr := tw.WriteHeader(header)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:611
		if writeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:612
			return writeErr
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:613
		f, openErr := os.Open(walkPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:614
		if openErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:615
			return openErr
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:616
		defer f.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:617
		_, copyErr := io.Copy(tw, f)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:618
		return copyErr
	})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:620
	if walkErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:621
		return "", "", fmt.Errorf("container build context: %w", walkErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:622
	closeErr := tw.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:623
	if closeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:624
		return "", "", fmt.Errorf("container build tar: %w", closeErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:629
	buildOpts := dockertypes.ImageBuildOptions{Tags: []string{tag}, Remove: true, Dockerfile: "Dockerfile"}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:630
	resp, buildErr := cli.ImageBuild(ctxpkg.Value(ctxpkg.Background()), &buf, buildOpts)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:631
	if buildErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:632
		return "", "", fmt.Errorf("container build: %w", buildErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:633
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:634
	output := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:635
	imageID := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:636
	scanner := bufio.NewScanner(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:637
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:638
		line := scanner.Text()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:639
		output.WriteString(line)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:640
		output.WriteString("\n")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:641
		msg := buildStreamMsg{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:642
		unmarshalErr := json.Unmarshal(scanner.Bytes(), &msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:643
		if unmarshalErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:644
			continue
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:645
		if msg.Error != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:646
			return "", output.String(), fmt.Errorf("container build: %s", msg.Error)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:647
		if msg.Aux.ID != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:648
			imageID = msg.Aux.ID
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:649
	scanErr := scanner.Err()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:650
	if scanErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:651
		return "", output.String(), fmt.Errorf("container build stream: %w", scanErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:652
	return imageID, output.String(), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:655
func Build(engine Engine, path string, tag string) (BuildOutput, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:656
	imageID, output, err := buildImage(engine.cli, path, tag)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:657
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:658
		return BuildOutput{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:659
	return BuildOutput{imageID: imageID, output: output}, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:662
func extractTar(reader io.Reader, destPath string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:663
	tr := tar.NewReader(reader)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:664
	cleanDest := filepath.Clean(destPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:665
	for {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:666
		header, err := tr.Next()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:667
		if err == io.EOF {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:668
			break
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:669
		if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:670
			return err
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:671
		cleanName := filepath.Clean(header.Name)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:672
		target := filepath.Join(destPath, cleanName)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:673
		sepStr := fmt.Sprintf("%c", filepath.Separator)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:674
		if !kukistring.HasPrefix(target, (cleanDest+sepStr)) && (filepath.Clean(target) != cleanDest) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:675
			return fmt.Errorf("invalid archive path: %s", header.Name)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:676
		switch header.Typeflag {
		case tar.TypeDir:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:678
			mkdirErr := os.MkdirAll(target, os.FileMode(header.Mode))
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:679
			if mkdirErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:680
				return mkdirErr
			}
		case tar.TypeReg:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:682
			parentErr := os.MkdirAll(filepath.Dir(target), 493)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:683
			if parentErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:684
				return parentErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:685
			f, openErr := os.OpenFile(target, ((os.O_CREATE | os.O_WRONLY) | os.O_TRUNC), os.FileMode(header.Mode))
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:686
			if openErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:687
				return openErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:688
			_, copyErr := io.Copy(f, tr)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:689
			if copyErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:690
				f.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:691
				return copyErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:692
			closeErr := f.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:693
			if closeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:694
				return closeErr
			}
		case tar.TypeSymlink, tar.TypeLink:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:696
			return fmt.Errorf("archive contains unsupported link entry: %s", header.Name)
		default:
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:698
			return fmt.Errorf("archive contains unsupported entry type %d: %s", header.Typeflag, header.Name)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:699
	return nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:702
func createTarFromPath(sourcePath string) (io.Reader, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:703
	absSourcePath, absErr := filepath.Abs(sourcePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:704
	if absErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:705
		return nil, fmt.Errorf("container copy to abs path: %w", absErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:707
	info, statErr := os.Lstat(absSourcePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:708
	if statErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:709
		return nil, fmt.Errorf("container copy to stat: %w", statErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:710
	if info.Mode().Type() == os.ModeSymlink {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:711
		return nil, fmt.Errorf("container copy to: source path is a symlink: %s", absSourcePath)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:712
	buf := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:713
	tw := tar.NewWriter(&buf)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:714
	if info.IsDir() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:748
		walkErr := filepath.WalkDir(absSourcePath, func(walkPath string, d os.DirEntry, err error) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:716
			if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:717
				return err
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:719
			if d.Type() == os.ModeSymlink {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:720
				return nil
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:721
			fi, fiErr := d.Info()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:722
			if fiErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:723
				return fiErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:725
			if fi.Mode().Type() == os.ModeSymlink {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:726
				return nil
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:727
			header, headerErr := tar.FileInfoHeader(fi, "")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:728
			if headerErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:729
				return headerErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:730
			rel, relErr := filepath.Rel(filepath.Dir(absSourcePath), walkPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:731
			if relErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:732
				return relErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:733
			header.Name = filepath.ToSlash(rel)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:734
			if fi.IsDir() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:735
				header.Name = (header.Name + "/")
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:736
			writeErr := tw.WriteHeader(header)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:737
			if writeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:738
				return writeErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:739
			if fi.Mode().IsRegular() {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:740
				f, openErr := os.Open(walkPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:741
				if openErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:742
					return openErr
				}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:743
				defer f.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:744
				_, copyErr := io.Copy(tw, f)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:745
				if copyErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:746
					return copyErr
				}
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:747
			return nil
		})
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:749
		if walkErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:750
			return nil, fmt.Errorf("container copy to walk: %w", walkErr)
		}
	} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:752
		header, headerErr := tar.FileInfoHeader(info, "")
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:753
		if headerErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:754
			return nil, fmt.Errorf("container copy to header: %w", headerErr)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:755
		header.Name = filepath.ToSlash(filepath.Base(absSourcePath))
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:756
		writeErr := tw.WriteHeader(header)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:757
		if writeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:758
			return nil, fmt.Errorf("container copy to write header: %w", writeErr)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:759
		f, openErr := os.Open(absSourcePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:760
		if openErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:761
			return nil, fmt.Errorf("container copy to open: %w", openErr)
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:762
		defer f.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:763
		_, copyErr := io.Copy(tw, f)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:764
		if copyErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:765
			return nil, fmt.Errorf("container copy to write file: %w", copyErr)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:766
	closeErr := tw.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:767
	if closeErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:768
		return nil, fmt.Errorf("container copy to close tar: %w", closeErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:769
	return &buf, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:773
func CopyFrom(engine Engine, containerID string, sourcePath string, destPath string, handles ...ctxpkg.Handle) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:774
	ctx := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:775
	if len(handles) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:776
		ctx = handles[0]
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:777
	return copyFromWithContext(engine, ctx, containerID, sourcePath, destPath)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:780
func copyFromWithContext(engine Engine, ctx ctxpkg.Handle, containerID string, sourcePath string, destPath string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:781
	reader, _, err := engine.cli.CopyFromContainer(ctxpkg.Value(ctx), containerID, sourcePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:782
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:783
		return fmt.Errorf("container copy from: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:784
	defer reader.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:785
	mkdirErr := os.MkdirAll(destPath, 493)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:786
	if mkdirErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:787
		return fmt.Errorf("container copy from mkdir: %w", mkdirErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:788
	extractErr := extractTar(reader, destPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:789
	if extractErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:790
		return fmt.Errorf("container copy from extract: %w", extractErr)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:791
	return nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:795
func CopyTo(engine Engine, containerID string, sourcePath string, destPath string, handles ...ctxpkg.Handle) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:796
	ctx := ctxpkg.Background()
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:797
	if len(handles) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:798
		ctx = handles[0]
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:799
	return copyToWithContext(engine, ctx, containerID, sourcePath, destPath)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:802
func copyToWithContext(engine Engine, ctx ctxpkg.Handle, containerID string, sourcePath string, destPath string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:803
	archive, archiveErr := createTarFromPath(sourcePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:804
	if archiveErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:805
		return archiveErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:806
	copyOpts := dockercontainer.CopyToContainerOptions{AllowOverwriteDirWithFile: true}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:807
	err := engine.cli.CopyToContainer(ctxpkg.Value(ctx), containerID, destPath, archive, copyOpts)
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:808
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:809
		return fmt.Errorf("container copy to: %w", err)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/container/container.kuki:810
	return nil
}
