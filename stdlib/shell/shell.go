// Generated by Kukicha v0.0.5 (requires Go 1.26+)
//
// Performance: GOEXPERIMENT=jsonv2 enables faster JSON parsing (2-10x improvement)

package shell

import (
	"bytes"
	"context"
	"errors"
	"fmt"
	"os"
	"os/exec"
	"time"
)

//line /home/user/kukicha/stdlib/shell/shell.kuki:12
type Command struct {
	name    string
	args    []string
	dir     string
	timeout int
	env     map[string]string
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:20
type Result struct {
	stdout   []byte
	stderr   []byte
	exitCode int
	err      error
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:31
func Output(name string, args ...string) (string, error) {
//line /home/user/kukicha/stdlib/shell/shell.kuki:32
	cmd := New(name, args...)
//line /home/user/kukicha/stdlib/shell/shell.kuki:33
	result := Execute(cmd)
//line /home/user/kukicha/stdlib/shell/shell.kuki:34
	if !Success(result) {
//line /home/user/kukicha/stdlib/shell/shell.kuki:35
		errStr := string(GetError(result))
//line /home/user/kukicha/stdlib/shell/shell.kuki:36
		return "", errors.New(fmt.Sprintf("%v", errStr))
	}
//line /home/user/kukicha/stdlib/shell/shell.kuki:37
	return string(GetOutput(result)), nil
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:41
func New(name string, args ...string) Command {
//line /home/user/kukicha/stdlib/shell/shell.kuki:42
	return Command{name: name, args: args, dir: "", timeout: 0, env: make(map[string]string)}
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:46
func Dir(cmd Command, path string) Command {
//line /home/user/kukicha/stdlib/shell/shell.kuki:47
	cmd.dir = path
//line /home/user/kukicha/stdlib/shell/shell.kuki:48
	return cmd
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:52
func SetTimeout(cmd Command, seconds int) Command {
//line /home/user/kukicha/stdlib/shell/shell.kuki:53
	cmd.timeout = seconds
//line /home/user/kukicha/stdlib/shell/shell.kuki:54
	return cmd
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:58
func Env(cmd Command, key string, value string) Command {
//line /home/user/kukicha/stdlib/shell/shell.kuki:59
	cmd.env[key] = value
//line /home/user/kukicha/stdlib/shell/shell.kuki:60
	return cmd
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:64
func Execute(cmd Command) Result {
//line /home/user/kukicha/stdlib/shell/shell.kuki:66
	execCmd := buildExecCmd(cmd)
//line /home/user/kukicha/stdlib/shell/shell.kuki:69
	if cmd.dir != "" {
//line /home/user/kukicha/stdlib/shell/shell.kuki:70
		execCmd.Dir = cmd.dir
	}
//line /home/user/kukicha/stdlib/shell/shell.kuki:73
	if len(cmd.env) > 0 {
//line /home/user/kukicha/stdlib/shell/shell.kuki:74
		env := os.Environ()
//line /home/user/kukicha/stdlib/shell/shell.kuki:75
		for key, value := range cmd.env {
//line /home/user/kukicha/stdlib/shell/shell.kuki:76
			env = append(env, fmt.Sprintf("%v=%v", key, value))
		}
//line /home/user/kukicha/stdlib/shell/shell.kuki:77
		execCmd.Env = env
	}
//line /home/user/kukicha/stdlib/shell/shell.kuki:80
	stdoutBuf := bytes.Buffer{}
//line /home/user/kukicha/stdlib/shell/shell.kuki:81
	stderrBuf := bytes.Buffer{}
//line /home/user/kukicha/stdlib/shell/shell.kuki:82
	execCmd.Stdout = &stdoutBuf
//line /home/user/kukicha/stdlib/shell/shell.kuki:83
	execCmd.Stderr = &stderrBuf
//line /home/user/kukicha/stdlib/shell/shell.kuki:86
	err := execCmd.Run()
//line /home/user/kukicha/stdlib/shell/shell.kuki:89
	exitCode := getExitCode(err)
//line /home/user/kukicha/stdlib/shell/shell.kuki:91
	return Result{stdout: stdoutBuf.Bytes(), stderr: stderrBuf.Bytes(), exitCode: exitCode, err: err}
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:94
func buildExecCmd(cmd Command) *exec.Cmd {
//line /home/user/kukicha/stdlib/shell/shell.kuki:95
	if cmd.timeout > 0 {
//line /home/user/kukicha/stdlib/shell/shell.kuki:96
		ctx, cancel := context.WithTimeout(context.Background(), (time.Duration(cmd.timeout) * time.Second))
//line /home/user/kukicha/stdlib/shell/shell.kuki:97
		defer cancel()
//line /home/user/kukicha/stdlib/shell/shell.kuki:98
		return exec.CommandContext(ctx, cmd.name, cmd.args...)
	}
//line /home/user/kukicha/stdlib/shell/shell.kuki:100
	return exec.Command(cmd.name, cmd.args...)
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:103
func getExitCode(err error) int {
//line /home/user/kukicha/stdlib/shell/shell.kuki:104
	if err == nil {
//line /home/user/kukicha/stdlib/shell/shell.kuki:105
		return 0
	}
//line /home/user/kukicha/stdlib/shell/shell.kuki:107
	switch exitErr := err.(type) {
	case *exec.ExitError:
//line /home/user/kukicha/stdlib/shell/shell.kuki:109
		return exitErr.ExitCode()
	default:
//line /home/user/kukicha/stdlib/shell/shell.kuki:111
		return 1
	}
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:117
func Success(result Result) bool {
//line /home/user/kukicha/stdlib/shell/shell.kuki:118
	return ((result.exitCode == 0) && (result.err == nil))
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:122
func GetOutput(result Result) []byte {
//line /home/user/kukicha/stdlib/shell/shell.kuki:123
	return result.stdout
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:127
func GetError(result Result) []byte {
//line /home/user/kukicha/stdlib/shell/shell.kuki:128
	return result.stderr
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:132
func ExitCode(result Result) int {
//line /home/user/kukicha/stdlib/shell/shell.kuki:133
	return result.exitCode
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:140
func Which(name string) bool {
//line /home/user/kukicha/stdlib/shell/shell.kuki:141
	_, err := exec.LookPath(name)
//line /home/user/kukicha/stdlib/shell/shell.kuki:142
	return (err == nil)
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:146
func Getenv(key string) string {
//line /home/user/kukicha/stdlib/shell/shell.kuki:147
	return os.Getenv(key)
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:151
func Setenv(key string, value string) error {
//line /home/user/kukicha/stdlib/shell/shell.kuki:152
	return os.Setenv(key, value)
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:156
func Unsetenv(key string) error {
//line /home/user/kukicha/stdlib/shell/shell.kuki:157
	return os.Unsetenv(key)
}

//line /home/user/kukicha/stdlib/shell/shell.kuki:162
func Environ() []string {
//line /home/user/kukicha/stdlib/shell/shell.kuki:163
	return os.Environ()
}
