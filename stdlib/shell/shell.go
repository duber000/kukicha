// Generated by Kukicha v0.0.5 (requires Go 1.26+)

package shell

import (
	"bytes"
	"errors"
	"fmt"
	ctxpkg "github.com/duber000/kukicha/stdlib/ctx"
	"os"
	"os/exec"
)

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:11
type Command struct {
	name    string
	args    []string
	dir     string
	timeout int
	env     map[string]string
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:19
type Result struct {
	stdout   []byte
	stderr   []byte
	exitCode int
	err      error
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:30
func Output(name string, args ...string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:31
	cmd := New(name, args...)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:32
	result := Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:33
	if !Success(result) {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:34
		errStr := string(GetError(result))
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:35
		return "", errors.New(fmt.Sprintf("%v", errStr))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:36
	return string(GetOutput(result)), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:40
func New(name string, args ...string) Command {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:41
	return Command{name: name, args: args, dir: "", timeout: 0, env: make(map[string]string)}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:45
func Dir(cmd Command, path string) Command {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:46
	cmd.dir = path
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:47
	return cmd
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:51
func SetTimeout(cmd Command, seconds int) Command {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:52
	cmd.timeout = seconds
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:53
	return cmd
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:57
func Env(cmd Command, key string, value string) Command {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:58
	cmd.env[key] = value
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:59
	return cmd
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:63
func Execute(cmd Command) Result {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:65
	execCmd := buildExecCmd(cmd)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:68
	if cmd.dir != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:69
		execCmd.Dir = cmd.dir
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:72
	if len(cmd.env) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:73
		env := os.Environ()
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:74
		for key, value := range cmd.env {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:75
			env = append(env, fmt.Sprintf("%v=%v", key, value))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:76
		execCmd.Env = env
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:79
	stdoutBuf := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:80
	stderrBuf := bytes.Buffer{}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:81
	execCmd.Stdout = &stdoutBuf
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:82
	execCmd.Stderr = &stderrBuf
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:85
	err := execCmd.Run()
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:88
	exitCode := getExitCode(err)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:90
	return Result{stdout: stdoutBuf.Bytes(), stderr: stderrBuf.Bytes(), exitCode: exitCode, err: err}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:93
func buildExecCmd(cmd Command) *exec.Cmd {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:94
	if cmd.timeout > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:95
		h := ctxpkg.WithTimeout(ctxpkg.Background(), int64(cmd.timeout))
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:96
		defer ctxpkg.Cancel(h)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:97
		return exec.CommandContext(ctxpkg.Value(h), cmd.name, cmd.args...)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:99
	return exec.Command(cmd.name, cmd.args...)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:102
func getExitCode(err error) int {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:103
	if err == nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:104
		return 0
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:106
	switch exitErr := err.(type) {
	case *exec.ExitError:
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:108
		return exitErr.ExitCode()
	default:
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:110
		return 1
	}
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:116
func Success(result Result) bool {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:117
	return ((result.exitCode == 0) && (result.err == nil))
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:121
func GetOutput(result Result) []byte {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:122
	return result.stdout
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:126
func GetError(result Result) []byte {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:127
	return result.stderr
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:131
func ExitCode(result Result) int {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:132
	return result.exitCode
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:139
func Which(name string) bool {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:140
	_, err := exec.LookPath(name)
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:141
	return (err == nil)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:145
func Getenv(key string) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:146
	return os.Getenv(key)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:150
func Setenv(key string, value string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:151
	return os.Setenv(key, value)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:155
func Unsetenv(key string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:156
	return os.Unsetenv(key)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:161
func Environ() []string {
//line /var/home/tluker/repos/go/kukicha/stdlib/shell/shell.kuki:162
	return os.Environ()
}
