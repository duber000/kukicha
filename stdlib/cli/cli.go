// Generated by Kukicha v0.0.1 (requires Go 1.25+)
//
// Performance options:
//   GOEXPERIMENT=greenteagc  - Green Tea GC (10-40% faster, default in Go 1.26)
//   GOEXPERIMENT=jsonv2      - Faster JSON parsing (2-10x improvement)

package cli

import (
	"errors"
	"fmt"
	"os"
	"strconv"
	"strings"
)

type ArgDef struct {
	name        string
	description string
}

type FlagDef struct {
	name         string
	description  string
	defaultValue string
}

type App struct {
	name   string
	args   []ArgDef
	flags  []FlagDef
	action func(Args)
}

type Args struct {
	values map[string]string
}

func NewArgs(values map[string]string) Args {
	return Args{values: values}
}

func New(name string) App {
	return App{name: name, args: make([]ArgDef, 0), flags: make([]FlagDef, 0), action: nil}
}

func Arg(app App, name string, description string) App {
	app.args = append(app.args, ArgDef{name: name, description: description})
	return app
}

func AddFlag(app App, name string, description string, defaultValue string) App {
	app.flags = append(app.flags, FlagDef{name: name, description: description, defaultValue: defaultValue})
	return app
}

func Action(app App, handler func(Args)) App {
	app.action = handler
	return app
}

func RunApp(app App) error {
	values := make(map[string]string)
	args := os.Args
	argIndex := 1
	for _, argDef := range app.args {
		if (argIndex < len(args)) && !strings.HasPrefix(args[argIndex], "--") {
			values[argDef.name] = args[argIndex]
			argIndex = (argIndex + 1)
		}
	}
	i := argIndex
	for i < len(args) {
		arg := args[i]
		if strings.HasPrefix(arg, "--") {
			parts := strings.SplitN(arg, "=", 2)
			flagName := strings.TrimPrefix(parts[0], "--")
			flagValue := ""
			if len(parts) > 1 {
				flagValue = parts[1]
			} else {
				i = (i + 1)
				if (i < len(args)) && !strings.HasPrefix(args[i], "--") {
					flagValue = args[i]
				} else {
					i = (i - 1)
				}
			}
			values[flagName] = flagValue
		}
		i = (i + 1)
	}
	for _, flagDef := range app.flags {
		if values[flagDef.name] == "" {
			values[flagDef.name] = flagDef.defaultValue
		}
	}
	if app.action != nil {
		parsedArgs := Args{values: values}
		app.action(parsedArgs)
		return nil
	}
	return errors.New("no action defined")
}

func GetString(args Args, name string) string {
	return args.values[name]
}

func GetBool(args Args, name string) bool {
	val := args.values[name]
	return (((val == "true") || (val == "1")) || (val == "yes"))
}

func GetInt(args Args, name string) (int, error) {
	strVal := args.values[name]
	if strVal == "" {
		return 0, errors.New(fmt.Sprintf("argument %v not found", name))
	}
	val, err := strconv.Atoi(strVal)
	return val, err
}
