# Tests for Kukicha Standard Library - Parse Package

petiole parse_test

import "stdlib/parse"
import "stdlib/test"
import "stdlib/string" as kukistring
import "testing"

# --- TestJson ---
type JsonCase
    name    string
    payload string
    want    string

func TestJson(t reference testing.T)
    cases := list of JsonCase{
        JsonCase{name: "basic json", payload: "{\"status\":\"ok\"}", want: "{\"status\":\"ok\"}"},
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            result, err := parse.Json(tc.payload)
            test.AssertNoError(t, err)
            test.AssertEqual(t, result as string, tc.want)
        )

# --- TestJsonLines ---
type JsonLinesCase
    name      string
    ndjson    string
    wantCount int
    firstLine string

func TestJsonLines(t reference testing.T)
    cases := list of JsonLinesCase{
        JsonLinesCase{
            name:      "basic ndjson",
            ndjson:    "{\"a\":1}\n\n {\"b\":2}\n",
            wantCount: 2,
            firstLine: "{\"a\":1}",
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            lines, err := parse.JsonLines(tc.ndjson)
            test.AssertNoError(t, err)
            test.AssertEqual(t, len(lines), tc.wantCount)
            if len(lines) > 0
                test.AssertEqual(t, lines[0], tc.firstLine)
        )

# --- TestCsvWithHeader ---
type CsvCase
    name           string
    csv            string
    wantRecords    int
    wantHeaderRows int
    firstRowName   string

func TestCsvWithHeader(t reference testing.T)
    cases := list of CsvCase{
        CsvCase{
            name:           "basic csv",
            csv:            "name,age\nalice,30\nbob,25",
            wantRecords:    3,
            wantHeaderRows: 2,
            firstRowName:   "alice",
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            records, err := parse.Csv(tc.csv)
            test.AssertNoError(t, err)
            test.AssertEqual(t, len(records), tc.wantRecords)

            headerRows, err2 := parse.CsvWithHeader(tc.csv)
            test.AssertNoError(t, err2)
            test.AssertEqual(t, len(headerRows), tc.wantHeaderRows)
            if len(headerRows) > 0
                test.AssertEqual(t, headerRows[0]["name"], tc.firstRowName)
        )

# --- TestYamlPretty ---
type YamlPrettyCase
    name     string
    data     map of string to any
    contains string

func TestYamlPretty(t reference testing.T)
    cases := list of YamlPrettyCase{
        YamlPrettyCase{
            name:     "basic map",
            data:     map of string to any{"user": map of string to any{"name": "sam"}},
            contains: "user",
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            pretty, err := parse.YamlPretty(tc.data)
            test.AssertNoError(t, err)
            test.AssertTrue(t, kukistring.Contains(pretty as string, tc.contains))
        )

# --- TestYaml ---
type JsonYamlCase
    name    string
    payload string
    want    string

func TestYaml(t reference testing.T)
    cases := list of JsonYamlCase{
        JsonYamlCase{
            name:    "basic yaml",
            payload: "user: alice\nemail: test@example.com",
            want:    "user: alice\nemail: test@example.com",
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            result, err := parse.Yaml(tc.payload)
            test.AssertNoError(t, err)
            test.AssertEqual(t, result as string, tc.want)
        )
