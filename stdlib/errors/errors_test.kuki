# Tests for Kukicha Standard Library - Errors Package

petiole errors_test

import "stdlib/errors"
import "errors" as goerrors
import "stdlib/test"
import "testing"

# --- TestWrapAndIs ---
type WrapCase
    name string
    baseMsg string
    wrapMsg string
    wantEqual bool

func TestWrapAndIs(t reference testing.T)
    cases := list of WrapCase{
        WrapCase{
            name: "wraps and identifies base error",
            baseMsg: "base",
            wrapMsg: "context",
            wantEqual: true,
        },
        WrapCase{
            name: "does not match different error",
            baseMsg: "base",
            wrapMsg: "context",
            wantEqual: false,
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            base := goerrors.New(tc.baseMsg)
            wrapped := errors.Wrap(base, tc.wrapMsg)
            if tc.wantEqual
                test.AssertTrue(t, errors.Is(wrapped, base))
            else
                test.AssertFalse(t, errors.Is(wrapped, goerrors.New("different")))
                
            unwrapped := errors.Unwrap(wrapped)
            if tc.wantEqual
                test.AssertEqual(t, unwrapped.Error(), tc.baseMsg)
            else
                test.AssertNotEmpty(t, unwrapped)
        )

# --- TestJoin ---
type JoinCase
    name string
    errs list of error
    wantNil bool

func TestJoin(t reference testing.T)
    cases := list of JoinCase{
        JoinCase{
            name: "joins multiple errors",
            errs: list of error{goerrors.New("a"), goerrors.New("b")},
            wantNil: false,
        },
        JoinCase{
            name: "returns nil for empty list",
            errs: list of error{},
            wantNil: true,
        },
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            e := errors.Join(many tc.errs)
            if tc.wantNil
                test.AssertNoError(t, e)
            else
                test.AssertError(t, e)
                test.AssertNoError(t, empty)
                errStr := e.Error()
                test.AssertNotEmpty(t, errStr)
                test.AssertTrue(t, len(errStr) > 0)
        )
