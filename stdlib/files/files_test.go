// Generated by Kukicha v0.0.4 (requires Go 1.26+)
//
// Performance: GOEXPERIMENT=jsonv2 enables faster JSON parsing (2-10x improvement)

package files_test

import (
	"github.com/duber000/kukicha/stdlib/files"
	"os"
	"path/filepath"
	"testing"
	"time"
)

type TestData struct {
	Name  string
	Value int
}

func TestReadWrite(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "test.txt")
	testContent := "Hello, Kukicha!"
	err = files.WriteString(testContent, testFile)
	if err != nil {
		t.Fatalf("files.WriteString failed: %v", err)
	}
	content, readErr := files.Read(testFile)
	if readErr != nil {
		t.Fatalf("files.Read failed: %v", readErr)
	}
	contentStr := string(content)
	if contentStr != testContent {
		t.Error("Content does not match expected")
	}
}

func TestWriteJSON(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "data.json")
	testData := TestData{Name: "test", Value: 42}
	err = files.Write(testData, testFile)
	if err != nil {
		t.Fatalf("files.Write failed: %v", err)
	}
	if !files.Exists(testFile) {
		t.Error("Expected file to exist after Write")
	}
	content, readErr := files.Read(testFile)
	if readErr != nil {
		t.Fatalf("files.Read failed: %v", readErr)
	}
	if len(content) == 0 {
		t.Error("Expected non-empty JSON content")
	}
}

func TestExists(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	existingFile := filepath.Join(tmpDir, "exists.txt")
	nonExistentFile := filepath.Join(tmpDir, "does-not-exist.txt")
	err = files.WriteString("test", existingFile)
	if err != nil {
		t.Fatalf("Failed to create test file: %v", err)
	}
	if !files.Exists(existingFile) {
		t.Error("Expected Exists to return true for existing file")
	}
	if files.Exists(nonExistentFile) {
		t.Error("Expected Exists to return false for non-existent file")
	}
}

func TestIsDir(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "file.txt")
	testDir := filepath.Join(tmpDir, "subdir")
	err = files.WriteString("test", testFile)
	if err != nil {
		t.Fatalf("Failed to create test file: %v", err)
	}
	err = os.Mkdir(testDir, 755)
	if err != nil {
		t.Fatalf("Failed to create test dir: %v", err)
	}
	if !files.IsDir(testDir) {
		t.Error("Expected IsDir to return true for directory")
	}
	if files.IsDir(testFile) {
		t.Error("Expected IsDir to return false for file")
	}
}

func TestList(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	files.WriteString("test1", filepath.Join(tmpDir, "file1.txt"))
	files.WriteString("test2", filepath.Join(tmpDir, "file2.txt"))
	os.Mkdir(filepath.Join(tmpDir, "subdir"), 755)
	entries, listErr := files.List(tmpDir)
	if listErr != nil {
		t.Fatalf("files.List failed: %v", listErr)
	}
	if len(entries) != 3 {
		t.Errorf("Expected 3 entries, got %v", len(entries))
	}
	for _, entry := range entries {
		if entry == "" {
			t.Error("Expected non-empty path")
		}
	}
}

func TestAppend(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "append.txt")
	err = files.WriteString("Line 1\n", testFile)
	if err != nil {
		t.Fatalf("files.WriteString failed: %v", err)
	}
	err = files.AppendString("Line 2\n", testFile)
	if err != nil {
		t.Fatalf("files.AppendString failed: %v", err)
	}
	content, readErr := files.Read(testFile)
	if readErr != nil {
		t.Fatalf("files.Read failed: %v", readErr)
	}
	expected := "Line 1\nLine 2\n"
	contentStr := string(content)
	if contentStr != expected {
		t.Error("Content does not match expected")
	}
}

func TestCopy(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	srcFile := filepath.Join(tmpDir, "source.txt")
	dstFile := filepath.Join(tmpDir, "destination.txt")
	testContent := "Copy me!"
	err = files.WriteString(testContent, srcFile)
	if err != nil {
		t.Fatalf("Failed to create source file: %v", err)
	}
	err = files.Copy(srcFile, dstFile)
	if err != nil {
		t.Fatalf("files.Copy failed: %v", err)
	}
	if !files.Exists(dstFile) {
		t.Error("Expected destination file to exist")
	}
	content, readErr := files.Read(dstFile)
	if readErr != nil {
		t.Fatalf("files.Read failed: %v", readErr)
	}
	contentStr := string(content)
	if contentStr != testContent {
		t.Error("Content does not match expected")
	}
}

func TestDelete(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "delete-me.txt")
	err = files.WriteString("test", testFile)
	if err != nil {
		t.Fatalf("Failed to create test file: %v", err)
	}
	if !files.Exists(testFile) {
		t.Error("Expected file to exist before deletion")
	}
	err = files.Delete(testFile)
	if err != nil {
		t.Fatalf("files.Delete failed: %v", err)
	}
	if files.Exists(testFile) {
		t.Error("Expected file to not exist after deletion")
	}
}

func TestTempFile(t *testing.T) {
	path, err := files.TempFile("kukicha-test-")
	if err != nil {
		t.Fatalf("files.TempFile failed: %v", err)
	}
	defer os.Remove(path)
	if !files.Exists(path) {
		t.Error("Expected temp file to exist")
	}
	err = files.WriteString("temp data", path)
	if err != nil {
		t.Errorf("Failed to write to temp file: %v", err)
	}
}

func TestPathFunctions(t *testing.T) {
	testPath := "/home/user/document.txt"
	basename := files.Basename(testPath)
	if basename != "document.txt" {
		t.Errorf("Expected basename 'document.txt', got '%v'", basename)
	}
	dirname := files.Dirname(testPath)
	if dirname != "/home/user" {
		t.Errorf("Expected dirname '/home/user', got '%v'", dirname)
	}
	ext := files.Extension(testPath)
	if ext != ".txt" {
		t.Errorf("Expected extension '.txt', got '%v'", ext)
	}
}

func TestUseWith(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-files-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	testFile := filepath.Join(tmpDir, "temp.txt")
	files.WriteString("content", testFile)
	existed := false
	files.UseWith(testFile, func(path string) {
		if files.Exists(path) {
			existed = true
		}
	})
	if !existed {
		t.Error("File should exist inside UseWith callback")
	}
	if files.Exists(testFile) {
		t.Error("File should be deleted after UseWith returns")
	}
	os.RemoveAll(tmpDir)
}

func TestWatch(t *testing.T) {
	tmpDir, err := os.MkdirTemp("", "kukicha-watch-test-")
	if err != nil {
		t.Fatalf("Failed to create temp dir: %v", err)
	}
	defer os.RemoveAll(tmpDir)
	testFile := filepath.Join(tmpDir, "watch.txt")
	files.WriteString("initial", testFile)
	ch := make(chan string)
	go files.Watch(filepath.Join(tmpDir, "*.txt"), func(path string) {
		ch <- path
	})
	time.Sleep((1 * time.Second))
	files.WriteString("modified", testFile)
	receivedPath := <-ch
	if receivedPath != testFile {
		t.Errorf("Expected change for %v, got %v", testFile, receivedPath)
	}
}
