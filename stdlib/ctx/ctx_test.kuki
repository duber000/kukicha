# Ctx Package Tests

petiole ctx_test

import "stdlib/ctx"
import "stdlib/test"
import "testing"
import "time"

# Test Background function
func TestBackground(t reference testing.T)
    h := ctx.Background()
    test.AssertNotEmpty(t, h)
    test.AssertFalse(t, ctx.Done(h))
    test.AssertEqual(t, ctx.Err(h), empty)

# Test WithTimeout function
func TestWithTimeout(t reference testing.T)
    parent := ctx.Background()
    h := ctx.WithTimeout(parent, 1)

    test.AssertNotEmpty(t, h)
    test.AssertFalse(t, ctx.Done(h))

    # Cancel the context
    canceled := ctx.Cancel(h)
    test.AssertTrue(t, canceled)

    # After cancellation, context should be done
    test.AssertTrue(t, ctx.Done(h))
    test.AssertNotEmpty(t, ctx.Err(h))

# Test WithTimeoutMs function
func TestWithTimeoutMs(t reference testing.T)
    parent := ctx.Background()
    h := ctx.WithTimeoutMs(parent, 100)

    test.AssertNotEmpty(t, h)
    test.AssertFalse(t, ctx.Done(h))

    # Cancel the context
    canceled := ctx.Cancel(h)
    test.AssertTrue(t, canceled)
    test.AssertTrue(t, ctx.Done(h))

# Test WithDeadlineUnix function
func TestWithDeadlineUnix(t reference testing.T)
    parent := ctx.Background()
    deadline := time.Now().Unix() + 10
    h := ctx.WithDeadlineUnix(parent, deadline)

    test.AssertNotEmpty(t, h)
    test.AssertFalse(t, ctx.Done(h))

    # Cancel the context
    canceled := ctx.Cancel(h)
    test.AssertTrue(t, canceled)
    test.AssertTrue(t, ctx.Done(h))

# Test Cancel function with no cancel function
func TestCancelNoCancelFunction(t reference testing.T)
    h := ctx.Background()
    canceled := ctx.Cancel(h)
    test.AssertFalse(t, canceled)

# Test Done function
func TestDone(t reference testing.T)
    h := ctx.Background()
    test.AssertFalse(t, ctx.Done(h))

# Test Err function
func TestErr(t reference testing.T)
    h := ctx.Background()
    test.AssertEqual(t, ctx.Err(h), empty)

# Test Value function
func TestValue(t reference testing.T)
    h := ctx.Background()
    goCtx := ctx.Value(h)
    # Value may be empty for a background context; just verify it doesn't panic
    _ = goCtx