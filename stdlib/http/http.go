// Generated by Kukicha v0.0.9 (requires Go 1.26+)

package http

import (
	"errors"
	"fmt"
	"github.com/duber000/kukicha/stdlib/cast"
	"github.com/duber000/kukicha/stdlib/fetch"
	"github.com/duber000/kukicha/stdlib/json"
	kukistring "github.com/duber000/kukicha/stdlib/string"
	"html"
	"io"
	"net/http"
	"net/url"
)

//line /home/user/kukicha/stdlib/http/http.kuki:19
func WithCSRF(handler http.Handler) http.Handler {
//line /home/user/kukicha/stdlib/http/http.kuki:20
	protection := http.NewCrossOriginProtection()
//line /home/user/kukicha/stdlib/http/http.kuki:21
	return protection.Handler(handler)
}

//line /home/user/kukicha/stdlib/http/http.kuki:25
func Serve(addr string, handler http.Handler) error {
//line /home/user/kukicha/stdlib/http/http.kuki:26
	return http.ListenAndServe(addr, handler)
}

//line /home/user/kukicha/stdlib/http/http.kuki:38
func JSON(w http.ResponseWriter, value any) error {
//line /home/user/kukicha/stdlib/http/http.kuki:39
	w.Header().Set("Content-Type", "application/json")
//line /home/user/kukicha/stdlib/http/http.kuki:40
	return json.MarshalWrite(w, value)
}

//line /home/user/kukicha/stdlib/http/http.kuki:45
func JSONStatus(w http.ResponseWriter, value any, status int) error {
//line /home/user/kukicha/stdlib/http/http.kuki:46
	w.Header().Set("Content-Type", "application/json")
//line /home/user/kukicha/stdlib/http/http.kuki:47
	w.WriteHeader(status)
//line /home/user/kukicha/stdlib/http/http.kuki:48
	return json.MarshalWrite(w, value)
}

//line /home/user/kukicha/stdlib/http/http.kuki:52
func JSONCreated(w http.ResponseWriter, value any) error {
//line /home/user/kukicha/stdlib/http/http.kuki:53
	return JSONStatus(w, value, 201)
}

//line /home/user/kukicha/stdlib/http/http.kuki:58
func JSONError(w http.ResponseWriter, message string, status int) error {
//line /home/user/kukicha/stdlib/http/http.kuki:59
	w.Header().Set("Content-Type", "application/json")
//line /home/user/kukicha/stdlib/http/http.kuki:60
	w.WriteHeader(status)
//line /home/user/kukicha/stdlib/http/http.kuki:61
	errorBody := map[string]string{"error": message}
//line /home/user/kukicha/stdlib/http/http.kuki:62
	return json.MarshalWrite(w, errorBody)
}

//line /home/user/kukicha/stdlib/http/http.kuki:66
func JSONBadRequest(w http.ResponseWriter, message string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:67
	return JSONError(w, message, 400)
}

//line /home/user/kukicha/stdlib/http/http.kuki:71
func JSONUnauthorized(w http.ResponseWriter, message string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:72
	return JSONError(w, message, 401)
}

//line /home/user/kukicha/stdlib/http/http.kuki:76
func JSONForbidden(w http.ResponseWriter, message string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:77
	return JSONError(w, message, 403)
}

//line /home/user/kukicha/stdlib/http/http.kuki:81
func JSONNotFound(w http.ResponseWriter, message string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:82
	return JSONError(w, message, 404)
}

//line /home/user/kukicha/stdlib/http/http.kuki:86
func JSONInternalError(w http.ResponseWriter, message string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:87
	return JSONError(w, message, 500)
}

//line /home/user/kukicha/stdlib/http/http.kuki:95
func ReadJSON(r *http.Request, target any) error {
//line /home/user/kukicha/stdlib/http/http.kuki:96
	return json.UnmarshalRead(r.Body, target)
}

//line /home/user/kukicha/stdlib/http/http.kuki:102
func ReadJSONAndClose(r *http.Request, target any) error {
//line /home/user/kukicha/stdlib/http/http.kuki:103
	defer r.Body.Close()
//line /home/user/kukicha/stdlib/http/http.kuki:104
	return json.UnmarshalRead(r.Body, target)
}

//line /home/user/kukicha/stdlib/http/http.kuki:109
func ReadJSONLimit(r *http.Request, maxBytes int64, target any) error {
//line /home/user/kukicha/stdlib/http/http.kuki:110
	limited := io.LimitReader(r.Body, maxBytes)
//line /home/user/kukicha/stdlib/http/http.kuki:111
	return json.UnmarshalRead(limited, target)
}

//line /home/user/kukicha/stdlib/http/http.kuki:115
func GetQueryParam(r *http.Request, key string) string {
//line /home/user/kukicha/stdlib/http/http.kuki:116
	return r.URL.Query().Get(key)
}

//line /home/user/kukicha/stdlib/http/http.kuki:120
func GetQueryParamOr(r *http.Request, key string, defaultValue string) string {
//line /home/user/kukicha/stdlib/http/http.kuki:121
	value := r.URL.Query().Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:122
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:123
		return defaultValue
	}
//line /home/user/kukicha/stdlib/http/http.kuki:124
	return value
}

//line /home/user/kukicha/stdlib/http/http.kuki:129
func GetQueryInt(r *http.Request, key string) (int, error) {
//line /home/user/kukicha/stdlib/http/http.kuki:130
	value := r.URL.Query().Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:131
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:132
		return 0, errors.New(fmt.Sprintf("query parameter '%v' is required", key))
	}
//line /home/user/kukicha/stdlib/http/http.kuki:133
	n, err := cast.Atoi(value)
//line /home/user/kukicha/stdlib/http/http.kuki:134
	if err != nil {
//line /home/user/kukicha/stdlib/http/http.kuki:135
		return 0, errors.New(fmt.Sprintf("query parameter '%v' must be an integer", key))
	}
//line /home/user/kukicha/stdlib/http/http.kuki:136
	return n, nil
}

//line /home/user/kukicha/stdlib/http/http.kuki:141
func GetQueryIntOr(r *http.Request, key string, defaultValue int) int {
//line /home/user/kukicha/stdlib/http/http.kuki:142
	value := r.URL.Query().Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:143
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:144
		return defaultValue
	}
//line /home/user/kukicha/stdlib/http/http.kuki:145
	n, err := cast.Atoi(value)
//line /home/user/kukicha/stdlib/http/http.kuki:146
	if err != nil {
//line /home/user/kukicha/stdlib/http/http.kuki:147
		return defaultValue
	}
//line /home/user/kukicha/stdlib/http/http.kuki:148
	return n
}

//line /home/user/kukicha/stdlib/http/http.kuki:154
func GetQueryBool(r *http.Request, key string) (bool, error) {
//line /home/user/kukicha/stdlib/http/http.kuki:155
	value := r.URL.Query().Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:156
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:157
		return false, errors.New(fmt.Sprintf("query parameter '%v' is required", key))
	}
//line /home/user/kukicha/stdlib/http/http.kuki:158
	lower := value
//line /home/user/kukicha/stdlib/http/http.kuki:159
	if ((lower == "true") || (lower == "1")) || (lower == "yes") {
//line /home/user/kukicha/stdlib/http/http.kuki:160
		return true, nil
	}
//line /home/user/kukicha/stdlib/http/http.kuki:161
	if ((lower == "false") || (lower == "0")) || (lower == "no") {
//line /home/user/kukicha/stdlib/http/http.kuki:162
		return false, nil
	}
//line /home/user/kukicha/stdlib/http/http.kuki:163
	return false, errors.New(fmt.Sprintf("query parameter '%v' must be a boolean", key))
}

//line /home/user/kukicha/stdlib/http/http.kuki:168
func GetQueryBoolOr(r *http.Request, key string, defaultValue bool) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:169
	value := r.URL.Query().Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:170
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:171
		return defaultValue
	}
//line /home/user/kukicha/stdlib/http/http.kuki:172
	if ((value == "true") || (value == "1")) || (value == "yes") {
//line /home/user/kukicha/stdlib/http/http.kuki:173
		return true
	}
//line /home/user/kukicha/stdlib/http/http.kuki:174
	if ((value == "false") || (value == "0")) || (value == "no") {
//line /home/user/kukicha/stdlib/http/http.kuki:175
		return false
	}
//line /home/user/kukicha/stdlib/http/http.kuki:176
	return defaultValue
}

//line /home/user/kukicha/stdlib/http/http.kuki:180
func GetHeader(r *http.Request, key string) string {
//line /home/user/kukicha/stdlib/http/http.kuki:181
	return r.Header.Get(key)
}

//line /home/user/kukicha/stdlib/http/http.kuki:185
func GetHeaderOr(r *http.Request, key string, defaultValue string) string {
//line /home/user/kukicha/stdlib/http/http.kuki:186
	value := r.Header.Get(key)
//line /home/user/kukicha/stdlib/http/http.kuki:187
	if value == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:188
		return defaultValue
	}
//line /home/user/kukicha/stdlib/http/http.kuki:189
	return value
}

//line /home/user/kukicha/stdlib/http/http.kuki:195
func NoContent(w http.ResponseWriter) {
//line /home/user/kukicha/stdlib/http/http.kuki:196
	w.WriteHeader(204)
}

//line /home/user/kukicha/stdlib/http/http.kuki:200
func Redirect(w http.ResponseWriter, r *http.Request, url string) {
//line /home/user/kukicha/stdlib/http/http.kuki:201
	http.Redirect(w, r, url, 302)
}

//line /home/user/kukicha/stdlib/http/http.kuki:205
func RedirectPermanent(w http.ResponseWriter, r *http.Request, url string) {
//line /home/user/kukicha/stdlib/http/http.kuki:206
	http.Redirect(w, r, url, 301)
}

//line /home/user/kukicha/stdlib/http/http.kuki:213
func SafeRedirect(w http.ResponseWriter, r *http.Request, redirectURL string, allowedHosts ...string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:214
	parsed, err := url.Parse(redirectURL)
//line /home/user/kukicha/stdlib/http/http.kuki:215
	if err != nil {
//line /home/user/kukicha/stdlib/http/http.kuki:216
		return err
	}
//line /home/user/kukicha/stdlib/http/http.kuki:217
	if parsed.Host == "" {
//line /home/user/kukicha/stdlib/http/http.kuki:219
		http.Redirect(w, r, redirectURL, 302)
//line /home/user/kukicha/stdlib/http/http.kuki:220
		return nil
	}
//line /home/user/kukicha/stdlib/http/http.kuki:222
	for _, host := range allowedHosts {
//line /home/user/kukicha/stdlib/http/http.kuki:223
		if parsed.Host == host {
//line /home/user/kukicha/stdlib/http/http.kuki:224
			http.Redirect(w, r, redirectURL, 302)
//line /home/user/kukicha/stdlib/http/http.kuki:225
			return nil
		}
	}
//line /home/user/kukicha/stdlib/http/http.kuki:226
	return errors.New(fmt.Sprintf("redirect to '%v' is not in the allowed hosts list", parsed.Host))
}

//line /home/user/kukicha/stdlib/http/http.kuki:232
func SafeURL(tmpl string, pathParams map[string]string, queryParams map[string]string) (string, error) {
//line /home/user/kukicha/stdlib/http/http.kuki:233
	base, err := fetch.URLTemplate(tmpl, pathParams)
//line /home/user/kukicha/stdlib/http/http.kuki:234
	if err != nil {
//line /home/user/kukicha/stdlib/http/http.kuki:235
		return "", err
	}
//line /home/user/kukicha/stdlib/http/http.kuki:236
	return fetch.URLWithQuery(base, queryParams)
}

//line /home/user/kukicha/stdlib/http/http.kuki:241
func Text(w http.ResponseWriter, content string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:242
	w.Header().Set("Content-Type", "text/plain; charset=utf-8")
//line /home/user/kukicha/stdlib/http/http.kuki:243
	_, err := io.WriteString(w, content)
//line /home/user/kukicha/stdlib/http/http.kuki:244
	return err
}

//line /home/user/kukicha/stdlib/http/http.kuki:248
func TextStatus(w http.ResponseWriter, content string, status int) error {
//line /home/user/kukicha/stdlib/http/http.kuki:249
	w.Header().Set("Content-Type", "text/plain; charset=utf-8")
//line /home/user/kukicha/stdlib/http/http.kuki:250
	w.WriteHeader(status)
//line /home/user/kukicha/stdlib/http/http.kuki:251
	_, err := io.WriteString(w, content)
//line /home/user/kukicha/stdlib/http/http.kuki:252
	return err
}

//line /home/user/kukicha/stdlib/http/http.kuki:259
func HTML(w http.ResponseWriter, content string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:260
	w.Header().Set("Content-Type", "text/html; charset=utf-8")
//line /home/user/kukicha/stdlib/http/http.kuki:261
	_, err := io.WriteString(w, content)
//line /home/user/kukicha/stdlib/http/http.kuki:262
	return err
}

//line /home/user/kukicha/stdlib/http/http.kuki:268
func SafeHTML(w http.ResponseWriter, content string) error {
//line /home/user/kukicha/stdlib/http/http.kuki:269
	w.Header().Set("Content-Type", "text/html; charset=utf-8")
//line /home/user/kukicha/stdlib/http/http.kuki:270
	_, err := io.WriteString(w, html.EscapeString(content))
//line /home/user/kukicha/stdlib/http/http.kuki:271
	return err
}

//line /home/user/kukicha/stdlib/http/http.kuki:278
func SetSecureHeaders(w http.ResponseWriter) {
//line /home/user/kukicha/stdlib/http/http.kuki:279
	w.Header().Set("X-Content-Type-Options", "nosniff")
//line /home/user/kukicha/stdlib/http/http.kuki:280
	w.Header().Set("X-Frame-Options", "DENY")
//line /home/user/kukicha/stdlib/http/http.kuki:281
	w.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")
//line /home/user/kukicha/stdlib/http/http.kuki:282
	w.Header().Set("Content-Security-Policy", "default-src 'self'")
}

//line /home/user/kukicha/stdlib/http/http.kuki:288
func IsGet(r *http.Request) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:289
	return (r.Method == "GET")
}

//line /home/user/kukicha/stdlib/http/http.kuki:293
func IsPost(r *http.Request) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:294
	return (r.Method == "POST")
}

//line /home/user/kukicha/stdlib/http/http.kuki:298
func IsPut(r *http.Request) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:299
	return (r.Method == "PUT")
}

//line /home/user/kukicha/stdlib/http/http.kuki:303
func IsDelete(r *http.Request) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:304
	return (r.Method == "DELETE")
}

//line /home/user/kukicha/stdlib/http/http.kuki:308
func IsPatch(r *http.Request) bool {
//line /home/user/kukicha/stdlib/http/http.kuki:309
	return (r.Method == "PATCH")
}

//line /home/user/kukicha/stdlib/http/http.kuki:314
func MethodNotAllowed(w http.ResponseWriter, allowed ...string) {
//line /home/user/kukicha/stdlib/http/http.kuki:315
	parts := []string{}
//line /home/user/kukicha/stdlib/http/http.kuki:316
	for _, method := range allowed {
//line /home/user/kukicha/stdlib/http/http.kuki:317
		parts = append(parts, method)
	}
//line /home/user/kukicha/stdlib/http/http.kuki:318
	allowHeader := kukistring.Join(parts, ", ")
//line /home/user/kukicha/stdlib/http/http.kuki:319
	w.Header().Set("Allow", allowHeader)
//line /home/user/kukicha/stdlib/http/http.kuki:320
	w.WriteHeader(405)
}

//line /home/user/kukicha/stdlib/http/http.kuki:321
func SecureHeaders(handler http.Handler) http.Handler {
//line /home/user/kukicha/stdlib/http/http.kuki:322
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
//line /home/user/kukicha/stdlib/http/http.kuki:323
		w.Header().Set("X-Content-Type-Options", "nosniff")
//line /home/user/kukicha/stdlib/http/http.kuki:324
		w.Header().Set("X-Frame-Options", "DENY")
//line /home/user/kukicha/stdlib/http/http.kuki:325
		w.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")
//line /home/user/kukicha/stdlib/http/http.kuki:326
		w.Header().Set("Content-Security-Policy", "default-src 'self'")
//line /home/user/kukicha/stdlib/http/http.kuki:327
		handler.ServeHTTP(w, r)
	})
}
