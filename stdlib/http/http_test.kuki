# Tests for Kukicha Standard Library - HTTP Package

petiole http_test

import "stdlib/http" as httphelper
import "stdlib/string"
import "testing"
import "net/http"
import "net/http/httptest"
import "net/url"

# Test JSON/Text helpers set the right headers, status, and body
func TestResponseHelpers(t reference testing.T)
    jsonRec := httptest.NewRecorder()
    err := httphelper.JSON(jsonRec, map of string to any{"status": "ok"})
    if err != empty
        t.Fatalf("JSON helper failed: {err}")
    resp := jsonRec.Result()
    if resp.StatusCode != 200
        t.Errorf("Expected 200, got {resp.StatusCode}")
    if resp.Header.Get("Content-Type") != "application/json"
        t.Errorf("Expected JSON content type, got {resp.Header.Get(\"Content-Type\")}")

    textRec := httptest.NewRecorder()
    err2 := httphelper.TextStatus(textRec, "bye", 201)
    if err2 != empty
        t.Fatalf("TextStatus failed: {err2}")
    if textRec.Result().StatusCode != 201
        t.Errorf("Expected 201 status, got {textRec.Result().StatusCode}")
    if textRec.Header().Get("Content-Type") != "text/plain; charset=utf-8"
        t.Errorf("Expected text/plain header")

    htmlRec := httptest.NewRecorder()
    err3 := httphelper.SafeHTML(htmlRec, "<script>x</script>")
    if err3 != empty
        t.Fatalf("SafeHTML failed: {err3}")
    if htmlRec.Header().Get("Content-Type") != "text/html; charset=utf-8"
        t.Errorf("Expected html content type")
    body := htmlRec.Body.String()
    if string.Contains(body, "<") or string.Contains(body, ">")
        t.Errorf("SafeHTML should escape content")

# Test SafeURL builds encoded URLs and respects query/path parameters
func TestSafeURL(t reference testing.T)
    safe, err := httphelper.SafeURL("/items/test-id", map of string to string{}, map of string to string{"q": "kuki"})
    if err != empty
        t.Fatalf("SafeURL failed: {err}")
    _, parseErr := url.ParseRequestURI(safe)
    if parseErr != empty
        t.Errorf("SafeURL should return valid URL, parse error {parseErr}")

# Test request helpers parse parameters and booleans
func TestRequestHelpers(t reference testing.T)
    req, _ := http.NewRequest("GET", "https://example.com/search?page=3&verbose=1", empty)
    if httphelper.GetQueryParam(req, "page") != "3"
        t.Errorf("GetQueryParam returned wrong page")
    if httphelper.GetQueryParamOr(req, "missing", "5") != "5"
        t.Errorf("GetQueryParamOr should fallback to default")

    page, err := httphelper.GetQueryInt(req, "page")
    if err != empty
        t.Fatalf("GetQueryInt failed: {err}")
    if page != 3
        t.Errorf("Expected page 3, got {page}")
    if httphelper.GetQueryIntOr(req, "missing", 7) != 7
        t.Errorf("GetQueryIntOr default mismatch")

    verbose, err2 := httphelper.GetQueryBool(req, "verbose")
    if err2 != empty
        t.Fatalf("GetQueryBool failed: {err2}")
    if not verbose
        t.Errorf("Expected verbose true")
    if not httphelper.GetQueryBoolOr(req, "missing", true)
        t.Errorf("GetQueryBoolOr should return default when missing")

# Test SafeRedirect enforces allowed hosts
func TestSafeRedirect(t reference testing.T)
    rec := httptest.NewRecorder()
    req, _ := http.NewRequest("GET", "https://example.com", empty)
    err := httphelper.SafeRedirect(rec, req, "https://example.com/home", "example.com")
    if err != empty
        t.Fatalf("SafeRedirect failed: {err}")
    if rec.Result().Header.Get("Location") != "https://example.com/home"
        t.Errorf("Expected location header to match redirect target")

    rec2 := httptest.NewRecorder()
    err2 := httphelper.SafeRedirect(rec2, req, "https://evil.com", "example.com")
    if err2 == empty
        t.Fatalf("SafeRedirect should return error for blocked host")

# Test Method helpers and secure headers
func TestMethodAndSecurityHelpers(t reference testing.T)
    req := httptest.NewRequest("POST", "/", empty)
    if not httphelper.IsPost(req)
        t.Errorf("Expected IsPost true")
    if httphelper.IsGet(req)
        t.Errorf("Expected IsGet false when method is POST")

    rec := httptest.NewRecorder()
    httphelper.SetSecureHeaders(rec)
    if rec.Header().Get("X-Content-Type-Options") != "nosniff"
        t.Errorf("Expected secure headers to be set")

    rec2 := httptest.NewRecorder()
    httphelper.MethodNotAllowed(rec2, "GET", "POST")
    if rec2.Result().StatusCode != 405
        t.Errorf("Expected 405 for MethodNotAllowed")
    if rec2.Header().Get("Allow") != "GET, POST"
        t.Errorf("Allow header should list provided methods")
