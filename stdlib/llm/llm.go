// Generated by Kukicha v0.0.4 (requires Go 1.26+)
//
// Performance: GOEXPERIMENT=jsonv2 enables faster JSON parsing (2-10x improvement)

package llm

import (
	"bufio"
	"errors"
	"fmt"
	"github.com/duber000/kukicha/stdlib/env"
	"github.com/duber000/kukicha/stdlib/fetch"
	"github.com/duber000/kukicha/stdlib/json"
	kukistring "github.com/duber000/kukicha/stdlib/string"
)

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:116
type Message struct {
	Role    string `json:"role"`
	Content string `json:"content"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:121
type ToolFunction struct {
	Name        string `json:"name"`
	Description string `json:"description"`
	Parameters  any    `json:"parameters"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:127
type Tool struct {
	Type     string       `json:"type"`
	Function ToolFunction `json:"function"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:132
type ToolCall struct {
	ID       string           `json:"id"`
	Type     string           `json:"type"`
	Function ToolCallFunction `json:"function"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:138
type ToolCallFunction struct {
	Name      string `json:"name"`
	Arguments string `json:"arguments"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:143
type Choice struct {
	Index        int             `json:"index"`
	Message      ResponseMessage `json:"message"`
	FinishReason string          `json:"finish_reason"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:149
type ResponseMessage struct {
	Role      string     `json:"role"`
	Content   string     `json:"content"`
	ToolCalls []ToolCall `json:"tool_calls,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:155
type Usage struct {
	PromptTokens     int `json:"prompt_tokens"`
	CompletionTokens int `json:"completion_tokens"`
	TotalTokens      int `json:"total_tokens"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:161
type Completion struct {
	ID      string   `json:"id"`
	Object  string   `json:"object"`
	Created int      `json:"created"`
	Model   string   `json:"model"`
	Choices []Choice `json:"choices"`
	Usage   Usage    `json:"usage"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:170
type ChunkDelta struct {
	Role    string `json:"role,omitzero"`
	Content string `json:"content,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:175
type ChunkChoice struct {
	Index        int        `json:"index"`
	Delta        ChunkDelta `json:"delta"`
	FinishReason string     `json:"finish_reason,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:181
type Chunk struct {
	ID      string        `json:"id"`
	Object  string        `json:"object"`
	Created int           `json:"created"`
	Model   string        `json:"model"`
	Choices []ChunkChoice `json:"choices"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:189
type CompletionRequest struct {
	Model            string    `json:"model"`
	Messages         []Message `json:"messages"`
	Temperature      float64   `json:"temperature,omitzero"`
	MaxTokens        int       `json:"max_tokens,omitzero"`
	TopP             float64   `json:"top_p,omitzero"`
	N                int       `json:"n,omitzero"`
	Stop             []string  `json:"stop,omitzero"`
	PresencePenalty  float64   `json:"presence_penalty,omitzero"`
	FrequencyPenalty float64   `json:"frequency_penalty,omitzero"`
	Seed             int       `json:"seed,omitzero"`
	User             string    `json:"user,omitzero"`
	Stream           bool      `json:"stream,omitzero"`
	Tools            []Tool    `json:"tools,omitzero"`
	ToolChoice       any       `json:"tool_choice,omitzero"`
	ResponseFormat   any       `json:"response_format,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:207
type Client struct {
	model            string
	provider         string
	baseURL          string
	path             string
	apiKey           string
	messages         []Message
	temperature      float64
	maxTokens        int
	topP             float64
	n                int
	stop             []string
	presencePenalty  float64
	frequencyPenalty float64
	seed             int
	user             string
	tools            []Tool
	toolChoice       any
	responseFormat   any
	streamHandler    func(string)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:232
func New(model string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:233
	c := Client{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:234
	c.messages = []Message{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:235
	c.tools = []Tool{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:236
	c.temperature = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:237
	c.maxTokens = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:238
	c.topP = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:239
	c.n = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:240
	c.seed = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:241
	c.presencePenalty = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:242
	c.frequencyPenalty = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:245
	if kukistring.Contains(model, ":") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:246
		parts := kukistring.SplitN(model, ":", 2)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:247
		c.provider = parts[0]
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:248
		c.model = parts[1]
	} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:250
		c.model = model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:251
		c.provider = ""
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:253
	c.baseURL = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:254
	c.path = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:255
	c.apiKey = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:256
	c.user = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:257
	c.streamHandler = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:258
	c.toolChoice = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:259
	c.responseFormat = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:260
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:264
func Provider(c Client, provider string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:265
	c.provider = provider
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:266
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:270
func Gateway(c Client, url string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:271
	c.baseURL = url
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:272
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:277
func BaseURL(c Client, url string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:278
	c.baseURL = url
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:279
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:284
func Path(c Client, path string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:285
	c.path = path
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:286
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:292
func APIKey(c Client, key string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:293
	c.apiKey = key
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:294
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:298
func System(c Client, content string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:299
	msg := Message{Role: "system", Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:300
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:301
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:305
func User(c Client, content string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:306
	msg := Message{Role: "user", Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:307
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:308
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:312
func Assistant(c Client, content string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:313
	msg := Message{Role: "assistant", Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:314
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:315
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:319
func AddMessage(c Client, role string, content string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:320
	msg := Message{Role: role, Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:321
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:322
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:326
func Messages(c Client, msgs []Message) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:327
	c.messages = msgs
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:328
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:333
func Temperature(c Client, temp float64) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:334
	c.temperature = temp
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:335
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:339
func MaxTokens(c Client, max int) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:340
	c.maxTokens = max
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:341
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:345
func TopP(c Client, p float64) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:346
	c.topP = p
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:347
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:351
func Stop(c Client, sequences []string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:352
	c.stop = sequences
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:353
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:358
func PresencePenalty(c Client, penalty float64) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:359
	c.presencePenalty = penalty
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:360
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:365
func FrequencyPenalty(c Client, penalty float64) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:366
	c.frequencyPenalty = penalty
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:367
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:371
func Seed(c Client, seed int) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:372
	c.seed = seed
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:373
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:377
func SetUser(c Client, user string) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:378
	c.user = user
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:379
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:384
func AddTool(c Client, name string, description string, parameters any) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:385
	fn := ToolFunction{Name: name, Description: description, Parameters: parameters}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:386
	tool := Tool{Type: "function", Function: fn}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:387
	c.tools = append(c.tools, tool)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:388
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:392
func ToolChoiceAuto(c Client) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:393
	c.toolChoice = "auto"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:394
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:398
func ToolChoiceRequired(c Client) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:399
	c.toolChoice = "required"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:400
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:404
func ToolChoiceNone(c Client) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:405
	c.toolChoice = "none"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:406
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:410
func JSONMode(c Client) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:411
	c.responseFormat = map[string]string{"type": "json_object"}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:412
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:417
func Stream(c Client, handler func(string)) Client {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:418
	c.streamHandler = handler
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:419
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:426
func Ask(c Client, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:427
	c = User(c, prompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:428
	return execute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:439
func Send(c Client) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:440
	return execute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:450
func SendRaw(c Client) (Completion, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:451
	return executeRaw(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:458
func Complete(model string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:459
	c := New(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:460
	return Ask(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:465
func CompleteWithSystem(model string, systemPrompt string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:466
	c := New(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:467
	c = System(c, systemPrompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:468
	return Ask(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:473
func GetContent(comp Completion) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:474
	if len(comp.Choices) == 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:475
		return ""
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:476
	return comp.Choices[0].Message.Content
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:481
func GetToolCalls(comp Completion) []ToolCall {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:482
	if len(comp.Choices) == 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:483
		return []ToolCall{}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:484
	return comp.Choices[0].Message.ToolCalls
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:488
func HasToolCalls(comp Completion) bool {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:489
	calls := GetToolCalls(comp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:490
	return (len(calls) > 0)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:493
func resolveAPIKey(c Client) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:494
	if c.apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:495
		return c.apiKey
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:498
	if c.provider == "openai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:499
		key := env.GetOr("OPENAI_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:500
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:501
	if c.provider == "anthropic" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:502
		key := env.GetOr("ANTHROPIC_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:503
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:504
	if c.provider == "mistral" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:505
		key := env.GetOr("MISTRAL_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:506
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:507
	if c.provider == "groq" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:508
		key := env.GetOr("GROQ_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:509
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:510
	if c.provider == "together" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:511
		key := env.GetOr("TOGETHER_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:512
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:513
	if c.provider == "deepseek" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:514
		key := env.GetOr("DEEPSEEK_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:515
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:516
	if c.provider == "xai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:517
		key := env.GetOr("XAI_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:518
		return key
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:521
	key := env.GetOr("LLM_API_KEY", "")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:522
	return key
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:525
func resolveBaseURL(c Client) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:526
	if c.baseURL != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:527
		return c.baseURL
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:530
	if c.provider == "openai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:531
		return "https://api.openai.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:532
	if c.provider == "anthropic" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:533
		return "https://api.anthropic.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:534
	if c.provider == "mistral" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:535
		return "https://api.mistral.ai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:536
	if c.provider == "groq" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:537
		return "https://api.groq.com/openai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:538
	if c.provider == "together" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:539
		return "https://api.together.xyz"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:540
	if c.provider == "deepseek" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:541
		return "https://api.deepseek.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:542
	if c.provider == "xai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:543
		return "https://api.x.ai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:544
	if c.provider == "ollama" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:545
		return "http://localhost:11434"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:548
	return "http://localhost:8000"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:551
func resolvePath(c Client) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:552
	if c.path != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:553
		return c.path
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:554
	return "/v1/chat/completions"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:557
func buildRequest(c Client) CompletionRequest {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:558
	req := CompletionRequest{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:559
	req.Model = c.model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:560
	req.Messages = c.messages
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:562
	if c.temperature != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:563
		req.Temperature = c.temperature
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:564
	if c.maxTokens != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:565
		req.MaxTokens = c.maxTokens
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:566
	if c.topP != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:567
		req.TopP = c.topP
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:568
	if c.n != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:569
		req.N = c.n
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:570
	if c.seed != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:571
		req.Seed = c.seed
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:572
	if c.presencePenalty != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:573
		req.PresencePenalty = c.presencePenalty
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:574
	if c.frequencyPenalty != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:575
		req.FrequencyPenalty = c.frequencyPenalty
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:576
	if c.user != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:577
		req.User = c.user
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:578
	if len(c.stop) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:579
		req.Stop = c.stop
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:580
	if len(c.tools) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:581
		req.Tools = c.tools
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:582
	if c.toolChoice != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:583
		req.ToolChoice = c.toolChoice
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:584
	if c.responseFormat != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:585
		req.ResponseFormat = c.responseFormat
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:586
	if c.streamHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:587
		req.Stream = true
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:589
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:592
func execute(c Client) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:593
	if c.streamHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:594
		return executeStream(c)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:596
	comp, err := executeRaw(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:597
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:598
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:599
	return GetContent(comp), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:602
func executeRaw(c Client) (Completion, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:603
	baseURL := resolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:604
	apiKey := resolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:605
	chatPath := resolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:606
	url := fmt.Sprintf("%v%v", baseURL, chatPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:607
	body := buildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:612
	req := fetch.Body(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:614
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:615
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:617
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:618
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:619
		return Completion{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:621
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:623
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:624
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:625
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:626
			return Completion{}, errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:627
		return Completion{}, errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:629
	comp := Completion{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:630
	jsonErr := json.UnmarshalRead(resp.Body, &comp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:631
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:632
		return Completion{}, jsonErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:634
	return comp, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:637
func executeStream(c Client) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:638
	baseURL := resolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:639
	apiKey := resolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:640
	chatPath := resolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:641
	url := fmt.Sprintf("%v%v", baseURL, chatPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:642
	body := buildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:648
	req := fetch.Body(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:650
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:651
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:653
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:654
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:655
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:657
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:659
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:660
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:661
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:662
			return "", errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:663
		return "", errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:666
	fullContent := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:667
	scanner := bufio.NewScanner(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:668
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:669
		line := scanner.Text()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:672
		if (line == "") || kukistring.HasPrefix(line, ":") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:673
			continue
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:676
		if line == "data: [DONE]" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:677
			break
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:680
		if kukistring.HasPrefix(line, "data: ") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:681
			data := kukistring.TrimPrefix(line, "data: ")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:682
			chunk := Chunk{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:683
			parseErr := json.Unmarshal([]byte(data), &chunk)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:684
			if parseErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:685
				continue
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:687
			if len(chunk.Choices) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:688
				content := chunk.Choices[0].Delta.Content
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:689
				if content != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:690
					fullContent = (fullContent + content)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:691
					c.streamHandler(content)
				}
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:693
	scanErr := scanner.Err()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:694
	if scanErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:695
		return fullContent, scanErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:697
	return fullContent, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:705
type InputTextContent struct {
	Type string `json:"type"`
	Text string `json:"text"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:710
type OutputTextContent struct {
	Type        string `json:"type"`
	Text        string `json:"text"`
	Annotations []any  `json:"annotations,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:716
type RefusalContent struct {
	Type    string `json:"type"`
	Refusal string `json:"refusal"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:722
type InputItem struct {
	Type      string `json:"type"`
	ID        string `json:"id,omitzero"`
	Role      string `json:"role,omitzero"`
	Content   any    `json:"content,omitzero"`
	Status    string `json:"status,omitzero"`
	CallID    string `json:"call_id,omitzero"`
	Name      string `json:"name,omitzero"`
	Arguments string `json:"arguments,omitzero"`
	Output    string `json:"output,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:735
type OutputItem struct {
	Type      string `json:"type"`
	ID        string `json:"id,omitzero"`
	Role      string `json:"role,omitzero"`
	Content   []any  `json:"content,omitzero"`
	Status    string `json:"status,omitzero"`
	CallID    string `json:"call_id,omitzero"`
	Name      string `json:"name,omitzero"`
	Arguments string `json:"arguments,omitzero"`
	Summary   []any  `json:"summary,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:747
type ResponseUsage struct {
	InputTokens  int `json:"input_tokens"`
	OutputTokens int `json:"output_tokens"`
	TotalTokens  int `json:"total_tokens"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:753
type ResponseError struct {
	Code    string `json:"code"`
	Message string `json:"message"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:758
type Response struct {
	ID                 string            `json:"id"`
	Object             string            `json:"object"`
	CreatedAt          int               `json:"created_at"`
	CompletedAt        int               `json:"completed_at,omitzero"`
	Status             string            `json:"status"`
	Model              string            `json:"model"`
	Output             []OutputItem      `json:"output"`
	Error              ResponseError     `json:"error,omitzero"`
	PreviousResponseID string            `json:"previous_response_id,omitzero"`
	Instructions       string            `json:"instructions,omitzero"`
	Temperature        float64           `json:"temperature,omitzero"`
	TopP               float64           `json:"top_p,omitzero"`
	MaxOutputTokens    int               `json:"max_output_tokens,omitzero"`
	Usage              ResponseUsage     `json:"usage,omitzero"`
	Tools              []any             `json:"tools,omitzero"`
	ToolChoice         any               `json:"tool_choice,omitzero"`
	Truncation         string            `json:"truncation,omitzero"`
	Store              bool              `json:"store,omitzero"`
	Metadata           map[string]string `json:"metadata,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:780
type ResponseRequest struct {
	Model              string            `json:"model"`
	Input              any               `json:"input"`
	Instructions       string            `json:"instructions,omitzero"`
	PreviousResponseID string            `json:"previous_response_id,omitzero"`
	Temperature        float64           `json:"temperature,omitzero"`
	TopP               float64           `json:"top_p,omitzero"`
	MaxOutputTokens    int               `json:"max_output_tokens,omitzero"`
	PresencePenalty    float64           `json:"presence_penalty,omitzero"`
	FrequencyPenalty   float64           `json:"frequency_penalty,omitzero"`
	Tools              []Tool            `json:"tools,omitzero"`
	ToolChoice         any               `json:"tool_choice,omitzero"`
	Stream             bool              `json:"stream,omitzero"`
	Store              bool              `json:"store,omitzero"`
	Truncation         string            `json:"truncation,omitzero"`
	Metadata           map[string]string `json:"metadata,omitzero"`
	Text               any               `json:"text,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:799
type StreamEvent struct {
	Type           string     `json:"type"`
	SequenceNumber int        `json:"sequence_number"`
	Response       Response   `json:"response,omitzero"`
	OutputIndex    int        `json:"output_index,omitzero"`
	ContentIndex   int        `json:"content_index,omitzero"`
	ItemID         string     `json:"item_id,omitzero"`
	Item           OutputItem `json:"item,omitzero"`
	Delta          string     `json:"delta,omitzero"`
	Text           string     `json:"text,omitzero"`
	Part           any        `json:"part,omitzero"`
	Name           string     `json:"name,omitzero"`
	Arguments      string     `json:"arguments,omitzero"`
	Code           string     `json:"code,omitzero"`
	Message        string     `json:"message,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:816
type ResponseClient struct {
	model              string
	provider           string
	baseURL            string
	path               string
	apiKey             string
	input              []InputItem
	instructions       string
	previousResponseID string
	temperature        float64
	topP               float64
	maxOutputTokens    int
	presencePenalty    float64
	frequencyPenalty   float64
	tools              []Tool
	toolChoice         any
	store              bool
	truncation         string
	metadata           map[string]string
	textFormat         any
	streamHandler      func(string)
	eventHandler       func(StreamEvent)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:842
func NewResponse(model string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:843
	c := ResponseClient{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:844
	c.input = []InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:845
	c.tools = []Tool{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:846
	c.temperature = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:847
	c.topP = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:848
	c.maxOutputTokens = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:849
	c.presencePenalty = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:850
	c.frequencyPenalty = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:851
	c.store = false
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:852
	c.truncation = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:853
	c.instructions = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:854
	c.previousResponseID = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:857
	if kukistring.Contains(model, ":") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:858
		parts := kukistring.SplitN(model, ":", 2)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:859
		c.provider = parts[0]
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:860
		c.model = parts[1]
	} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:862
		c.model = model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:863
		c.provider = ""
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:865
	c.baseURL = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:866
	c.path = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:867
	c.apiKey = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:868
	c.streamHandler = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:869
	c.eventHandler = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:870
	c.toolChoice = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:871
	c.textFormat = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:872
	c.metadata = map[string]string{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:873
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:877
func RProvider(c ResponseClient, provider string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:878
	c.provider = provider
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:879
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:883
func RBaseURL(c ResponseClient, url string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:884
	c.baseURL = url
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:885
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:889
func RPath(c ResponseClient, path string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:890
	c.path = path
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:891
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:895
func RAPIKey(c ResponseClient, key string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:896
	c.apiKey = key
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:897
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:901
func Instructions(c ResponseClient, instructions string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:902
	c.instructions = instructions
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:903
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:907
func PreviousResponse(c ResponseClient, id string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:908
	c.previousResponseID = id
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:909
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:913
func RUserMessage(c ResponseClient, content string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:914
	item := InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:915
	item.Type = "message"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:916
	item.Role = "user"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:917
	item.Content = content
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:918
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:919
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:923
func RSystemMessage(c ResponseClient, content string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:924
	item := InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:925
	item.Type = "message"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:926
	item.Role = "system"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:927
	item.Content = content
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:928
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:929
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:933
func RDeveloperMessage(c ResponseClient, content string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:934
	item := InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:935
	item.Type = "message"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:936
	item.Role = "developer"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:937
	item.Content = content
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:938
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:939
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:943
func RAssistantMessage(c ResponseClient, content string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:944
	item := InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:945
	item.Type = "message"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:946
	item.Role = "assistant"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:947
	item.Content = content
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:948
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:949
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:953
func RAddInput(c ResponseClient, item InputItem) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:954
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:955
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:959
func FunctionCallOutput(c ResponseClient, callID string, output string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:960
	item := InputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:961
	item.Type = "function_call_output"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:962
	item.CallID = callID
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:963
	item.Output = output
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:964
	c.input = append(c.input, item)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:965
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:969
func RTemperature(c ResponseClient, temp float64) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:970
	c.temperature = temp
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:971
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:975
func RTopP(c ResponseClient, p float64) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:976
	c.topP = p
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:977
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:981
func RMaxOutputTokens(c ResponseClient, max int) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:982
	c.maxOutputTokens = max
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:983
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:987
func RPresencePenalty(c ResponseClient, penalty float64) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:988
	c.presencePenalty = penalty
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:989
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:993
func RFrequencyPenalty(c ResponseClient, penalty float64) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:994
	c.frequencyPenalty = penalty
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:995
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:999
func RAddTool(c ResponseClient, name string, description string, parameters any) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1000
	fn := ToolFunction{Name: name, Description: description, Parameters: parameters}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1001
	tool := Tool{Type: "function", Function: fn}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1002
	c.tools = append(c.tools, tool)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1003
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1007
func RToolChoiceAuto(c ResponseClient) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1008
	c.toolChoice = "auto"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1009
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1013
func RToolChoiceRequired(c ResponseClient) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1014
	c.toolChoice = "required"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1015
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1019
func RToolChoiceNone(c ResponseClient) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1020
	c.toolChoice = "none"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1021
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1025
func RJSONMode(c ResponseClient) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1026
	c.textFormat = map[string]string{"type": "json_object"}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1027
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1031
func RJSONSchema(c ResponseClient, name string, schema any) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1032
	c.textFormat = map[string]any{"type": "json_schema", "name": name, "schema": schema, "strict": true}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1033
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1037
func RStore(c ResponseClient) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1038
	c.store = true
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1039
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1043
func RTruncation(c ResponseClient, mode string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1044
	c.truncation = mode
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1045
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1049
func RMetadata(c ResponseClient, meta map[string]string) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1050
	c.metadata = meta
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1051
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1056
func RStream(c ResponseClient, handler func(string)) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1057
	c.streamHandler = handler
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1058
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1063
func RStreamEvents(c ResponseClient, handler func(StreamEvent)) ResponseClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1064
	c.eventHandler = handler
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1065
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1071
func RAsk(c ResponseClient, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1072
	c = RUserMessage(c, prompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1073
	return rExecute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1083
func RSend(c ResponseClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1084
	return rExecute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1092
func RAskRaw(c ResponseClient, prompt string) (Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1093
	c = RUserMessage(c, prompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1094
	return rExecuteRaw(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1102
func RSendRaw(c ResponseClient) (Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1103
	return rExecuteRaw(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1109
func Respond(model string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1110
	c := NewResponse(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1111
	return RAsk(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1116
func RespondWithInstructions(model string, instructions string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1117
	c := NewResponse(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1118
	c = Instructions(c, instructions)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1119
	return RAsk(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1124
func GetResponseText(resp Response) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1125
	for _, item := range resp.Output {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1126
		if item.Type == "message" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1127
			for _, content := range item.Content {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1128
				switch contentMap := content.(type) {
				case map[string]any:
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1130
					switch contentTypeStr := contentMap["type"].(type) {
					case string:
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1132
						if contentTypeStr == "output_text" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1133
							switch textStr := contentMap["text"].(type) {
							case string:
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1135
								return textStr
							}
						}
					}
				}
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1136
	return ""
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1141
func GetFunctionCalls(resp Response) []OutputItem {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1142
	calls := []OutputItem{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1143
	for _, item := range resp.Output {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1144
		if item.Type == "function_call" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1145
			calls = append(calls, item)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1146
	return calls
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1150
func HasFunctionCalls(resp Response) bool {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1151
	calls := GetFunctionCalls(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1152
	return (len(calls) > 0)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1155
func rResolveAPIKey(c ResponseClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1156
	if c.apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1157
		return c.apiKey
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1159
	if c.provider == "openai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1160
		return env.GetOr("OPENAI_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1161
	if c.provider == "anthropic" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1162
		return env.GetOr("ANTHROPIC_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1163
	if c.provider == "mistral" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1164
		return env.GetOr("MISTRAL_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1165
	if c.provider == "groq" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1166
		return env.GetOr("GROQ_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1167
	if c.provider == "together" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1168
		return env.GetOr("TOGETHER_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1169
	if c.provider == "deepseek" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1170
		return env.GetOr("DEEPSEEK_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1171
	if c.provider == "xai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1172
		return env.GetOr("XAI_API_KEY", "")
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1174
	return env.GetOr("LLM_API_KEY", "")
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1177
func rResolveBaseURL(c ResponseClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1178
	if c.baseURL != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1179
		return c.baseURL
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1181
	if c.provider == "openai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1182
		return "https://api.openai.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1183
	if c.provider == "anthropic" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1184
		return "https://api.anthropic.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1185
	if c.provider == "mistral" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1186
		return "https://api.mistral.ai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1187
	if c.provider == "groq" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1188
		return "https://api.groq.com/openai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1189
	if c.provider == "together" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1190
		return "https://api.together.xyz"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1191
	if c.provider == "deepseek" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1192
		return "https://api.deepseek.com"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1193
	if c.provider == "xai" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1194
		return "https://api.x.ai"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1195
	if c.provider == "ollama" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1196
		return "http://localhost:11434"
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1198
	return "http://localhost:8000"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1201
func rResolvePath(c ResponseClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1202
	if c.path != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1203
		return c.path
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1204
	return "/v1/responses"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1207
func rBuildRequest(c ResponseClient) ResponseRequest {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1208
	req := ResponseRequest{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1209
	req.Model = c.model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1212
	if ((len(c.input) == 1) && (c.input[0].Type == "message")) && (c.input[0].Role == "user") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1214
		req.Input = c.input
	} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1216
		req.Input = c.input
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1218
	if c.instructions != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1219
		req.Instructions = c.instructions
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1220
	if c.previousResponseID != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1221
		req.PreviousResponseID = c.previousResponseID
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1222
	if c.temperature != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1223
		req.Temperature = c.temperature
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1224
	if c.topP != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1225
		req.TopP = c.topP
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1226
	if c.maxOutputTokens != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1227
		req.MaxOutputTokens = c.maxOutputTokens
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1228
	if c.presencePenalty != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1229
		req.PresencePenalty = c.presencePenalty
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1230
	if c.frequencyPenalty != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1231
		req.FrequencyPenalty = c.frequencyPenalty
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1232
	if len(c.tools) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1233
		req.Tools = c.tools
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1234
	if c.toolChoice != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1235
		req.ToolChoice = c.toolChoice
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1236
	if c.store {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1237
		req.Store = true
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1238
	if c.truncation != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1239
		req.Truncation = c.truncation
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1240
	if len(c.metadata) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1241
		req.Metadata = c.metadata
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1242
	if c.textFormat != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1243
		req.Text = c.textFormat
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1244
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1245
		req.Stream = true
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1247
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1250
func rExecute(c ResponseClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1251
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1252
		return rExecuteStream(c)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1254
	resp, err := rExecuteRaw(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1255
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1256
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1257
	return GetResponseText(resp), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1260
func rExecuteRaw(c ResponseClient) (Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1261
	baseURL := rResolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1262
	apiKey := rResolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1263
	responsePath := rResolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1264
	url := fmt.Sprintf("%v%v", baseURL, responsePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1265
	body := rBuildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1270
	req := fetch.Body(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1272
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1273
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1275
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1276
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1277
		return Response{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1279
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1281
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1282
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1283
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1284
			return Response{}, errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1285
		return Response{}, errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1287
	result := Response{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1288
	jsonErr := json.UnmarshalRead(resp.Body, &result)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1289
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1290
		return Response{}, jsonErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1292
	return result, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1295
func rExecuteStream(c ResponseClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1296
	baseURL := rResolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1297
	apiKey := rResolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1298
	responsePath := rResolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1299
	url := fmt.Sprintf("%v%v", baseURL, responsePath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1300
	body := rBuildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1306
	req := fetch.Body(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1308
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1309
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1311
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1312
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1313
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1315
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1317
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1318
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1319
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1320
			return "", errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1321
		return "", errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1329
	fullContent := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1330
	scanner := bufio.NewScanner(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1331
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1332
		line := scanner.Text()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1335
		if (line == "") || kukistring.HasPrefix(line, ":") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1336
			continue
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1339
		if line == "data: [DONE]" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1340
			break
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1343
		if kukistring.HasPrefix(line, "data: ") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1344
			data := kukistring.TrimPrefix(line, "data: ")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1345
			evt := StreamEvent{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1346
			parseErr := json.Unmarshal([]byte(data), &evt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1347
			if parseErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1348
				continue
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1351
			if c.eventHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1352
				c.eventHandler(evt)
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1355
			if evt.Type == "response.output_text.delta" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1356
				if evt.Delta != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1357
					fullContent = (fullContent + evt.Delta)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1358
					if c.streamHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1359
						c.streamHandler(evt.Delta)
					}
				}
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1362
			if evt.Type == "error" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1363
				errMsg := evt.Message
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1364
				if errMsg == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1365
					errMsg = fmt.Sprintf("streaming error: %v", evt.Code)
				}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1366
				return fullContent, errors.New(errMsg)
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1368
	scanErr := scanner.Err()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1369
	if scanErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1370
		return fullContent, scanErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1372
	return fullContent, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1381
type ContentBlock struct {
	Type      string `json:"type"`
	Text      string `json:"text,omitzero"`
	Thinking  string `json:"thinking,omitzero"`
	ID        string `json:"id,omitzero"`
	Name      string `json:"name,omitzero"`
	Input     any    `json:"input,omitzero"`
	ToolUseID string `json:"tool_use_id,omitzero"`
	Content   any    `json:"content,omitzero"`
	Source    any    `json:"source,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1395
type ThinkingConfig struct {
	Type         string `json:"type"`
	BudgetTokens int    `json:"budget_tokens,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1401
type OutputConfig struct {
	Format any `json:"format,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1406
type AnthropicMessage struct {
	Role    string `json:"role"`
	Content any    `json:"content"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1411
type AnthropicTool struct {
	Name        string `json:"name"`
	Description string `json:"description,omitzero"`
	InputSchema any    `json:"input_schema"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1417
type AnthropicToolChoice struct {
	Type string `json:"type"`
	Name string `json:"name,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1422
type AnthropicUsage struct {
	InputTokens              int `json:"input_tokens"`
	OutputTokens             int `json:"output_tokens"`
	CacheCreationInputTokens int `json:"cache_creation_input_tokens,omitzero"`
	CacheReadInputTokens     int `json:"cache_read_input_tokens,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1429
type AnthropicResponse struct {
	ID           string         `json:"id"`
	Type         string         `json:"type"`
	Role         string         `json:"role"`
	Content      []ContentBlock `json:"content"`
	Model        string         `json:"model"`
	StopReason   string         `json:"stop_reason"`
	StopSequence string         `json:"stop_sequence,omitzero"`
	Usage        AnthropicUsage `json:"usage"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1440
type MessagesRequest struct {
	Model         string             `json:"model"`
	Messages      []AnthropicMessage `json:"messages"`
	MaxTokens     int                `json:"max_tokens"`
	System        string             `json:"system,omitzero"`
	Temperature   float64            `json:"temperature,omitzero"`
	TopP          float64            `json:"top_p,omitzero"`
	TopK          int                `json:"top_k,omitzero"`
	StopSequences []string           `json:"stop_sequences,omitzero"`
	Stream        bool               `json:"stream,omitzero"`
	Tools         []AnthropicTool    `json:"tools,omitzero"`
	ToolChoice    any                `json:"tool_choice,omitzero"`
	Metadata      any                `json:"metadata,omitzero"`
	Thinking      any                `json:"thinking,omitzero"`
	Effort        string             `json:"effort,omitzero"`
	OutputConfig  any                `json:"output_config,omitzero"`
	InferenceGeo  string             `json:"inference_geo,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1460
type AnthropicStreamEvent struct {
	Type         string            `json:"type"`
	Index        int               `json:"index,omitzero"`
	Message      AnthropicResponse `json:"message,omitzero"`
	ContentBlock ContentBlock      `json:"content_block,omitzero"`
	Delta        AnthropicDelta    `json:"delta,omitzero"`
	Usage        AnthropicUsage    `json:"usage,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1470
type AnthropicDelta struct {
	Type         string `json:"type,omitzero"`
	Text         string `json:"text,omitzero"`
	Thinking     string `json:"thinking,omitzero"`
	PartialJSON  string `json:"partial_json,omitzero"`
	StopReason   string `json:"stop_reason,omitzero"`
	StopSequence string `json:"stop_sequence,omitzero"`
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1479
type MessagesClient struct {
	model         string
	baseURL       string
	path          string
	apiKey        string
	apiVersion    string
	system        string
	messages      []AnthropicMessage
	maxTokens     int
	temperature   float64
	topP          float64
	topK          int
	stopSequences []string
	tools         []AnthropicTool
	toolChoice    any
	metadata      any
	thinking      any
	effort        string
	outputConfig  any
	inferenceGeo  string
	streamHandler func(string)
	eventHandler  func(AnthropicStreamEvent)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1504
func NewMessages(model string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1505
	c := MessagesClient{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1506
	c.model = model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1507
	c.baseURL = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1508
	c.path = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1509
	c.apiKey = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1510
	c.apiVersion = "2023-06-01"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1511
	c.system = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1512
	c.messages = []AnthropicMessage{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1513
	c.maxTokens = 1024
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1514
	c.temperature = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1515
	c.topP = 0.000000
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1516
	c.topK = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1517
	c.stopSequences = []string{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1518
	c.tools = []AnthropicTool{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1519
	c.toolChoice = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1520
	c.metadata = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1521
	c.thinking = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1522
	c.effort = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1523
	c.outputConfig = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1524
	c.inferenceGeo = ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1525
	c.streamHandler = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1526
	c.eventHandler = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1527
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1531
func MBaseURL(c MessagesClient, url string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1532
	c.baseURL = url
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1533
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1537
func MPath(c MessagesClient, path string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1538
	c.path = path
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1539
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1544
func MAPIKey(c MessagesClient, key string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1545
	c.apiKey = key
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1546
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1551
func MAPIVersion(c MessagesClient, version string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1552
	c.apiVersion = version
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1553
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1557
func MSystem(c MessagesClient, system string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1558
	c.system = system
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1559
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1563
func MUser(c MessagesClient, content string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1564
	msg := AnthropicMessage{Role: "user", Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1565
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1566
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1571
func MAssistant(c MessagesClient, content string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1572
	msg := AnthropicMessage{Role: "assistant", Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1573
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1574
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1578
func MAddMessage(c MessagesClient, role string, content any) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1579
	msg := AnthropicMessage{Role: role, Content: content}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1580
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1581
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1586
func MToolResult(c MessagesClient, toolUseID string, result string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1587
	block := ContentBlock{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1588
	block.Type = "tool_result"
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1589
	block.ToolUseID = toolUseID
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1590
	block.Content = result
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1591
	blocks := []ContentBlock{block}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1592
	msg := AnthropicMessage{Role: "user", Content: blocks}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1593
	c.messages = append(c.messages, msg)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1594
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1599
func MMaxTokens(c MessagesClient, max int) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1600
	c.maxTokens = max
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1601
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1605
func MTemperature(c MessagesClient, temp float64) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1606
	c.temperature = temp
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1607
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1611
func MTopP(c MessagesClient, p float64) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1612
	c.topP = p
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1613
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1617
func MTopK(c MessagesClient, k int) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1618
	c.topK = k
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1619
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1623
func MStopSequences(c MessagesClient, sequences []string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1624
	c.stopSequences = sequences
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1625
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1630
func MAdaptiveThinking(c MessagesClient) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1631
	c.thinking = ThinkingConfig{Type: "adaptive"}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1632
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1636
func MThinking(c MessagesClient, budgetTokens int) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1637
	c.thinking = ThinkingConfig{Type: "enabled", BudgetTokens: budgetTokens}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1638
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1645
func MEffort(c MessagesClient, effort string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1646
	c.effort = effort
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1647
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1653
func MOutputFormat(c MessagesClient, format any) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1654
	c.outputConfig = OutputConfig{Format: format}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1655
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1661
func MInferenceGeo(c MessagesClient, geo string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1662
	c.inferenceGeo = geo
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1663
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1667
func MAddTool(c MessagesClient, name string, description string, inputSchema any) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1668
	tool := AnthropicTool{Name: name, Description: description, InputSchema: inputSchema}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1669
	c.tools = append(c.tools, tool)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1670
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1674
func MToolChoiceAuto(c MessagesClient) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1675
	c.toolChoice = AnthropicToolChoice{Type: "auto"}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1676
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1680
func MToolChoiceAny(c MessagesClient) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1681
	c.toolChoice = AnthropicToolChoice{Type: "any"}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1682
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1686
func MToolChoiceTool(c MessagesClient, name string) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1687
	c.toolChoice = AnthropicToolChoice{Type: "tool", Name: name}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1688
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1693
func MStream(c MessagesClient, handler func(string)) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1694
	c.streamHandler = handler
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1695
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1700
func MStreamEvents(c MessagesClient, handler func(AnthropicStreamEvent)) MessagesClient {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1701
	c.eventHandler = handler
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1702
	return c
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1708
func MAsk(c MessagesClient, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1709
	c = MUser(c, prompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1710
	return mExecute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1720
func MSend(c MessagesClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1721
	return mExecute(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1729
func MAskRaw(c MessagesClient, prompt string) (AnthropicResponse, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1730
	c = MUser(c, prompt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1731
	return mExecuteRaw(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1739
func MSendRaw(c MessagesClient) (AnthropicResponse, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1740
	return mExecuteRaw(c)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1744
func AnthropicComplete(model string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1745
	c := NewMessages(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1746
	return MAsk(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1750
func AnthropicCompleteWithSystem(model string, system string, prompt string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1751
	c := NewMessages(model)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1752
	c = MSystem(c, system)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1753
	return MAsk(c, prompt)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1758
func GetAnthropicText(resp AnthropicResponse) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1759
	result := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1760
	for _, block := range resp.Content {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1761
		if block.Type == "text" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1762
			result = (result + block.Text)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1763
	return result
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1769
func GetThinking(resp AnthropicResponse) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1770
	result := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1771
	for _, block := range resp.Content {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1772
		if block.Type == "thinking" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1773
			result = (result + block.Thinking)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1774
	return result
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1779
func GetToolUses(resp AnthropicResponse) []ContentBlock {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1780
	uses := []ContentBlock{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1781
	for _, block := range resp.Content {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1782
		if block.Type == "tool_use" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1783
			uses = append(uses, block)
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1784
	return uses
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1788
func HasToolUses(resp AnthropicResponse) bool {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1789
	return (resp.StopReason == "tool_use")
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1792
func mResolveAPIKey(c MessagesClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1793
	if c.apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1794
		return c.apiKey
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1795
	return env.GetOr("ANTHROPIC_API_KEY", "")
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1798
func mResolveBaseURL(c MessagesClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1799
	if c.baseURL != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1800
		return c.baseURL
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1801
	return "https://api.anthropic.com"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1804
func mResolvePath(c MessagesClient) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1805
	if c.path != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1806
		return c.path
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1807
	return "/v1/messages"
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1810
func mBuildRequest(c MessagesClient) MessagesRequest {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1811
	req := MessagesRequest{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1812
	req.Model = c.model
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1813
	req.Messages = c.messages
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1814
	req.MaxTokens = c.maxTokens
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1816
	if c.system != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1817
		req.System = c.system
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1818
	if c.temperature != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1819
		req.Temperature = c.temperature
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1820
	if c.topP != 0.000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1821
		req.TopP = c.topP
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1822
	if c.topK != 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1823
		req.TopK = c.topK
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1824
	if len(c.stopSequences) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1825
		req.StopSequences = c.stopSequences
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1826
	if len(c.tools) > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1827
		req.Tools = c.tools
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1828
	if c.toolChoice != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1829
		req.ToolChoice = c.toolChoice
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1830
	if c.metadata != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1831
		req.Metadata = c.metadata
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1832
	if c.thinking != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1833
		req.Thinking = c.thinking
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1834
	if c.effort != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1835
		req.Effort = c.effort
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1836
	if c.outputConfig != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1837
		req.OutputConfig = c.outputConfig
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1838
	if c.inferenceGeo != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1839
		req.InferenceGeo = c.inferenceGeo
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1840
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1841
		req.Stream = true
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1843
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1846
func mExecute(c MessagesClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1847
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1848
		return mExecuteStream(c)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1850
	resp, err := mExecuteRaw(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1851
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1852
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1853
	return GetAnthropicText(resp), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1856
func mExecuteRaw(c MessagesClient) (AnthropicResponse, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1857
	baseURL := mResolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1858
	apiKey := mResolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1859
	msgPath := mResolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1860
	url := fmt.Sprintf("%v%v", baseURL, msgPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1861
	body := mBuildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1867
	req := fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "anthropic-version", c.apiVersion)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1869
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1870
		req = fetch.Header(req, "x-api-key", apiKey)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1872
	req = fetch.Body(req, body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1874
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1875
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1876
		return AnthropicResponse{}, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1878
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1880
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1881
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1882
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1883
			return AnthropicResponse{}, errors.New(fmt.Sprintf("Anthropic API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1884
		return AnthropicResponse{}, errors.New(fmt.Sprintf("Anthropic API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1886
	result := AnthropicResponse{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1887
	jsonErr := json.UnmarshalRead(resp.Body, &result)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1888
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1889
		return AnthropicResponse{}, jsonErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1891
	return result, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1903
func mExecuteStream(c MessagesClient) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1904
	baseURL := mResolveBaseURL(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1905
	apiKey := mResolveAPIKey(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1906
	msgPath := mResolvePath(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1907
	url := fmt.Sprintf("%v%v", baseURL, msgPath)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1908
	body := mBuildRequest(c)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1914
	req := fetch.Header(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), "anthropic-version", c.apiVersion)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1916
	if apiKey != "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1917
		req = fetch.Header(req, "x-api-key", apiKey)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1919
	req = fetch.Body(req, body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1921
	resp, err := fetch.Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1922
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1923
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1925
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1927
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1928
		errBody, readErr := fetch.Bytes(resp)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1929
		if readErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1930
			return "", errors.New(fmt.Sprintf("Anthropic API request failed with status %v", resp.StatusCode))
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1931
		return "", errors.New(fmt.Sprintf("Anthropic API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1935
	fullContent := ""
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1936
	scanner := bufio.NewScanner(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1937
	for scanner.Scan() {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1938
		line := scanner.Text()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1941
		if ((line == "") || kukistring.HasPrefix(line, "event:")) || kukistring.HasPrefix(line, ":") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1942
			continue
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1945
		if kukistring.HasPrefix(line, "data: ") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1946
			data := kukistring.TrimPrefix(line, "data: ")
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1947
			evt := AnthropicStreamEvent{}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1948
			parseErr := json.Unmarshal([]byte(data), &evt)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1949
			if parseErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1950
				continue
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1953
			if c.eventHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1954
				c.eventHandler(evt)
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1957
			if evt.Type == "content_block_delta" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1958
				if (evt.Delta.Type == "text_delta") && (evt.Delta.Text != "") {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1959
					fullContent = (fullContent + evt.Delta.Text)
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1960
					if c.streamHandler != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1961
						c.streamHandler(evt.Delta.Text)
					}
				}
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1964
			if evt.Type == "error" {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1965
				return fullContent, errors.New("Anthropic streaming error")
			}
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1967
	scanErr := scanner.Err()
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1968
	if scanErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1969
		return fullContent, scanErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/llm/llm.kuki:1971
	return fullContent, nil
}
