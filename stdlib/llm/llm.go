// Generated by Kukicha v0.0.10 (requires Go 1.26+)

package llm

import (
	"bufio"
	"errors"
	"fmt"
	"github.com/duber000/kukicha/stdlib/env"
	"github.com/duber000/kukicha/stdlib/fetch"
	"github.com/duber000/kukicha/stdlib/json"
	kukistring "github.com/duber000/kukicha/stdlib/string"
)

//line /home/user/kukicha/stdlib/llm/llm.kuki:127
type Message struct {
	Role    string `json:"role"`
	Content string `json:"content"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:132
type ToolFunction struct {
	Name        string `json:"name"`
	Description string `json:"description"`
	Parameters  any    `json:"parameters"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:138
type Tool struct {
	Type     string       `json:"type"`
	Function ToolFunction `json:"function"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:143
type ToolCall struct {
	ID       string           `json:"id"`
	Type     string           `json:"type"`
	Function ToolCallFunction `json:"function"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:149
type ToolCallFunction struct {
	Name      string `json:"name"`
	Arguments string `json:"arguments"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:154
type Choice struct {
	Index        int             `json:"index"`
	Message      ResponseMessage `json:"message"`
	FinishReason string          `json:"finish_reason"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:160
type ResponseMessage struct {
	Role      string     `json:"role"`
	Content   string     `json:"content"`
	ToolCalls []ToolCall `json:"tool_calls,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:166
type Usage struct {
	PromptTokens     int `json:"prompt_tokens"`
	CompletionTokens int `json:"completion_tokens"`
	TotalTokens      int `json:"total_tokens"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:172
type Completion struct {
	ID      string   `json:"id"`
	Object  string   `json:"object"`
	Created int      `json:"created"`
	Model   string   `json:"model"`
	Choices []Choice `json:"choices"`
	Usage   Usage    `json:"usage"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:181
type ChunkDelta struct {
	Role    string `json:"role,omitempty"`
	Content string `json:"content,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:186
type ChunkChoice struct {
	Index        int        `json:"index"`
	Delta        ChunkDelta `json:"delta"`
	FinishReason string     `json:"finish_reason,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:192
type Chunk struct {
	ID      string        `json:"id"`
	Object  string        `json:"object"`
	Created int           `json:"created"`
	Model   string        `json:"model"`
	Choices []ChunkChoice `json:"choices"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:200
type CompletionRequest struct {
	Model            string    `json:"model"`
	Messages         []Message `json:"messages"`
	Temperature      float64   `json:"temperature,omitempty"`
	MaxTokens        int       `json:"max_tokens,omitempty"`
	TopP             float64   `json:"top_p,omitempty"`
	N                int       `json:"n,omitempty"`
	Stop             []string  `json:"stop,omitempty"`
	PresencePenalty  float64   `json:"presence_penalty,omitempty"`
	FrequencyPenalty float64   `json:"frequency_penalty,omitempty"`
	Seed             int       `json:"seed,omitempty"`
	User             string    `json:"user,omitempty"`
	Stream           bool      `json:"stream,omitempty"`
	Tools            []Tool    `json:"tools,omitempty"`
	ToolChoice       any       `json:"tool_choice,omitempty"`
	ResponseFormat   any       `json:"response_format,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:218
type Client struct {
	model            string
	provider         string
	baseURL          string
	path             string
	apiKey           string
	messages         []Message
	temperature      float64
	maxTokens        int
	topP             float64
	n                int
	stop             []string
	presencePenalty  float64
	frequencyPenalty float64
	seed             int
	user             string
	tools            []Tool
	toolChoice       any
	responseFormat   any
	streamHandler    func(string)
	retryMaxAttempts int
	retryDelayMs     int
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:245
func New(model string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:246
	c := Client{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:247
	c.messages = []Message{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:248
	c.tools = []Tool{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:249
	c.temperature = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:250
	c.maxTokens = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:251
	c.topP = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:252
	c.n = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:253
	c.seed = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:254
	c.presencePenalty = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:255
	c.frequencyPenalty = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:258
	if kukistring.Contains(model, ":") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:259
		parts := kukistring.SplitN(model, ":", 2)
//line /home/user/kukicha/stdlib/llm/llm.kuki:260
		c.provider = parts[0]
//line /home/user/kukicha/stdlib/llm/llm.kuki:261
		c.model = parts[1]
	} else {
//line /home/user/kukicha/stdlib/llm/llm.kuki:263
		c.model = model
//line /home/user/kukicha/stdlib/llm/llm.kuki:264
		c.provider = ""
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:266
	c.baseURL = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:267
	c.path = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:268
	c.apiKey = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:269
	c.user = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:270
	c.streamHandler = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:271
	c.toolChoice = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:272
	c.responseFormat = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:273
	c.retryMaxAttempts = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:274
	c.retryDelayMs = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:275
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:279
func Provider(c Client, provider string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:280
	c.provider = provider
//line /home/user/kukicha/stdlib/llm/llm.kuki:281
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:285
func Gateway(c Client, url string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:286
	c.baseURL = url
//line /home/user/kukicha/stdlib/llm/llm.kuki:287
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:292
func BaseURL(c Client, url string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:293
	c.baseURL = url
//line /home/user/kukicha/stdlib/llm/llm.kuki:294
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:299
func Path(c Client, path string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:300
	c.path = path
//line /home/user/kukicha/stdlib/llm/llm.kuki:301
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:307
func APIKey(c Client, key string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:308
	c.apiKey = key
//line /home/user/kukicha/stdlib/llm/llm.kuki:309
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:313
func System(c Client, content string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:314
	msg := Message{Role: "system", Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:315
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:316
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:320
func User(c Client, content string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:321
	msg := Message{Role: "user", Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:322
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:323
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:327
func Assistant(c Client, content string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:328
	msg := Message{Role: "assistant", Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:329
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:330
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:334
func AddMessage(c Client, role string, content string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:335
	msg := Message{Role: role, Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:336
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:337
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:341
func Messages(c Client, msgs []Message) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:342
	c.messages = msgs
//line /home/user/kukicha/stdlib/llm/llm.kuki:343
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:348
func Temperature(c Client, temp float64) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:349
	c.temperature = temp
//line /home/user/kukicha/stdlib/llm/llm.kuki:350
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:354
func MaxTokens(c Client, max int) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:355
	c.maxTokens = max
//line /home/user/kukicha/stdlib/llm/llm.kuki:356
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:360
func TopP(c Client, p float64) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:361
	c.topP = p
//line /home/user/kukicha/stdlib/llm/llm.kuki:362
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:366
func Stop(c Client, sequences []string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:367
	c.stop = sequences
//line /home/user/kukicha/stdlib/llm/llm.kuki:368
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:373
func PresencePenalty(c Client, penalty float64) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:374
	c.presencePenalty = penalty
//line /home/user/kukicha/stdlib/llm/llm.kuki:375
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:380
func FrequencyPenalty(c Client, penalty float64) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:381
	c.frequencyPenalty = penalty
//line /home/user/kukicha/stdlib/llm/llm.kuki:382
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:386
func Seed(c Client, seed int) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:387
	c.seed = seed
//line /home/user/kukicha/stdlib/llm/llm.kuki:388
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:392
func SetUser(c Client, user string) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:393
	c.user = user
//line /home/user/kukicha/stdlib/llm/llm.kuki:394
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:399
func AddTool(c Client, name string, description string, parameters any) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:400
	fn := ToolFunction{Name: name, Description: description, Parameters: parameters}
//line /home/user/kukicha/stdlib/llm/llm.kuki:401
	tool := Tool{Type: "function", Function: fn}
//line /home/user/kukicha/stdlib/llm/llm.kuki:402
	c.tools = append(c.tools, tool)
//line /home/user/kukicha/stdlib/llm/llm.kuki:403
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:407
func ToolChoiceAuto(c Client) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:408
	c.toolChoice = "auto"
//line /home/user/kukicha/stdlib/llm/llm.kuki:409
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:413
func ToolChoiceRequired(c Client) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:414
	c.toolChoice = "required"
//line /home/user/kukicha/stdlib/llm/llm.kuki:415
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:419
func ToolChoiceNone(c Client) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:420
	c.toolChoice = "none"
//line /home/user/kukicha/stdlib/llm/llm.kuki:421
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:425
func JSONMode(c Client) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:426
	c.responseFormat = map[string]string{"type": "json_object"}
//line /home/user/kukicha/stdlib/llm/llm.kuki:427
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:432
func Stream(c Client, handler func(string)) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:433
	c.streamHandler = handler
//line /home/user/kukicha/stdlib/llm/llm.kuki:434
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:439
func Retry(c Client, maxAttempts int, delayMs int) Client {
//line /home/user/kukicha/stdlib/llm/llm.kuki:440
	c.retryMaxAttempts = maxAttempts
//line /home/user/kukicha/stdlib/llm/llm.kuki:441
	c.retryDelayMs = delayMs
//line /home/user/kukicha/stdlib/llm/llm.kuki:442
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:449
func Ask(c Client, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:450
	c = User(c, prompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:451
	return execute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:462
func Send(c Client) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:463
	return execute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:473
func SendRaw(c Client) (Completion, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:474
	return executeRaw(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:481
func Complete(model string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:482
	c := New(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:483
	return Ask(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:488
func CompleteWithSystem(model string, systemPrompt string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:489
	c := New(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:490
	c = System(c, systemPrompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:491
	return Ask(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:496
func GetContent(comp Completion) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:497
	if len(comp.Choices) == 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:498
		return ""
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:499
	return comp.Choices[0].Message.Content
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:504
func GetToolCalls(comp Completion) []ToolCall {
//line /home/user/kukicha/stdlib/llm/llm.kuki:505
	if len(comp.Choices) == 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:506
		return []ToolCall{}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:507
	return comp.Choices[0].Message.ToolCalls
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:511
func HasToolCalls(comp Completion) bool {
//line /home/user/kukicha/stdlib/llm/llm.kuki:512
	calls := GetToolCalls(comp)
//line /home/user/kukicha/stdlib/llm/llm.kuki:513
	return (len(calls) > 0)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:516
func resolveAPIKey(c Client) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:517
	if c.apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:518
		return c.apiKey
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:521
	if c.provider == "openai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:522
		key := env.GetOr("OPENAI_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:523
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:524
	if c.provider == "anthropic" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:525
		key := env.GetOr("ANTHROPIC_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:526
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:527
	if c.provider == "mistral" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:528
		key := env.GetOr("MISTRAL_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:529
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:530
	if c.provider == "groq" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:531
		key := env.GetOr("GROQ_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:532
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:533
	if c.provider == "together" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:534
		key := env.GetOr("TOGETHER_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:535
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:536
	if c.provider == "deepseek" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:537
		key := env.GetOr("DEEPSEEK_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:538
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:539
	if c.provider == "xai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:540
		key := env.GetOr("XAI_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:541
		return key
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:544
	key := env.GetOr("LLM_API_KEY", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:545
	return key
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:548
func resolveBaseURL(c Client) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:549
	if c.baseURL != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:550
		return c.baseURL
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:553
	if c.provider == "openai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:554
		return "https://api.openai.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:555
	if c.provider == "anthropic" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:556
		return "https://api.anthropic.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:557
	if c.provider == "mistral" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:558
		return "https://api.mistral.ai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:559
	if c.provider == "groq" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:560
		return "https://api.groq.com/openai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:561
	if c.provider == "together" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:562
		return "https://api.together.xyz"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:563
	if c.provider == "deepseek" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:564
		return "https://api.deepseek.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:565
	if c.provider == "xai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:566
		return "https://api.x.ai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:567
	if c.provider == "ollama" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:568
		return "http://localhost:11434"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:571
	envURL := env.GetOr("LLM_BASE_URL", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:572
	if envURL != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:573
		return envURL
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:574
	return "http://localhost:8000"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:577
func resolvePath(c Client) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:578
	if c.path != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:579
		return c.path
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:580
	return "/v1/chat/completions"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:583
func buildRequest(c Client) CompletionRequest {
//line /home/user/kukicha/stdlib/llm/llm.kuki:584
	req := CompletionRequest{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:585
	req.Model = c.model
//line /home/user/kukicha/stdlib/llm/llm.kuki:586
	req.Messages = c.messages
//line /home/user/kukicha/stdlib/llm/llm.kuki:588
	if c.temperature != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:589
		req.Temperature = c.temperature
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:590
	if c.maxTokens != 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:591
		req.MaxTokens = c.maxTokens
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:592
	if c.topP != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:593
		req.TopP = c.topP
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:594
	if c.n != 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:595
		req.N = c.n
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:596
	if c.seed != 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:597
		req.Seed = c.seed
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:598
	if c.presencePenalty != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:599
		req.PresencePenalty = c.presencePenalty
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:600
	if c.frequencyPenalty != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:601
		req.FrequencyPenalty = c.frequencyPenalty
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:602
	if c.user != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:603
		req.User = c.user
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:604
	if len(c.stop) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:605
		req.Stop = c.stop
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:606
	if len(c.tools) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:607
		req.Tools = c.tools
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:608
	if c.toolChoice != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:609
		req.ToolChoice = c.toolChoice
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:610
	if c.responseFormat != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:611
		req.ResponseFormat = c.responseFormat
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:612
	if c.streamHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:613
		req.Stream = true
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:615
	return req
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:618
func execute(c Client) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:619
	if c.streamHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:620
		return executeStream(c)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:622
	comp, err_1 := executeRaw(c)
	if err_1 != nil {
		return "", err_1
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:623
	return GetContent(comp), nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:626
func executeRaw(c Client) (Completion, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:627
	baseURL := resolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:628
	apiKey := resolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:629
	chatPath := resolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:630
	url := fmt.Sprintf("%v%v", baseURL, chatPath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:631
	body := buildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:636
	req := fetch.Body(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:638
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:639
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:641
	if c.retryMaxAttempts > 1 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:642
		req = fetch.Retry(req, c.retryMaxAttempts, c.retryDelayMs)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:644
	resp, err_2 := fetch.Do(req)
	if err_2 != nil {
		return *new(Completion), err_2
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:646
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:648
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:649
		errBody, err_3 := fetch.Bytes(resp)
		if err_3 != nil {
			return Completion{}, errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:650
		return Completion{}, errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:652
	comp := Completion{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:653
	if err_4 := json.UnmarshalRead(resp.Body, &comp); err_4 != nil {
		return *new(Completion), err_4
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:655
	return comp, nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:658
func executeStream(c Client) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:659
	baseURL := resolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:660
	apiKey := resolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:661
	chatPath := resolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:662
	url := fmt.Sprintf("%v%v", baseURL, chatPath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:663
	body := buildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:669
	req := fetch.Body(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:671
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:672
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:674
	resp, err_5 := fetch.Do(req)
	if err_5 != nil {
		return "", err_5
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:676
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:678
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:679
		errBody, err_6 := fetch.Bytes(resp)
		if err_6 != nil {
			return "", errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:680
		return "", errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:683
	fullContent := ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:684
	scanner := bufio.NewScanner(resp.Body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:685
	for scanner.Scan() {
//line /home/user/kukicha/stdlib/llm/llm.kuki:686
		line := scanner.Text()
//line /home/user/kukicha/stdlib/llm/llm.kuki:689
		if (line == "") || kukistring.HasPrefix(line, ":") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:690
			continue
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:693
		if line == "data: [DONE]" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:694
			break
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:697
		if kukistring.HasPrefix(line, "data: ") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:698
			data := kukistring.TrimPrefix(line, "data: ")
//line /home/user/kukicha/stdlib/llm/llm.kuki:699
			chunk := Chunk{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:700
			if err_7 := json.Unmarshal([]byte(data), &chunk); err_7 != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:701
				continue
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:703
			if len(chunk.Choices) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:704
				content := chunk.Choices[0].Delta.Content
//line /home/user/kukicha/stdlib/llm/llm.kuki:705
				if content != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:706
					fullContent = (fullContent + content)
//line /home/user/kukicha/stdlib/llm/llm.kuki:707
					c.streamHandler(content)
				}
			}
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:709
	if err_8 := scanner.Err(); err_8 != nil {
		return fullContent, errors.New(fmt.Sprintf("%v", err_8))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:711
	return fullContent, nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:718
type InputTextContent struct {
	Type string `json:"type"`
	Text string `json:"text"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:723
type OutputTextContent struct {
	Type        string `json:"type"`
	Text        string `json:"text"`
	Annotations []any  `json:"annotations,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:729
type RefusalContent struct {
	Type    string `json:"type"`
	Refusal string `json:"refusal"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:735
type InputItem struct {
	Type      string `json:"type"`
	ID        string `json:"id,omitempty"`
	Role      string `json:"role,omitempty"`
	Content   any    `json:"content,omitempty"`
	Status    string `json:"status,omitempty"`
	CallID    string `json:"call_id,omitempty"`
	Name      string `json:"name,omitempty"`
	Arguments string `json:"arguments,omitempty"`
	Output    string `json:"output,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:748
type OutputItem struct {
	Type      string `json:"type"`
	ID        string `json:"id,omitempty"`
	Role      string `json:"role,omitempty"`
	Content   []any  `json:"content,omitempty"`
	Status    string `json:"status,omitempty"`
	CallID    string `json:"call_id,omitempty"`
	Name      string `json:"name,omitempty"`
	Arguments string `json:"arguments,omitempty"`
	Summary   []any  `json:"summary,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:760
type ResponseUsage struct {
	InputTokens  int `json:"input_tokens"`
	OutputTokens int `json:"output_tokens"`
	TotalTokens  int `json:"total_tokens"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:766
type ResponseError struct {
	Code    string `json:"code"`
	Message string `json:"message"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:771
type Response struct {
	ID                 string            `json:"id"`
	Object             string            `json:"object"`
	CreatedAt          int               `json:"created_at"`
	CompletedAt        int               `json:"completed_at,omitempty"`
	Status             string            `json:"status"`
	Model              string            `json:"model"`
	Output             []OutputItem      `json:"output"`
	Error              ResponseError     `json:"error,omitempty"`
	PreviousResponseID string            `json:"previous_response_id,omitempty"`
	Instructions       string            `json:"instructions,omitempty"`
	Temperature        float64           `json:"temperature,omitempty"`
	TopP               float64           `json:"top_p,omitempty"`
	MaxOutputTokens    int               `json:"max_output_tokens,omitempty"`
	Usage              ResponseUsage     `json:"usage,omitempty"`
	Tools              []any             `json:"tools,omitempty"`
	ToolChoice         any               `json:"tool_choice,omitempty"`
	Truncation         string            `json:"truncation,omitempty"`
	Store              bool              `json:"store,omitempty"`
	Metadata           map[string]string `json:"metadata,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:793
type ResponseRequest struct {
	Model              string            `json:"model"`
	Input              any               `json:"input"`
	Instructions       string            `json:"instructions,omitempty"`
	PreviousResponseID string            `json:"previous_response_id,omitempty"`
	Temperature        float64           `json:"temperature,omitempty"`
	TopP               float64           `json:"top_p,omitempty"`
	MaxOutputTokens    int               `json:"max_output_tokens,omitempty"`
	PresencePenalty    float64           `json:"presence_penalty,omitempty"`
	FrequencyPenalty   float64           `json:"frequency_penalty,omitempty"`
	Tools              []Tool            `json:"tools,omitempty"`
	ToolChoice         any               `json:"tool_choice,omitempty"`
	Stream             bool              `json:"stream,omitempty"`
	Store              bool              `json:"store,omitempty"`
	Truncation         string            `json:"truncation,omitempty"`
	Metadata           map[string]string `json:"metadata,omitempty"`
	Text               any               `json:"text,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:812
type StreamEvent struct {
	Type           string     `json:"type"`
	SequenceNumber int        `json:"sequence_number"`
	Response       Response   `json:"response,omitempty"`
	OutputIndex    int        `json:"output_index,omitempty"`
	ContentIndex   int        `json:"content_index,omitempty"`
	ItemID         string     `json:"item_id,omitempty"`
	Item           OutputItem `json:"item,omitempty"`
	Delta          string     `json:"delta,omitempty"`
	Text           string     `json:"text,omitempty"`
	Part           any        `json:"part,omitempty"`
	Name           string     `json:"name,omitempty"`
	Arguments      string     `json:"arguments,omitempty"`
	Code           string     `json:"code,omitempty"`
	Message        string     `json:"message,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:829
type ResponseClient struct {
	model              string
	provider           string
	baseURL            string
	path               string
	apiKey             string
	input              []InputItem
	instructions       string
	previousResponseID string
	temperature        float64
	topP               float64
	maxOutputTokens    int
	presencePenalty    float64
	frequencyPenalty   float64
	tools              []Tool
	toolChoice         any
	store              bool
	truncation         string
	metadata           map[string]string
	textFormat         any
	streamHandler      func(string)
	eventHandler       func(StreamEvent)
	retryMaxAttempts   int
	retryDelayMs       int
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:857
func NewResponse(model string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:858
	c := ResponseClient{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:859
	c.input = []InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:860
	c.tools = []Tool{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:861
	c.temperature = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:862
	c.topP = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:863
	c.maxOutputTokens = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:864
	c.presencePenalty = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:865
	c.frequencyPenalty = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:866
	c.store = false
//line /home/user/kukicha/stdlib/llm/llm.kuki:867
	c.truncation = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:868
	c.instructions = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:869
	c.previousResponseID = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:872
	if kukistring.Contains(model, ":") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:873
		parts := kukistring.SplitN(model, ":", 2)
//line /home/user/kukicha/stdlib/llm/llm.kuki:874
		c.provider = parts[0]
//line /home/user/kukicha/stdlib/llm/llm.kuki:875
		c.model = parts[1]
	} else {
//line /home/user/kukicha/stdlib/llm/llm.kuki:877
		c.model = model
//line /home/user/kukicha/stdlib/llm/llm.kuki:878
		c.provider = ""
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:880
	c.baseURL = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:881
	c.path = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:882
	c.apiKey = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:883
	c.streamHandler = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:884
	c.eventHandler = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:885
	c.toolChoice = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:886
	c.textFormat = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:887
	c.metadata = map[string]string{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:888
	c.retryMaxAttempts = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:889
	c.retryDelayMs = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:890
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:894
func RProvider(c ResponseClient, provider string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:895
	c.provider = provider
//line /home/user/kukicha/stdlib/llm/llm.kuki:896
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:900
func RBaseURL(c ResponseClient, url string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:901
	c.baseURL = url
//line /home/user/kukicha/stdlib/llm/llm.kuki:902
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:906
func RPath(c ResponseClient, path string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:907
	c.path = path
//line /home/user/kukicha/stdlib/llm/llm.kuki:908
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:912
func RAPIKey(c ResponseClient, key string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:913
	c.apiKey = key
//line /home/user/kukicha/stdlib/llm/llm.kuki:914
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:918
func Instructions(c ResponseClient, instructions string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:919
	c.instructions = instructions
//line /home/user/kukicha/stdlib/llm/llm.kuki:920
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:924
func PreviousResponse(c ResponseClient, id string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:925
	c.previousResponseID = id
//line /home/user/kukicha/stdlib/llm/llm.kuki:926
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:930
func RUserMessage(c ResponseClient, content string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:931
	item := InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:932
	item.Type = "message"
//line /home/user/kukicha/stdlib/llm/llm.kuki:933
	item.Role = "user"
//line /home/user/kukicha/stdlib/llm/llm.kuki:934
	item.Content = content
//line /home/user/kukicha/stdlib/llm/llm.kuki:935
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:936
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:940
func RSystemMessage(c ResponseClient, content string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:941
	item := InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:942
	item.Type = "message"
//line /home/user/kukicha/stdlib/llm/llm.kuki:943
	item.Role = "system"
//line /home/user/kukicha/stdlib/llm/llm.kuki:944
	item.Content = content
//line /home/user/kukicha/stdlib/llm/llm.kuki:945
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:946
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:950
func RDeveloperMessage(c ResponseClient, content string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:951
	item := InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:952
	item.Type = "message"
//line /home/user/kukicha/stdlib/llm/llm.kuki:953
	item.Role = "developer"
//line /home/user/kukicha/stdlib/llm/llm.kuki:954
	item.Content = content
//line /home/user/kukicha/stdlib/llm/llm.kuki:955
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:956
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:960
func RAssistantMessage(c ResponseClient, content string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:961
	item := InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:962
	item.Type = "message"
//line /home/user/kukicha/stdlib/llm/llm.kuki:963
	item.Role = "assistant"
//line /home/user/kukicha/stdlib/llm/llm.kuki:964
	item.Content = content
//line /home/user/kukicha/stdlib/llm/llm.kuki:965
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:966
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:970
func RAddInput(c ResponseClient, item InputItem) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:971
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:972
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:976
func FunctionCallOutput(c ResponseClient, callID string, output string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:977
	item := InputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:978
	item.Type = "function_call_output"
//line /home/user/kukicha/stdlib/llm/llm.kuki:979
	item.CallID = callID
//line /home/user/kukicha/stdlib/llm/llm.kuki:980
	item.Output = output
//line /home/user/kukicha/stdlib/llm/llm.kuki:981
	c.input = append(c.input, item)
//line /home/user/kukicha/stdlib/llm/llm.kuki:982
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:986
func RTemperature(c ResponseClient, temp float64) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:987
	c.temperature = temp
//line /home/user/kukicha/stdlib/llm/llm.kuki:988
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:992
func RTopP(c ResponseClient, p float64) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:993
	c.topP = p
//line /home/user/kukicha/stdlib/llm/llm.kuki:994
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:998
func RMaxOutputTokens(c ResponseClient, max int) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:999
	c.maxOutputTokens = max
//line /home/user/kukicha/stdlib/llm/llm.kuki:1000
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1004
func RPresencePenalty(c ResponseClient, penalty float64) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1005
	c.presencePenalty = penalty
//line /home/user/kukicha/stdlib/llm/llm.kuki:1006
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1010
func RFrequencyPenalty(c ResponseClient, penalty float64) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1011
	c.frequencyPenalty = penalty
//line /home/user/kukicha/stdlib/llm/llm.kuki:1012
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1016
func RAddTool(c ResponseClient, name string, description string, parameters any) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1017
	fn := ToolFunction{Name: name, Description: description, Parameters: parameters}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1018
	tool := Tool{Type: "function", Function: fn}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1019
	c.tools = append(c.tools, tool)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1020
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1024
func RToolChoiceAuto(c ResponseClient) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1025
	c.toolChoice = "auto"
//line /home/user/kukicha/stdlib/llm/llm.kuki:1026
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1030
func RToolChoiceRequired(c ResponseClient) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1031
	c.toolChoice = "required"
//line /home/user/kukicha/stdlib/llm/llm.kuki:1032
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1036
func RToolChoiceNone(c ResponseClient) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1037
	c.toolChoice = "none"
//line /home/user/kukicha/stdlib/llm/llm.kuki:1038
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1042
func RJSONMode(c ResponseClient) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1043
	c.textFormat = map[string]string{"type": "json_object"}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1044
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1048
func RJSONSchema(c ResponseClient, name string, schema any) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1049
	c.textFormat = map[string]any{"type": "json_schema", "name": name, "schema": schema, "strict": true}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1050
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1054
func RStore(c ResponseClient) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1055
	c.store = true
//line /home/user/kukicha/stdlib/llm/llm.kuki:1056
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1060
func RTruncation(c ResponseClient, mode string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1061
	c.truncation = mode
//line /home/user/kukicha/stdlib/llm/llm.kuki:1062
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1066
func RMetadata(c ResponseClient, meta map[string]string) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1067
	c.metadata = meta
//line /home/user/kukicha/stdlib/llm/llm.kuki:1068
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1073
func RStream(c ResponseClient, handler func(string)) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1074
	c.streamHandler = handler
//line /home/user/kukicha/stdlib/llm/llm.kuki:1075
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1080
func RStreamEvents(c ResponseClient, handler func(StreamEvent)) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1081
	c.eventHandler = handler
//line /home/user/kukicha/stdlib/llm/llm.kuki:1082
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1086
func RRetry(c ResponseClient, maxAttempts int, delayMs int) ResponseClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1087
	c.retryMaxAttempts = maxAttempts
//line /home/user/kukicha/stdlib/llm/llm.kuki:1088
	c.retryDelayMs = delayMs
//line /home/user/kukicha/stdlib/llm/llm.kuki:1089
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1095
func RAsk(c ResponseClient, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1096
	c = RUserMessage(c, prompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1097
	return rExecute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1107
func RSend(c ResponseClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1108
	return rExecute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1116
func RAskRaw(c ResponseClient, prompt string) (Response, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1117
	c = RUserMessage(c, prompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1118
	return rExecuteRaw(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1126
func RSendRaw(c ResponseClient) (Response, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1127
	return rExecuteRaw(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1133
func Respond(model string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1134
	c := NewResponse(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1135
	return RAsk(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1140
func RespondWithInstructions(model string, instructions string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1141
	c := NewResponse(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1142
	c = Instructions(c, instructions)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1143
	return RAsk(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1148
func GetResponseText(resp Response) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1149
	for _, item := range resp.Output {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1150
		if item.Type == "message" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1151
			for _, content := range item.Content {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1152
				switch contentMap := content.(type) {
				case map[string]any:
//line /home/user/kukicha/stdlib/llm/llm.kuki:1154
					switch contentTypeStr := contentMap["type"].(type) {
					case string:
//line /home/user/kukicha/stdlib/llm/llm.kuki:1156
						if contentTypeStr == "output_text" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1157
							switch textStr := contentMap["text"].(type) {
							case string:
//line /home/user/kukicha/stdlib/llm/llm.kuki:1159
								return textStr
							}
						}
					}
				}
			}
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1160
	return ""
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1165
func GetFunctionCalls(resp Response) []OutputItem {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1166
	calls := []OutputItem{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1167
	for _, item := range resp.Output {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1168
		if item.Type == "function_call" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1169
			calls = append(calls, item)
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1170
	return calls
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1174
func HasFunctionCalls(resp Response) bool {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1175
	calls := GetFunctionCalls(resp)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1176
	return (len(calls) > 0)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1179
func rResolveAPIKey(c ResponseClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1180
	if c.apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1181
		return c.apiKey
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1183
	if c.provider == "openai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1184
		return env.GetOr("OPENAI_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1185
	if c.provider == "anthropic" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1186
		return env.GetOr("ANTHROPIC_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1187
	if c.provider == "mistral" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1188
		return env.GetOr("MISTRAL_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1189
	if c.provider == "groq" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1190
		return env.GetOr("GROQ_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1191
	if c.provider == "together" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1192
		return env.GetOr("TOGETHER_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1193
	if c.provider == "deepseek" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1194
		return env.GetOr("DEEPSEEK_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1195
	if c.provider == "xai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1196
		return env.GetOr("XAI_API_KEY", "")
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1198
	return env.GetOr("LLM_API_KEY", "")
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1201
func rResolveBaseURL(c ResponseClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1202
	if c.baseURL != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1203
		return c.baseURL
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1205
	if c.provider == "openai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1206
		return "https://api.openai.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1207
	if c.provider == "anthropic" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1208
		return "https://api.anthropic.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1209
	if c.provider == "mistral" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1210
		return "https://api.mistral.ai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1211
	if c.provider == "groq" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1212
		return "https://api.groq.com/openai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1213
	if c.provider == "together" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1214
		return "https://api.together.xyz"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1215
	if c.provider == "deepseek" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1216
		return "https://api.deepseek.com"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1217
	if c.provider == "xai" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1218
		return "https://api.x.ai"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1219
	if c.provider == "ollama" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1220
		return "http://localhost:11434"
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1223
	envURL := env.GetOr("LLM_BASE_URL", "")
//line /home/user/kukicha/stdlib/llm/llm.kuki:1224
	if envURL != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1225
		return envURL
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1226
	return "http://localhost:8000"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1229
func rResolvePath(c ResponseClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1230
	if c.path != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1231
		return c.path
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1232
	return "/v1/responses"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1235
func rBuildRequest(c ResponseClient) ResponseRequest {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1236
	req := ResponseRequest{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1237
	req.Model = c.model
//line /home/user/kukicha/stdlib/llm/llm.kuki:1240
	if ((len(c.input) == 1) && (c.input[0].Type == "message")) && (c.input[0].Role == "user") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1242
		req.Input = c.input
	} else {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1244
		req.Input = c.input
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1246
	if c.instructions != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1247
		req.Instructions = c.instructions
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1248
	if c.previousResponseID != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1249
		req.PreviousResponseID = c.previousResponseID
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1250
	if c.temperature != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1251
		req.Temperature = c.temperature
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1252
	if c.topP != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1253
		req.TopP = c.topP
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1254
	if c.maxOutputTokens != 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1255
		req.MaxOutputTokens = c.maxOutputTokens
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1256
	if c.presencePenalty != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1257
		req.PresencePenalty = c.presencePenalty
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1258
	if c.frequencyPenalty != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1259
		req.FrequencyPenalty = c.frequencyPenalty
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1260
	if len(c.tools) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1261
		req.Tools = c.tools
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1262
	if c.toolChoice != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1263
		req.ToolChoice = c.toolChoice
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1264
	if c.store {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1265
		req.Store = true
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1266
	if c.truncation != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1267
		req.Truncation = c.truncation
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1268
	if len(c.metadata) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1269
		req.Metadata = c.metadata
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1270
	if c.textFormat != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1271
		req.Text = c.textFormat
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1272
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1273
		req.Stream = true
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1275
	return req
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1278
func rExecute(c ResponseClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1279
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1280
		return rExecuteStream(c)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1282
	resp, err_9 := rExecuteRaw(c)
	if err_9 != nil {
		return "", err_9
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1283
	return GetResponseText(resp), nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1286
func rExecuteRaw(c ResponseClient) (Response, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1287
	baseURL := rResolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1288
	apiKey := rResolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1289
	responsePath := rResolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1290
	url := fmt.Sprintf("%v%v", baseURL, responsePath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1291
	body := rBuildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1296
	req := fetch.Body(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1298
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1299
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1301
	if c.retryMaxAttempts > 1 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1302
		req = fetch.Retry(req, c.retryMaxAttempts, c.retryDelayMs)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1304
	resp, err_10 := fetch.Do(req)
	if err_10 != nil {
		return *new(Response), err_10
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1306
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1308
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1309
		errBody, err_11 := fetch.Bytes(resp)
		if err_11 != nil {
			return Response{}, errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1310
		return Response{}, errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1312
	result := Response{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1313
	if err_12 := json.UnmarshalRead(resp.Body, &result); err_12 != nil {
		return *new(Response), err_12
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1315
	return result, nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1318
func rExecuteStream(c ResponseClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1319
	baseURL := rResolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1320
	apiKey := rResolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1321
	responsePath := rResolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1322
	url := fmt.Sprintf("%v%v", baseURL, responsePath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1323
	body := rBuildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1329
	req := fetch.Body(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1331
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1332
		req = fetch.Header(req, "Authorization", fmt.Sprintf("Bearer %v", apiKey))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1334
	resp, err_13 := fetch.Do(req)
	if err_13 != nil {
		return "", err_13
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1336
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1338
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1339
		errBody, err_14 := fetch.Bytes(resp)
		if err_14 != nil {
			return "", errors.New(fmt.Sprintf("API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1340
		return "", errors.New(fmt.Sprintf("API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1348
	fullContent := ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1349
	scanner := bufio.NewScanner(resp.Body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1350
	for scanner.Scan() {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1351
		line := scanner.Text()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1354
		if (line == "") || kukistring.HasPrefix(line, ":") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1355
			continue
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1358
		if line == "data: [DONE]" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1359
			break
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1362
		if kukistring.HasPrefix(line, "data: ") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1363
			data := kukistring.TrimPrefix(line, "data: ")
//line /home/user/kukicha/stdlib/llm/llm.kuki:1364
			evt := StreamEvent{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1365
			if err_15 := json.Unmarshal([]byte(data), &evt); err_15 != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1366
				continue
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1369
			if c.eventHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1370
				c.eventHandler(evt)
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1373
			if evt.Type == "response.output_text.delta" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1374
				if evt.Delta != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1375
					fullContent = (fullContent + evt.Delta)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1376
					if c.streamHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1377
						c.streamHandler(evt.Delta)
					}
				}
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1380
			if evt.Type == "error" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1381
				errMsg := evt.Message
//line /home/user/kukicha/stdlib/llm/llm.kuki:1382
				if errMsg == "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1383
					errMsg = fmt.Sprintf("streaming error: %v", evt.Code)
				}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1384
				return fullContent, errors.New(errMsg)
			}
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1386
	if err_16 := scanner.Err(); err_16 != nil {
		return fullContent, errors.New(fmt.Sprintf("%v", err_16))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1388
	return fullContent, nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1396
type ContentBlock struct {
	Type      string `json:"type"`
	Text      string `json:"text,omitempty"`
	Thinking  string `json:"thinking,omitempty"`
	ID        string `json:"id,omitempty"`
	Name      string `json:"name,omitempty"`
	Input     any    `json:"input,omitempty"`
	ToolUseID string `json:"tool_use_id,omitempty"`
	Content   any    `json:"content,omitempty"`
	Source    any    `json:"source,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1410
type ThinkingConfig struct {
	Type         string `json:"type"`
	BudgetTokens int    `json:"budget_tokens,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1416
type OutputConfig struct {
	Format any `json:"format,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1421
type AnthropicMessage struct {
	Role    string `json:"role"`
	Content any    `json:"content"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1426
type AnthropicTool struct {
	Name        string `json:"name"`
	Description string `json:"description,omitempty"`
	InputSchema any    `json:"input_schema"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1432
type AnthropicToolChoice struct {
	Type string `json:"type"`
	Name string `json:"name,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1437
type AnthropicUsage struct {
	InputTokens              int `json:"input_tokens"`
	OutputTokens             int `json:"output_tokens"`
	CacheCreationInputTokens int `json:"cache_creation_input_tokens,omitempty"`
	CacheReadInputTokens     int `json:"cache_read_input_tokens,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1444
type AnthropicResponse struct {
	ID           string         `json:"id"`
	Type         string         `json:"type"`
	Role         string         `json:"role"`
	Content      []ContentBlock `json:"content"`
	Model        string         `json:"model"`
	StopReason   string         `json:"stop_reason"`
	StopSequence string         `json:"stop_sequence,omitempty"`
	Usage        AnthropicUsage `json:"usage"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1455
type MessagesRequest struct {
	Model         string             `json:"model"`
	Messages      []AnthropicMessage `json:"messages"`
	MaxTokens     int                `json:"max_tokens"`
	System        string             `json:"system,omitempty"`
	Temperature   float64            `json:"temperature,omitempty"`
	TopP          float64            `json:"top_p,omitempty"`
	TopK          int                `json:"top_k,omitempty"`
	StopSequences []string           `json:"stop_sequences,omitempty"`
	Stream        bool               `json:"stream,omitempty"`
	Tools         []AnthropicTool    `json:"tools,omitempty"`
	ToolChoice    any                `json:"tool_choice,omitempty"`
	Metadata      any                `json:"metadata,omitempty"`
	Thinking      any                `json:"thinking,omitempty"`
	Effort        string             `json:"effort,omitempty"`
	OutputConfig  any                `json:"output_config,omitempty"`
	InferenceGeo  string             `json:"inference_geo,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1475
type AnthropicStreamEvent struct {
	Type         string            `json:"type"`
	Index        int               `json:"index,omitempty"`
	Message      AnthropicResponse `json:"message,omitempty"`
	ContentBlock ContentBlock      `json:"content_block,omitempty"`
	Delta        AnthropicDelta    `json:"delta,omitempty"`
	Usage        AnthropicUsage    `json:"usage,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1485
type AnthropicDelta struct {
	Type         string `json:"type,omitempty"`
	Text         string `json:"text,omitempty"`
	Thinking     string `json:"thinking,omitempty"`
	PartialJSON  string `json:"partial_json,omitempty"`
	StopReason   string `json:"stop_reason,omitempty"`
	StopSequence string `json:"stop_sequence,omitempty"`
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1494
type MessagesClient struct {
	model            string
	baseURL          string
	path             string
	apiKey           string
	apiVersion       string
	system           string
	messages         []AnthropicMessage
	maxTokens        int
	temperature      float64
	topP             float64
	topK             int
	stopSequences    []string
	tools            []AnthropicTool
	toolChoice       any
	metadata         any
	thinking         any
	effort           string
	outputConfig     any
	inferenceGeo     string
	streamHandler    func(string)
	eventHandler     func(AnthropicStreamEvent)
	retryMaxAttempts int
	retryDelayMs     int
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1521
func NewMessages(model string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1522
	c := MessagesClient{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1523
	c.model = model
//line /home/user/kukicha/stdlib/llm/llm.kuki:1524
	c.baseURL = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1525
	c.path = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1526
	c.apiKey = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1527
	c.apiVersion = "2023-06-01"
//line /home/user/kukicha/stdlib/llm/llm.kuki:1528
	c.system = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1529
	c.messages = []AnthropicMessage{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1530
	c.maxTokens = 1024
//line /home/user/kukicha/stdlib/llm/llm.kuki:1531
	c.temperature = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:1532
	c.topP = 0.0
//line /home/user/kukicha/stdlib/llm/llm.kuki:1533
	c.topK = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:1534
	c.stopSequences = []string{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1535
	c.tools = []AnthropicTool{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1536
	c.toolChoice = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1537
	c.metadata = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1538
	c.thinking = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1539
	c.effort = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1540
	c.outputConfig = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1541
	c.inferenceGeo = ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1542
	c.streamHandler = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1543
	c.eventHandler = nil
//line /home/user/kukicha/stdlib/llm/llm.kuki:1544
	c.retryMaxAttempts = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:1545
	c.retryDelayMs = 0
//line /home/user/kukicha/stdlib/llm/llm.kuki:1546
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1550
func MBaseURL(c MessagesClient, url string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1551
	c.baseURL = url
//line /home/user/kukicha/stdlib/llm/llm.kuki:1552
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1556
func MPath(c MessagesClient, path string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1557
	c.path = path
//line /home/user/kukicha/stdlib/llm/llm.kuki:1558
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1563
func MAPIKey(c MessagesClient, key string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1564
	c.apiKey = key
//line /home/user/kukicha/stdlib/llm/llm.kuki:1565
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1570
func MAPIVersion(c MessagesClient, version string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1571
	c.apiVersion = version
//line /home/user/kukicha/stdlib/llm/llm.kuki:1572
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1576
func MSystem(c MessagesClient, system string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1577
	c.system = system
//line /home/user/kukicha/stdlib/llm/llm.kuki:1578
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1582
func MUser(c MessagesClient, content string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1583
	msg := AnthropicMessage{Role: "user", Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1584
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1585
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1590
func MAssistant(c MessagesClient, content string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1591
	msg := AnthropicMessage{Role: "assistant", Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1592
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1593
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1597
func MAddMessage(c MessagesClient, role string, content any) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1598
	msg := AnthropicMessage{Role: role, Content: content}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1599
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1600
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1605
func MToolResult(c MessagesClient, toolUseID string, result string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1606
	block := ContentBlock{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1607
	block.Type = "tool_result"
//line /home/user/kukicha/stdlib/llm/llm.kuki:1608
	block.ToolUseID = toolUseID
//line /home/user/kukicha/stdlib/llm/llm.kuki:1609
	block.Content = result
//line /home/user/kukicha/stdlib/llm/llm.kuki:1610
	blocks := []ContentBlock{block}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1611
	msg := AnthropicMessage{Role: "user", Content: blocks}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1612
	c.messages = append(c.messages, msg)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1613
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1618
func MMaxTokens(c MessagesClient, max int) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1619
	c.maxTokens = max
//line /home/user/kukicha/stdlib/llm/llm.kuki:1620
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1624
func MTemperature(c MessagesClient, temp float64) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1625
	c.temperature = temp
//line /home/user/kukicha/stdlib/llm/llm.kuki:1626
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1630
func MTopP(c MessagesClient, p float64) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1631
	c.topP = p
//line /home/user/kukicha/stdlib/llm/llm.kuki:1632
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1636
func MTopK(c MessagesClient, k int) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1637
	c.topK = k
//line /home/user/kukicha/stdlib/llm/llm.kuki:1638
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1642
func MStopSequences(c MessagesClient, sequences []string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1643
	c.stopSequences = sequences
//line /home/user/kukicha/stdlib/llm/llm.kuki:1644
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1649
func MAdaptiveThinking(c MessagesClient) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1650
	c.thinking = ThinkingConfig{Type: "adaptive"}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1651
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1655
func MThinking(c MessagesClient, budgetTokens int) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1656
	c.thinking = ThinkingConfig{Type: "enabled", BudgetTokens: budgetTokens}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1657
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1664
func MEffort(c MessagesClient, effort string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1665
	c.effort = effort
//line /home/user/kukicha/stdlib/llm/llm.kuki:1666
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1672
func MOutputFormat(c MessagesClient, format any) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1673
	c.outputConfig = OutputConfig{Format: format}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1674
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1680
func MInferenceGeo(c MessagesClient, geo string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1681
	c.inferenceGeo = geo
//line /home/user/kukicha/stdlib/llm/llm.kuki:1682
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1686
func MAddTool(c MessagesClient, name string, description string, inputSchema any) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1687
	tool := AnthropicTool{Name: name, Description: description, InputSchema: inputSchema}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1688
	c.tools = append(c.tools, tool)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1689
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1693
func MToolChoiceAuto(c MessagesClient) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1694
	c.toolChoice = AnthropicToolChoice{Type: "auto"}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1695
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1699
func MToolChoiceAny(c MessagesClient) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1700
	c.toolChoice = AnthropicToolChoice{Type: "any"}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1701
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1705
func MToolChoiceTool(c MessagesClient, name string) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1706
	c.toolChoice = AnthropicToolChoice{Type: "tool", Name: name}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1707
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1712
func MStream(c MessagesClient, handler func(string)) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1713
	c.streamHandler = handler
//line /home/user/kukicha/stdlib/llm/llm.kuki:1714
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1719
func MStreamEvents(c MessagesClient, handler func(AnthropicStreamEvent)) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1720
	c.eventHandler = handler
//line /home/user/kukicha/stdlib/llm/llm.kuki:1721
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1725
func MRetry(c MessagesClient, maxAttempts int, delayMs int) MessagesClient {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1726
	c.retryMaxAttempts = maxAttempts
//line /home/user/kukicha/stdlib/llm/llm.kuki:1727
	c.retryDelayMs = delayMs
//line /home/user/kukicha/stdlib/llm/llm.kuki:1728
	return c
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1734
func MAsk(c MessagesClient, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1735
	c = MUser(c, prompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1736
	return mExecute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1746
func MSend(c MessagesClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1747
	return mExecute(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1755
func MAskRaw(c MessagesClient, prompt string) (AnthropicResponse, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1756
	c = MUser(c, prompt)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1757
	return mExecuteRaw(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1765
func MSendRaw(c MessagesClient) (AnthropicResponse, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1766
	return mExecuteRaw(c)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1770
func AnthropicComplete(model string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1771
	c := NewMessages(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1772
	return MAsk(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1776
func AnthropicCompleteWithSystem(model string, system string, prompt string) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1777
	c := NewMessages(model)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1778
	c = MSystem(c, system)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1779
	return MAsk(c, prompt)
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1784
func GetAnthropicText(resp AnthropicResponse) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1785
	result := ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1786
	for _, block := range resp.Content {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1787
		if block.Type == "text" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1788
			result = (result + block.Text)
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1789
	return result
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1795
func GetThinking(resp AnthropicResponse) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1796
	result := ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1797
	for _, block := range resp.Content {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1798
		if block.Type == "thinking" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1799
			result = (result + block.Thinking)
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1800
	return result
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1805
func GetToolUses(resp AnthropicResponse) []ContentBlock {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1806
	uses := []ContentBlock{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1807
	for _, block := range resp.Content {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1808
		if block.Type == "tool_use" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1809
			uses = append(uses, block)
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1810
	return uses
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1814
func HasToolUses(resp AnthropicResponse) bool {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1815
	return (resp.StopReason == "tool_use")
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1818
func mResolveAPIKey(c MessagesClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1819
	if c.apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1820
		return c.apiKey
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1821
	return env.GetOr("ANTHROPIC_API_KEY", "")
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1824
func mResolveBaseURL(c MessagesClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1825
	if c.baseURL != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1826
		return c.baseURL
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1827
	return "https://api.anthropic.com"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1830
func mResolvePath(c MessagesClient) string {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1831
	if c.path != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1832
		return c.path
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1833
	return "/v1/messages"
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1836
func mBuildRequest(c MessagesClient) MessagesRequest {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1837
	req := MessagesRequest{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1838
	req.Model = c.model
//line /home/user/kukicha/stdlib/llm/llm.kuki:1839
	req.Messages = c.messages
//line /home/user/kukicha/stdlib/llm/llm.kuki:1840
	req.MaxTokens = c.maxTokens
//line /home/user/kukicha/stdlib/llm/llm.kuki:1842
	if c.system != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1843
		req.System = c.system
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1844
	if c.temperature != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1845
		req.Temperature = c.temperature
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1846
	if c.topP != 0.0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1847
		req.TopP = c.topP
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1848
	if c.topK != 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1849
		req.TopK = c.topK
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1850
	if len(c.stopSequences) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1851
		req.StopSequences = c.stopSequences
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1852
	if len(c.tools) > 0 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1853
		req.Tools = c.tools
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1854
	if c.toolChoice != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1855
		req.ToolChoice = c.toolChoice
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1856
	if c.metadata != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1857
		req.Metadata = c.metadata
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1858
	if c.thinking != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1859
		req.Thinking = c.thinking
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1860
	if c.effort != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1861
		req.Effort = c.effort
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1862
	if c.outputConfig != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1863
		req.OutputConfig = c.outputConfig
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1864
	if c.inferenceGeo != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1865
		req.InferenceGeo = c.inferenceGeo
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1866
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1867
		req.Stream = true
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1869
	return req
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1872
func mExecute(c MessagesClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1873
	if (c.streamHandler != nil) || (c.eventHandler != nil) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1874
		return mExecuteStream(c)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1876
	resp, err_17 := mExecuteRaw(c)
	if err_17 != nil {
		return "", err_17
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1877
	return GetAnthropicText(resp), nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1880
func mExecuteRaw(c MessagesClient) (AnthropicResponse, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1881
	baseURL := mResolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1882
	apiKey := mResolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1883
	msgPath := mResolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1884
	url := fmt.Sprintf("%v%v", baseURL, msgPath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1885
	body := mBuildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1891
	req := fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "anthropic-version", c.apiVersion)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1893
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1894
		req = fetch.Header(req, "x-api-key", apiKey)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1896
	req = fetch.Body(req, body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1898
	if c.retryMaxAttempts > 1 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1899
		req = fetch.Retry(req, c.retryMaxAttempts, c.retryDelayMs)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1901
	resp, err_18 := fetch.Do(req)
	if err_18 != nil {
		return *new(AnthropicResponse), err_18
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1903
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1905
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1906
		errBody, err_19 := fetch.Bytes(resp)
		if err_19 != nil {
			return AnthropicResponse{}, errors.New(fmt.Sprintf("Anthropic API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1907
		return AnthropicResponse{}, errors.New(fmt.Sprintf("Anthropic API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1909
	result := AnthropicResponse{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1910
	if err_20 := json.UnmarshalRead(resp.Body, &result); err_20 != nil {
		return *new(AnthropicResponse), err_20
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1912
	return result, nil
}

//line /home/user/kukicha/stdlib/llm/llm.kuki:1924
func mExecuteStream(c MessagesClient) (string, error) {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1925
	baseURL := mResolveBaseURL(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1926
	apiKey := mResolveAPIKey(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1927
	msgPath := mResolvePath(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1928
	url := fmt.Sprintf("%v%v", baseURL, msgPath)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1929
	body := mBuildRequest(c)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1935
	req := fetch.Header(fetch.Header(fetch.Header(fetch.Method(fetch.New(url), "POST"), "Content-Type", "application/json"), "Accept", "text/event-stream"), "anthropic-version", c.apiVersion)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1937
	if apiKey != "" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1938
		req = fetch.Header(req, "x-api-key", apiKey)
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1940
	req = fetch.Body(req, body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1942
	resp, err_21 := fetch.Do(req)
	if err_21 != nil {
		return "", err_21
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1944
	defer resp.Body.Close()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1946
	if resp.StatusCode >= 400 {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1947
		errBody, err_22 := fetch.Bytes(resp)
		if err_22 != nil {
			return "", errors.New(fmt.Sprintf("Anthropic API request failed with status %v", resp.StatusCode))
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1948
		return "", errors.New(fmt.Sprintf("Anthropic API request failed (%v): %v", resp.StatusCode, string(errBody)))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1952
	fullContent := ""
//line /home/user/kukicha/stdlib/llm/llm.kuki:1953
	scanner := bufio.NewScanner(resp.Body)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1954
	for scanner.Scan() {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1955
		line := scanner.Text()
//line /home/user/kukicha/stdlib/llm/llm.kuki:1958
		if ((line == "") || kukistring.HasPrefix(line, "event:")) || kukistring.HasPrefix(line, ":") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1959
			continue
		}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1962
		if kukistring.HasPrefix(line, "data: ") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1963
			data := kukistring.TrimPrefix(line, "data: ")
//line /home/user/kukicha/stdlib/llm/llm.kuki:1964
			evt := AnthropicStreamEvent{}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1965
			if err_23 := json.Unmarshal([]byte(data), &evt); err_23 != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1966
				continue
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1969
			if c.eventHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1970
				c.eventHandler(evt)
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1973
			if evt.Type == "content_block_delta" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1974
				if (evt.Delta.Type == "text_delta") && (evt.Delta.Text != "") {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1975
					fullContent = (fullContent + evt.Delta.Text)
//line /home/user/kukicha/stdlib/llm/llm.kuki:1976
					if c.streamHandler != nil {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1977
						c.streamHandler(evt.Delta.Text)
					}
				}
			}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1980
			if evt.Type == "error" {
//line /home/user/kukicha/stdlib/llm/llm.kuki:1981
				return fullContent, errors.New("Anthropic streaming error")
			}
		}
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1983
	if err_24 := scanner.Err(); err_24 != nil {
		return fullContent, errors.New(fmt.Sprintf("%v", err_24))
	}
//line /home/user/kukicha/stdlib/llm/llm.kuki:1984
	return fullContent, nil
}
