# Tests for Kukicha Standard Library - LLM Package

petiole llm_test

import "stdlib/llm"
import "stdlib/test"
import "testing"

# --- TestGetContent ---
type GetContentCase
    name    string
    content string
    want    string

func TestGetContent(t reference testing.T)
    cases := list of GetContentCase{
        GetContentCase{name: "basic content", content: "response text", want: "response text"},
        GetContentCase{name: "empty content", content: "", want: ""},
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            msg := llm.ResponseMessage{}
            msg.Role = "assistant"
            msg.Content = tc.content

            choice := llm.Choice{}
            choice.Message = msg

            completion := llm.Completion{}
            completion.Choices = list of llm.Choice{choice}

            test.AssertEqual(t, llm.GetContent(completion), tc.want)
        )

# --- TestGetToolCalls ---
type GetToolCallsCase
    name      string
    callID    string
    funcName  string
    wantCount int

func TestGetToolCalls(t reference testing.T)
    cases := list of GetToolCallsCase{
        GetToolCallsCase{name: "one tool call", callID: "call-1", funcName: "do_thing", wantCount: 1},
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            toolFunc := llm.ToolCallFunction{}
            toolFunc.Name = tc.funcName
            toolFunc.Arguments = "{}"

            toolCall := llm.ToolCall{}
            toolCall.ID = tc.callID
            toolCall.Type = "function"
            toolCall.Function = toolFunc

            msg := llm.ResponseMessage{}
            msg.Role = "assistant"
            msg.ToolCalls = list of llm.ToolCall{toolCall}

            choice := llm.Choice{}
            choice.Message = msg
            completion := llm.Completion{}
            completion.Choices = list of llm.Choice{choice}

            calls := llm.GetToolCalls(completion)
            test.AssertEqual(t, len(calls), tc.wantCount)
            if len(calls) > 0
                test.AssertEqual(t, calls[0].Function.Name, tc.funcName)
        )

# --- TestHasToolCalls ---
type HasToolCallsCase
    name     string
    hasCalls bool
    want     bool

func TestHasToolCalls(t reference testing.T)
    cases := list of HasToolCallsCase{
        HasToolCallsCase{name: "no calls", hasCalls: false, want: false},
        HasToolCallsCase{name: "has calls", hasCalls: true, want: true},
    }
    for tc in cases
        t.Run(tc.name, (t reference testing.T) =>
            completion := llm.Completion{}
            if tc.hasCalls
                toolCall := llm.ToolCall{}
                toolCall.ID = "call-1"
                msg := llm.ResponseMessage{}
                msg.ToolCalls = list of llm.ToolCall{toolCall}
                choice := llm.Choice{}
                choice.Message = msg
                completion.Choices = list of llm.Choice{choice}

            test.AssertEqual(t, llm.HasToolCalls(completion), tc.want)
        )
