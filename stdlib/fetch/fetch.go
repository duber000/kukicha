// Generated by Kukicha v0.0.10 (requires Go 1.26+)

package fetch

import (
	"bytes"
	"encoding/base64"
	"errors"
	"fmt"
	"github.com/duber000/kukicha/stdlib/json"
	"github.com/duber000/kukicha/stdlib/netguard"
	"github.com/duber000/kukicha/stdlib/retry"
	"github.com/duber000/kukicha/stdlib/sandbox"
	kukistring "github.com/duber000/kukicha/stdlib/string"
	"io"
	"net/http"
	"net/http/cookiejar"
	"net/url"
	"time"
)

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:31
type Request struct {
	url              string
	headers          map[string]string
	timeoutNs        int64
	method           string
	body             any
	transport        *http.Transport
	retryMaxAttempts int
	retryDelayMs     int
	maxBodySize      int64
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:45
func New(url string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:46
	req := Request{}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:47
	req.url = url
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:48
	req.headers = make(map[string]string)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:49
	req.timeoutNs = 30000000000
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:50
	req.method = "GET"
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:51
	req.body = nil
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:52
	req.retryMaxAttempts = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:53
	req.retryDelayMs = 0
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:54
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:58
func Header(req Request, name string, value string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:59
	req.headers[name] = value
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:60
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:65
func Timeout(req Request, durationNs int64) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:66
	req.timeoutNs = durationNs
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:67
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:71
func Method(req Request, method string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:72
	req.method = method
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:73
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:78
func Body(req Request, data any) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:79
	req.body = data
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:80
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:85
func Transport(req Request, t *http.Transport) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:86
	req.transport = t
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:87
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:92
func MaxBodySize(req Request, limit int64) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:93
	req.maxBodySize = limit
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:94
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:99
func Retry(req Request, maxAttempts int, delayMs int) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:100
	req.retryMaxAttempts = maxAttempts
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:101
	if delayMs <= 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:102
		req.retryDelayMs = 1000
	} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:104
		req.retryDelayMs = delayMs
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:105
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:108
func doOnce(req Request) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:109
	client := http.Client{}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:110
	if req.transport != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:111
		client.Transport = req.transport
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:112
	client.Timeout = time.Duration(req.timeoutNs)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:115
	var bodyData any
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:116
	if req.body != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:118
		switch bodyStr := req.body.(type) {
		case string:
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:120
			bodyData = []byte(bodyStr)
		default:
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:123
			jsonBytes, marshalErr := json.Marshal(req.body)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:124
			if marshalErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:125
				return nil, marshalErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:126
			bodyData = jsonBytes
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:128
	httpReq, reqErr := createHTTPRequest(req.method, req.url, bodyData)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:129
	if reqErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:130
		return nil, reqErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:133
	for name, value := range req.headers {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:134
		httpReq.Header.Set(name, value)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:137
	if req.body != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:138
		contentType := httpReq.Header.Get("Content-Type")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:139
		if contentType == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:140
			httpReq.Header.Set("Content-Type", "application/json")
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:142
	resp, doErr := client.Do(httpReq)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:143
	if doErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:144
		return nil, doErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:145
	if req.maxBodySize > 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:146
		resp.Body = io.NopCloser(io.LimitReader(resp.Body, req.maxBodySize))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:147
	return resp, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:152
func Do(req Request) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:153
	if req.retryMaxAttempts <= 1 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:154
		return doOnce(req)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:156
	delayMs := req.retryDelayMs
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:157
	if delayMs <= 0 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:158
		delayMs = 1000
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:159
	cfg := retry.Config{MaxAttempts: req.retryMaxAttempts, InitialDelay: delayMs, Strategy: 1}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:161
	attempt := 0
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:162
	lastErr := errors.New("no attempts made")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:163
	for attempt < cfg.MaxAttempts {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:164
		resp, err := doOnce(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:165
		if err == nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:167
			if (resp.StatusCode != 429) && (resp.StatusCode != 503) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:168
				return resp, nil
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:170
			resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:171
			lastErr = errors.New(fmt.Sprintf("request failed: status %v", resp.StatusCode))
		} else {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:174
			lastErr = err
		}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:175
		retry.Sleep(cfg, attempt)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:176
		attempt = (attempt + 1)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:178
	return nil, lastErr
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:181
func createHTTPRequest(method string, url string, bodyData any) (*http.Request, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:182
	if bodyData != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:183
		bodyBytes := bodyData.([]byte)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:184
		req, err := http.NewRequest(method, url, bytes.NewReader(bodyBytes))
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:185
		return req, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:186
	req, err := http.NewRequest(method, url, nil)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:187
	return req, err
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:192
func Get(url string) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:193
	req := New(url)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:194
	resp, err := Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:195
	return resp, err
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:201
func SafeGet(url string) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:202
	guard := netguard.NewSSRFGuard()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:203
	transport := netguard.HTTPTransport(guard)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:204
	req := New(url)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:205
	req.transport = transport
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:206
	resp, err := Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:207
	return resp, err
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:213
func Post(data any, url string) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:214
	req := New(url)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:215
	req = Method(req, "POST")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:216
	req.body = data
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:217
	resp, err := Do(req)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:218
	return resp, err
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:223
func CheckStatus(resp *http.Response) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:224
	if resp.StatusCode >= 400 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:225
		return nil, errors.New(fmt.Sprintf("request failed: %v", resp.Status))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:226
	return resp, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:230
func Text(resp *http.Response) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:231
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:232
	bodyBytes, err := io.ReadAll(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:233
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:234
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:236
	text := string(bodyBytes)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:237
	return text, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:242
func Bytes(resp *http.Response) ([]byte, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:243
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:244
	bodyBytes, err := io.ReadAll(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:245
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:246
		return nil, err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:247
	return bodyBytes, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:252
func Json[T any](resp *http.Response, sample T) (T, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:253
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:254
	data := sample
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:255
	if err_1 := json.UnmarshalRead(resp.Body, &data); err_1 != nil {
		err_1 = fmt.Errorf("failed to decode response json: %w", err_1)
		return *new(T), err_1
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:256
	return data, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:263
func Decode(resp *http.Response, target any) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:264
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:265
	return json.UnmarshalRead(resp.Body, target)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:269
func PathEscape(value string) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:270
	return url.PathEscape(value)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:274
func QueryEscape(value string) string {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:275
	return url.QueryEscape(value)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:281
func URLTemplate(tmpl string, params map[string]string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:282
	result := tmpl
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:283
	for key, value := range params {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:284
		placeholder := fmt.Sprintf("%c%s%c", 123, key, 125)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:285
		result = kukistring.ReplaceAll(result, placeholder, url.PathEscape(value))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:287
	if kukistring.Contains(result, "{") || kukistring.Contains(result, "}") {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:288
		return "", errors.New(fmt.Sprintf("unresolved URL template placeholders: %v", result))
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:289
	return result, nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:294
func URLWithQuery(baseURL string, params map[string]string) (string, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:295
	parsed, err := url.Parse(baseURL)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:296
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:297
		return "", err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:298
	query := parsed.Query()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:299
	for key, value := range params {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:300
		query.Set(key, value)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:301
	parsed.RawQuery = query.Encode()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:302
	return parsed.String(), nil
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:310
func BearerAuth(req Request, token string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:311
	return Header(req, "Authorization", fmt.Sprintf("Bearer %v", token))
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:315
func BasicAuth(req Request, username string, password string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:316
	credentials := fmt.Sprintf("%v:%v", username, password)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:317
	encoded := base64.StdEncoding.EncodeToString([]byte(credentials))
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:318
	return Header(req, "Authorization", fmt.Sprintf("Basic %v", encoded))
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:327
func FormData(req Request, data map[string]string) Request {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:328
	values := url.Values{}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:329
	for key, value := range data {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:330
		values.Set(key, value)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:331
	req.body = values.Encode()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:332
	req = Header(req, "Content-Type", "application/x-www-form-urlencoded")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:333
	return req
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:340
type Session struct {
	client    http.Client
	headers   map[string]string
	timeoutNs int64
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:347
func NewSession() Session {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:348
	jar, _ := cookiejar.New(nil)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:349
	client := http.Client{Jar: jar}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:350
	s := Session{}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:351
	s.client = client
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:352
	s.headers = make(map[string]string)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:353
	s.timeoutNs = 30000000000
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:354
	return s
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:358
func SessionHeader(s Session, name string, value string) Session {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:359
	s.headers[name] = value
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:360
	return s
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:364
func SessionTimeout(s Session, durationNs int64) Session {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:365
	s.timeoutNs = durationNs
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:366
	return s
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:371
func SessionDo(s Session, req Request) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:373
	for name, value := range s.headers {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:374
		_, exists := req.headers[name]
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:375
		if !exists {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:376
			req.headers[name] = value
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:379
	if req.timeoutNs == 30000000000 {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:380
		req.timeoutNs = s.timeoutNs
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:383
	s.client.Timeout = time.Duration(req.timeoutNs)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:386
	var bodyData any
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:387
	if req.body != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:389
		switch bodyStr := req.body.(type) {
		case string:
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:391
			bodyData = []byte(bodyStr)
		default:
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:393
			jsonBytes, marshalErr := json.Marshal(req.body)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:394
			if marshalErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:395
				return nil, marshalErr
			}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:396
			bodyData = jsonBytes
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:398
	httpReq, reqErr := createHTTPRequest(req.method, req.url, bodyData)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:399
	if reqErr != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:400
		return nil, reqErr
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:402
	for name, value := range req.headers {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:403
		httpReq.Header.Set(name, value)
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:406
	if req.body != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:407
		contentType := httpReq.Header.Get("Content-Type")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:408
		if contentType == "" {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:409
			httpReq.Header.Set("Content-Type", "application/json")
		}
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:411
	resp, doErr := s.client.Do(httpReq)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:412
	return resp, doErr
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:416
func SessionGet(s Session, url string) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:417
	req := New(url)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:418
	return SessionDo(s, req)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:422
func SessionPost(s Session, data any, url string) (*http.Response, error) {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:423
	req := New(url)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:424
	req = Method(req, "POST")
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:425
	req.body = data
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:426
	return SessionDo(s, req)
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:431
func SessionTransport(s Session, t *http.Transport) Session {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:432
	s.client.Transport = t
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:433
	return s
}

//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:441
func DownloadTo(resp *http.Response, box sandbox.Root, path string) error {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:442
	defer resp.Body.Close()
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:443
	bodyBytes, err := io.ReadAll(resp.Body)
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:444
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:445
		return err
	}
//line /var/home/tluker/repos/go/kukicha/stdlib/fetch/fetch.kuki:446
	return sandbox.WriteString(box, string(bodyBytes), path)
}
