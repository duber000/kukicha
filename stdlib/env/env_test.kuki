# Env Package Tests

petiole env_test

import "stdlib/env"
import "stdlib/test"
import "testing"
import "os"

# Setup test environment variables
func setupTestEnv()
    os.Setenv("TEST_STRING", "hello")
    os.Setenv("TEST_INT", "42")
    os.Setenv("TEST_BOOL_TRUE", "true")
    os.Setenv("TEST_BOOL_FALSE", "false")
    os.Setenv("TEST_FLOAT", "3.14")
    os.Setenv("TEST_LIST", "a,b,c")
    os.Setenv("TEST_EMPTY", "")

# Cleanup test environment variables
func cleanupTestEnv()
    os.Unsetenv("TEST_STRING")
    os.Unsetenv("TEST_INT")
    os.Unsetenv("TEST_BOOL_TRUE")
    os.Unsetenv("TEST_BOOL_FALSE")
    os.Unsetenv("TEST_FLOAT")
    os.Unsetenv("TEST_LIST")
    os.Unsetenv("TEST_EMPTY")

# Test Get function
func TestGet(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.Get("TEST_STRING") onerr panic "get failed"
    test.AssertEqual(t, value, "hello")

    _, err := env.Get("NONEXISTENT")
    test.AssertNotEmpty(t, err)

# Test GetOr function
func TestGetOr(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetOr("TEST_STRING", "default")
    test.AssertEqual(t, value, "hello")

    value2 := env.GetOr("NONEXISTENT", "default")
    test.AssertEqual(t, value2, "default")

# Test GetInt function
func TestGetInt(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetInt("TEST_INT") onerr panic "get int failed"
    test.AssertEqual(t, value, 42)

    _, err := env.GetInt("NONEXISTENT")
    test.AssertNotEmpty(t, err)

    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    _, err2 := env.GetInt("TEST_INVALID_INT")
    test.AssertNotEmpty(t, err2)

# Test GetIntOr function
func TestGetIntOr(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetIntOr("TEST_INT", 100) onerr panic "get int or failed"
    test.AssertEqual(t, value, 42)

    value2 := env.GetIntOr("NONEXISTENT", 100) onerr panic "get int or failed"
    test.AssertEqual(t, value2, 100)

    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    _, err := env.GetIntOr("TEST_INVALID_INT", 100)
    test.AssertNotEmpty(t, err)

# Test GetIntOrDefault function
func TestGetIntOrDefault(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetIntOrDefault("TEST_INT", 100)
    test.AssertEqual(t, value, 42)

    value2 := env.GetIntOrDefault("NONEXISTENT", 100)
    test.AssertEqual(t, value2, 100)

    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    value3 := env.GetIntOrDefault("TEST_INVALID_INT", 100)
    test.AssertEqual(t, value3, 100)

# Test GetBool function
func TestGetBool(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetBool("TEST_BOOL_TRUE") onerr panic "get bool failed"
    test.AssertTrue(t, value)

    value2 := env.GetBool("TEST_BOOL_FALSE") onerr panic "get bool failed"
    test.AssertFalse(t, value2)

    _, err := env.GetBool("NONEXISTENT")
    test.AssertNotEmpty(t, err)

    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    _, err2 := env.GetBool("TEST_INVALID_BOOL")
    test.AssertNotEmpty(t, err2)

# Test GetBoolOr function
func TestGetBoolOr(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetBoolOr("TEST_BOOL_TRUE", false) onerr panic "get bool or failed"
    test.AssertTrue(t, value)

    value2 := env.GetBoolOr("NONEXISTENT", true) onerr panic "get bool or failed"
    test.AssertTrue(t, value2)

    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    _, err := env.GetBoolOr("TEST_INVALID_BOOL", false)
    test.AssertNotEmpty(t, err)

# Test GetBoolOrDefault function
func TestGetBoolOrDefault(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetBoolOrDefault("TEST_BOOL_TRUE", false)
    test.AssertTrue(t, value)

    value2 := env.GetBoolOrDefault("NONEXISTENT", true)
    test.AssertTrue(t, value2)

    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    value3 := env.GetBoolOrDefault("TEST_INVALID_BOOL", false)
    test.AssertFalse(t, value3)

# Test GetFloat function
func TestGetFloat(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetFloat("TEST_FLOAT") onerr panic "get float failed"
    test.AssertEqual(t, value, 3.14)

    _, err := env.GetFloat("NONEXISTENT")
    test.AssertNotEmpty(t, err)

    os.Setenv("TEST_INVALID_FLOAT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_FLOAT")
    _, err2 := env.GetFloat("TEST_INVALID_FLOAT")
    test.AssertNotEmpty(t, err2)

# Test GetFloatOr function
func TestGetFloatOr(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetFloatOr("TEST_FLOAT", 2.71) onerr panic "get float or failed"
    test.AssertEqual(t, value, 3.14)

    value2 := env.GetFloatOr("NONEXISTENT", 2.71) onerr panic "get float or failed"
    test.AssertEqual(t, value2, 2.71)

    os.Setenv("TEST_INVALID_FLOAT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_FLOAT")
    _, err := env.GetFloatOr("TEST_INVALID_FLOAT", 2.71)
    test.AssertNotEmpty(t, err)

# Test GetList function
func TestGetList(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetList("TEST_LIST", ",") onerr panic "get list failed"
    test.AssertEqual(t, len(value), 3)
    test.AssertEqual(t, value[0], "a")
    test.AssertEqual(t, value[1], "b")
    test.AssertEqual(t, value[2], "c")

    _, err := env.GetList("NONEXISTENT", ",")
    test.AssertNotEmpty(t, err)

# Test GetListOr function
func TestGetListOr(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    value := env.GetListOr("TEST_LIST", ",", list of string{"default"})
    test.AssertEqual(t, len(value), 3)
    test.AssertEqual(t, value[0], "a")

    value2 := env.GetListOr("NONEXISTENT", ",", list of string{"default"})
    test.AssertEqual(t, len(value2), 1)
    test.AssertEqual(t, value2[0], "default")

# Test Set and Unset functions
func TestSetUnset(t reference testing.T)
    err := env.Set("TEST_NEW_VAR", "new_value")
    test.AssertEqual(t, err, empty)
    value := os.Getenv("TEST_NEW_VAR")
    test.AssertEqual(t, value, "new_value")

    env.Unset("TEST_NEW_VAR") onerr panic "unset failed"
    value2 := os.Getenv("TEST_NEW_VAR")
    test.AssertEqual(t, value2, "")

# Test IsSet and IsSetAndNotEmpty functions
func TestIsSet(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    test.AssertTrue(t, env.IsSet("TEST_STRING"))

    test.AssertFalse(t, env.IsSet("NONEXISTENT"))

    test.AssertTrue(t, env.IsSetAndNotEmpty("TEST_STRING"))

    test.AssertFalse(t, env.IsSetAndNotEmpty("TEST_EMPTY"))

    test.AssertFalse(t, env.IsSetAndNotEmpty("NONEXISTENT"))

# Test All function
func TestAll(t reference testing.T)
    setupTestEnv()
    defer cleanupTestEnv()

    all := env.All()
    test.AssertNotEmpty(t, all)
    test.AssertTrue(t, len(all) >= 7)

    test.AssertEqual(t, all["TEST_STRING"], "hello")
    test.AssertEqual(t, all["TEST_INT"], "42")

# Test ParseBool function
func TestParseBool(t reference testing.T)
    value, err := env.ParseBool("true")
    test.AssertEqual(t, err, empty)
    test.AssertTrue(t, value)

    value2, err2 := env.ParseBool("1")
    test.AssertEqual(t, err2, empty)
    test.AssertTrue(t, value2)

    value3, err3 := env.ParseBool("yes")
    test.AssertEqual(t, err3, empty)
    test.AssertTrue(t, value3)

    value4, err4 := env.ParseBool("on")
    test.AssertEqual(t, err4, empty)
    test.AssertTrue(t, value4)

    value5, err5 := env.ParseBool("false")
    test.AssertEqual(t, err5, empty)
    test.AssertFalse(t, value5)

    value6, err6 := env.ParseBool("0")
    test.AssertEqual(t, err6, empty)
    test.AssertFalse(t, value6)

    value7, err7 := env.ParseBool("no")
    test.AssertEqual(t, err7, empty)
    test.AssertFalse(t, value7)

    value8, err8 := env.ParseBool("off")
    test.AssertEqual(t, err8, empty)
    test.AssertFalse(t, value8)

    value9, err9 := env.ParseBool("TRUE")
    test.AssertEqual(t, err9, empty)
    test.AssertTrue(t, value9)

    _, err10 := env.ParseBool("invalid")
    test.AssertNotEmpty(t, err10)

# Test SplitAndTrim function
func TestSplitAndTrim(t reference testing.T)
    result := env.SplitAndTrim("a, b,  c", ",")
    test.AssertEqual(t, len(result), 3)
    test.AssertEqual(t, result[0], "a")
    test.AssertEqual(t, result[1], "b")
    test.AssertEqual(t, result[2], "c")

    result2 := env.SplitAndTrim("a,, b,  ", ",")
    test.AssertEqual(t, len(result2), 2)
    test.AssertEqual(t, result2[0], "a")
    test.AssertEqual(t, result2[1], "b")

    result3 := env.SplitAndTrim("", ",")
    test.AssertEqual(t, len(result3), 0)