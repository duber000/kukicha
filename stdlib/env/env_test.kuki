# Env Package Tests

import "stdlib/env"
import "stdlib/test"
import "os"

# Setup test environment variables
func setupTestEnv()
    os.Setenv("TEST_STRING", "hello")
    os.Setenv("TEST_INT", "42")
    os.Setenv("TEST_BOOL_TRUE", "true")
    os.Setenv("TEST_BOOL_FALSE", "false")
    os.Setenv("TEST_FLOAT", "3.14")
    os.Setenv("TEST_LIST", "a,b,c")
    os.Setenv("TEST_EMPTY", "")

# Cleanup test environment variables
func cleanupTestEnv()
    os.Unsetenv("TEST_STRING")
    os.Unsetenv("TEST_INT")
    os.Unsetenv("TEST_BOOL_TRUE")
    os.Unsetenv("TEST_BOOL_FALSE")
    os.Unsetenv("TEST_FLOAT")
    os.Unsetenv("TEST_LIST")
    os.Unsetenv("TEST_EMPTY")

# Test Get function
test GetFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing variable
    value := env.Get("TEST_STRING") onerr panic "get failed"
    test.AssertEqual(value, "hello")
    
    # Test non-existent variable
    _, err := env.Get("NONEXISTENT")
    test.AssertNotEmpty(err)

# Test GetOr function
test GetOrFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing variable
    value := env.GetOr("TEST_STRING", "default")
    test.AssertEqual(value, "hello")
    
    # Test non-existent variable
    value2 := env.GetOr("NONEXISTENT", "default")
    test.AssertEqual(value2, "default")

# Test GetInt function
test GetIntFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing valid integer
    value := env.GetInt("TEST_INT") onerr panic "get int failed"
    test.AssertEqual(value, 42)
    
    # Test non-existent variable
    _, err := env.GetInt("NONEXISTENT")
    test.AssertNotEmpty(err)
    
    # Test invalid integer
    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    _, err2 := env.GetInt("TEST_INVALID_INT")
    test.AssertNotEmpty(err2)

# Test GetIntOr function
test GetIntOrFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing valid integer
    value := env.GetIntOr("TEST_INT", 100) onerr panic "get int or failed"
    test.AssertEqual(value, 42)
    
    # Test non-existent variable
    value2 := env.GetIntOr("NONEXISTENT", 100) onerr panic "get int or failed"
    test.AssertEqual(value2, 100)
    
    # Test invalid integer
    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    _, err := env.GetIntOr("TEST_INVALID_INT", 100)
    test.AssertNotEmpty(err)

# Test GetIntOrDefault function
test GetIntOrDefaultFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing valid integer
    value := env.GetIntOrDefault("TEST_INT", 100)
    test.AssertEqual(value, 42)
    
    # Test non-existent variable
    value2 := env.GetIntOrDefault("NONEXISTENT", 100)
    test.AssertEqual(value2, 100)
    
    # Test invalid integer
    os.Setenv("TEST_INVALID_INT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_INT")
    value3 := env.GetIntOrDefault("TEST_INVALID_INT", 100)
    test.AssertEqual(value3, 100)

# Test GetBool function
test GetBoolFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing true boolean
    value := env.GetBool("TEST_BOOL_TRUE") onerr panic "get bool failed"
    test.AssertTrue(value)
    
    # Test existing false boolean
    value2 := env.GetBool("TEST_BOOL_FALSE") onerr panic "get bool failed"
    test.AssertFalse(value2)
    
    # Test non-existent variable
    _, err := env.GetBool("NONEXISTENT")
    test.AssertNotEmpty(err)
    
    # Test invalid boolean
    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    _, err2 := env.GetBool("TEST_INVALID_BOOL")
    test.AssertNotEmpty(err2)

# Test GetBoolOr function
test GetBoolOrFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing true boolean
    value := env.GetBoolOr("TEST_BOOL_TRUE", false) onerr panic "get bool or failed"
    test.AssertTrue(value)
    
    # Test non-existent variable
    value2 := env.GetBoolOr("NONEXISTENT", true) onerr panic "get bool or failed"
    test.AssertTrue(value2)
    
    # Test invalid boolean
    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    _, err := env.GetBoolOr("TEST_INVALID_BOOL", false)
    test.AssertNotEmpty(err)

# Test GetBoolOrDefault function
test GetBoolOrDefaultFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing true boolean
    value := env.GetBoolOrDefault("TEST_BOOL_TRUE", false)
    test.AssertTrue(value)
    
    # Test non-existent variable
    value2 := env.GetBoolOrDefault("NONEXISTENT", true)
    test.AssertTrue(value2)
    
    # Test invalid boolean
    os.Setenv("TEST_INVALID_BOOL", "invalid")
    defer os.Unsetenv("TEST_INVALID_BOOL")
    value3 := env.GetBoolOrDefault("TEST_INVALID_BOOL", false)
    test.AssertFalse(value3)

# Test GetFloat function
test GetFloatFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing valid float
    value := env.GetFloat("TEST_FLOAT") onerr panic "get float failed"
    test.AssertEqual(value, 3.14)
    
    # Test non-existent variable
    _, err := env.GetFloat("NONEXISTENT")
    test.AssertNotEmpty(err)
    
    # Test invalid float
    os.Setenv("TEST_INVALID_FLOAT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_FLOAT")
    _, err2 := env.GetFloat("TEST_INVALID_FLOAT")
    test.AssertNotEmpty(err2)

# Test GetFloatOr function
test GetFloatOrFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing valid float
    value := env.GetFloatOr("TEST_FLOAT", 2.71) onerr panic "get float or failed"
    test.AssertEqual(value, 3.14)
    
    # Test non-existent variable
    value2 := env.GetFloatOr("NONEXISTENT", 2.71) onerr panic "get float or failed"
    test.AssertEqual(value2, 2.71)
    
    # Test invalid float
    os.Setenv("TEST_INVALID_FLOAT", "not_a_number")
    defer os.Unsetenv("TEST_INVALID_FLOAT")
    _, err := env.GetFloatOr("TEST_INVALID_FLOAT", 2.71)
    test.AssertNotEmpty(err)

# Test GetList function
test GetListFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing list
    value := env.GetList("TEST_LIST", ",") onerr panic "get list failed"
    test.AssertEqual(len(value), 3)
    test.AssertEqual(value[0], "a")
    test.AssertEqual(value[1], "b")
    test.AssertEqual(value[2], "c")
    
    # Test non-existent variable
    _, err := env.GetList("NONEXISTENT", ",")
    test.AssertNotEmpty(err)

# Test GetListOr function
test GetListOrFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test existing list
    value := env.GetListOr("TEST_LIST", ",", list of string{"default"})
    test.AssertEqual(len(value), 3)
    test.AssertEqual(value[0], "a")
    
    # Test non-existent variable
    value2 := env.GetListOr("NONEXISTENT", ",", list of string{"default"})
    test.AssertEqual(len(value2), 1)
    test.AssertEqual(value2[0], "default")

# Test Set and Unset functions
test SetUnsetFunctions
    # Test setting a new variable
    err := env.Set("TEST_NEW_VAR", "new_value")
    test.AssertEqual(err, empty)
    value := os.Getenv("TEST_NEW_VAR")
    test.AssertEqual(value, "new_value")
    
    # Clean up
    env.Unset("TEST_NEW_VAR") onerr panic "unset failed"
    value2 := os.Getenv("TEST_NEW_VAR")
    test.AssertEqual(value2, "")

# Test IsSet and IsSetAndNotEmpty functions
test IsSetFunctions
    setupTestEnv()
    defer cleanupTestEnv()
    
    # Test IsSet with existing variable
    test.AssertTrue(env.IsSet("TEST_STRING"))
    
    # Test IsSet with non-existent variable
    test.AssertFalse(env.IsSet("NONEXISTENT"))
    
    # Test IsSetAndNotEmpty with existing non-empty variable
    test.AssertTrue(env.IsSetAndNotEmpty("TEST_STRING"))
    
    # Test IsSetAndNotEmpty with existing empty variable
    test.AssertFalse(env.IsSetAndNotEmpty("TEST_EMPTY"))
    
    # Test IsSetAndNotEmpty with non-existent variable
    test.AssertFalse(env.IsSetAndNotEmpty("NONEXISTENT"))

# Test All function
test AllFunction
    setupTestEnv()
    defer cleanupTestEnv()
    
    all := env.All()
    test.AssertNotEmpty(all)
    test.AssertTrue(len(all) >= 7)  # At least our test variables
    
    # Check that our test variables are in the map
    test.AssertEqual(all["TEST_STRING"], "hello")
    test.AssertEqual(all["TEST_INT"], "42")

# Test ParseBool function
test ParseBoolFunction
    # Test true values
    value, err := env.ParseBool("true")
    test.AssertEqual(err, empty)
    test.AssertTrue(value)
    
    value2, err2 := env.ParseBool("1")
    test.AssertEqual(err2, empty)
    test.AssertTrue(value2)
    
    value3, err3 := env.ParseBool("yes")
    test.AssertEqual(err3, empty)
    test.AssertTrue(value3)
    
    value4, err4 := env.ParseBool("on")
    test.AssertEqual(err4, empty)
    test.AssertTrue(value4)
    
    # Test false values
    value5, err5 := env.ParseBool("false")
    test.AssertEqual(err5, empty)
    test.AssertFalse(value5)
    
    value6, err6 := env.ParseBool("0")
    test.AssertEqual(err6, empty)
    test.AssertFalse(value6)
    
    value7, err7 := env.ParseBool("no")
    test.AssertEqual(err7, empty)
    test.AssertFalse(value7)
    
    value8, err8 := env.ParseBool("off")
    test.AssertEqual(err8, empty)
    test.AssertFalse(value8)
    
    # Test case insensitivity
    value9, err9 := env.ParseBool("TRUE")
    test.AssertEqual(err9, empty)
    test.AssertTrue(value9)
    
    # Test invalid value
    _, err10 := env.ParseBool("invalid")
    test.AssertNotEmpty(err10)

# Test SplitAndTrim function
test SplitAndTrimFunction
    # Test normal case
    result := env.SplitAndTrim("a, b,  c", ",")
    test.AssertEqual(len(result), 3)
    test.AssertEqual(result[0], "a")
    test.AssertEqual(result[1], "b")
    test.AssertEqual(result[2], "c")
    
    # Test with empty parts
    result2 := env.SplitAndTrim("a,, b,  ", ",")
    test.AssertEqual(len(result2), 2)
    test.AssertEqual(result2[0], "a")
    test.AssertEqual(result2[1], "b")
    
    # Test empty input
    result3 := env.SplitAndTrim("", ",")
    test.AssertEqual(len(result3), 0)

print("Env tests completed")