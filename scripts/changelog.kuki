# Changelog generator for Kukicha releases
# Uses Mistral (Chat Completions API) to generate/update CHANGELOG.md from git history.
# Also writes the new entry alone to changelog-entry.md for use as GitHub release notes.
#
# Usage:
#   kukicha run scripts/changelog.kuki [version]
#
# Examples:
#   kukicha run scripts/changelog.kuki v0.5.0   # specify version
#   kukicha run scripts/changelog.kuki           # auto-label as "Unreleased"
#
# Prerequisites:
#   export MISTRAL_API_KEY="..."

import "stdlib/llm"
import "stdlib/shell"
import "stdlib/files"
import "stdlib/string" as strpkg
import "os"

func main()
    # Determine version from CLI args
    version := "Unreleased"
    if len(os.Args) > 1
        version = os.Args[1]

    # Get sorted tag list to find the previous release tag
    # We use the second-most-recent tag so we capture commits *in* the current release,
    # not just commits after it (which would be the case if we used git describe HEAD).
    tagsRaw := shell.Output("git", "tag", "-l", "--sort=-version:refname") onerr ""
    tagsRaw = strpkg.Trim(tagsRaw, "\n")
    tagLines := strpkg.Split(tagsRaw, "\n")

    lastTag := ""
    if len(tagLines) > 1
        lastTag = tagLines[1]
    else if len(tagLines) == 1 and tagLines[0] != ""
        lastTag = tagLines[0]

    # Get commits since previous tag (or last 50 if no prior tags exist)
    gitLog := ""
    if lastTag != ""
        rangeArg := "{lastTag}..HEAD"
        gitLog = shell.Output("git", "log", rangeArg, "--oneline", "--no-merges") onerr panic "git log failed: {error}"
    else
        gitLog = shell.Output("git", "log", "--oneline", "--no-merges", "-50") onerr panic "git log failed: {error}"

    gitLog = strpkg.Trim(gitLog, "\n")
    if gitLog == ""
        print("No new commits since {lastTag}. Nothing to add to CHANGELOG.md.")
        return

    # Show what we're working with
    if lastTag != ""
        print("Generating changelog for {version} (commits since {lastTag})...")
    else
        print("Generating changelog for {version} (no prior tags found, using last 50 commits)...")
    print("")
    print(gitLog)
    print("")

    # Read existing CHANGELOG.md if present
    existing := ""
    if files.Exists("CHANGELOG.md")
        rawBytes := files.Read("CHANGELOG.md") onerr panic "Failed to read CHANGELOG.md: {error}"
        existing = rawBytes as string

    # Build the prompt
    context := ""
    if lastTag != ""
        context = "Previous release tag: {lastTag}\n"

    prompt := "You are a changelog writer for Kukicha, a beginner-friendly programming language that transpiles to Go.\n\n{context}New commits to summarize:\n{gitLog}\n\nWrite a single CHANGELOG entry for version {version}.\n\nRules:\n- Start with: ## [{version}] - YYYY-MM-DD (use today's date)\n- Group changes under ### Added, ### Changed, ### Fixed, ### Security (only include sections that apply)\n- Write concise bullet points from the developer perspective\n- Skip trivial or internal-only changes\n- Output ONLY the markdown section starting with ##, no preamble or explanation"

    entry := llm.New("mistral:mistral-large-latest")
        |> llm.MaxTokens(2048)
        |> llm.Retry(3, 1000)
        |> llm.Ask(prompt)
        onerr panic "LLM call failed: {error}"

    # Build updated CHANGELOG.md
    header := "# Changelog\n\nAll notable changes to Kukicha will be documented in this file.\nThis file is auto-generated by `scripts/changelog.kuki`.\n\n"

    newContent := ""
    if existing == ""
        newContent = header + entry + "\n"
    else if strpkg.Contains(existing, "\n## ")
        # Splice new entry in after the file header, before the first ## section
        parts := strpkg.SplitN(existing, "\n## ", 2)
        newContent = parts[0] + "\n" + entry + "\n\n## " + parts[1]
    else
        newContent = existing + "\n" + entry + "\n"

    files.WriteString(newContent, "CHANGELOG.md") onerr panic "Failed to write CHANGELOG.md: {error}"
    files.WriteString(entry, "changelog-entry.md") onerr panic "Failed to write changelog-entry.md: {error}"

    print("CHANGELOG.md updated.")
    print("")
    print(entry)
