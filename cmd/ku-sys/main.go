// Generated by Kukicha v0.0.5 (requires Go 1.26+)
//
// Performance: GOEXPERIMENT=jsonv2 enables faster JSON parsing (2-10x improvement)

package main

import (
	"fmt"
	"github.com/duber000/kukicha/stdlib/cast"
	"github.com/duber000/kukicha/stdlib/cli"
	"github.com/duber000/kukicha/stdlib/json"
	"github.com/duber000/kukicha/stdlib/shell"
)

//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:9
func main() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:10
	app := cli.New("ku-sys")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:12
	app = cli.Arg(app, "command", "Subcommand: service-status, restart-service")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:13
	app = cli.Arg(app, "service", "Name of the systemd service")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:15
	app = cli.Action(app, runAppAction)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:17
	err := cli.RunApp(app)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:18
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:19
		fmt.Println(fmt.Sprintf("{{\"error\": \"CLI Run failed: %v\"}}", err))
	}
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:21
func runAppAction(args cli.Args) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:22
	command := cli.GetString(args, "command")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:23
	service := cli.GetString(args, "service")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:25
	if service == "" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:26
		fmt.Println("{{\"error\": \"Service name is required\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:27
		return
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:29
	if command == "service-status" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:30
		handleServiceStatus(service)
	} else if command == "restart-service" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:32
		handleRestartService(service)
	} else {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:34
		fmt.Println("{{\"error\": \"Unknown command. Use service-status or restart-service.\"}}")
	}
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:36
func handleServiceStatus(service string) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:37
	cmd := shell.New("systemctl", "status", "--no-pager", service)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:38
	result := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:40
	stdoutStr, outErr := cast.SmartString(shell.GetOutput(result))
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:41
	if outErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:42
		stdoutStr = ""
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:43
	stderrStr, errErr := cast.SmartString(shell.GetError(result))
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:44
	if errErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:45
		stderrStr = ""
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:47
	state := "active"
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:48
	if !shell.Success(result) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:49
		state = "inactive_or_failed"
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:51
	combined := stdoutStr
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:52
	if stderrStr != "" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:53
		combined = ((combined + "\n") + stderrStr)
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:60
	outMap := map[string]any{"service": service, "action": "service_status", "systemctl_status": state, "output": combined}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:62
	printJsonResult(outMap)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:64
func handleRestartService(service string) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:65
	cmd := shell.New("systemctl", "restart", "--no-pager", service)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:66
	result := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:68
	stdoutStr, outErr := cast.SmartString(shell.GetOutput(result))
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:69
	if outErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:70
		stdoutStr = ""
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:71
	stderrStr, errErr := cast.SmartString(shell.GetError(result))
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:72
	if errErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:73
		stderrStr = ""
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:78
	outMap := map[string]any{"service": service, "action": "restart_service"}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:80
	if !shell.Success(result) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:81
		outMap["status"] = "failed"
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:82
		outMap["error"] = stderrStr
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:83
		outMap["output"] = stdoutStr
	} else {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:85
		outMap["status"] = "success"
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:86
		outMap["message"] = fmt.Sprintf("Service %v restarted successfully.", service)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:87
		outMap["output"] = stdoutStr
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:89
	printJsonResult(outMap)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:91
func printJsonResult(result any) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:92
	out, jsonErr := json.Marshal(result)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:93
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:94
		fmt.Println("{{\"error\": \"Failed to marshal result\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:95
		return
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:97
	s, castErr := cast.SmartString(out)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:98
	if castErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:99
		fmt.Println("{{\"error\": \"Failed to format output\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:100
		return
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-sys/main.kuki:102
	fmt.Println(s)
}
