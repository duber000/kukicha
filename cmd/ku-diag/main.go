// Generated by Kukicha v0.0.5 (requires Go 1.26+)
//
// Performance: GOEXPERIMENT=jsonv2 enables faster JSON parsing (2-10x improvement)

package main

import (
	"fmt"
	"github.com/duber000/kukicha/stdlib/cast"
	"github.com/duber000/kukicha/stdlib/cli"
	"github.com/duber000/kukicha/stdlib/json"
	"github.com/duber000/kukicha/stdlib/shell"
)

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:9
func main() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:10
	app := cli.New("ku-diag")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:12
	app = cli.Arg(app, "command", "Subcommand: sysinfo, cpu, memory, disk, services, service-status, service-logs, processes, journal, network, ports, connections")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:13
	app = cli.AddFlag(app, "name", "Name of the service", "")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:14
	app = cli.AddFlag(app, "priority", "Journal priority (emerg|alert|crit|err|warning|notice|info|debug)", "err")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:15
	app = cli.AddFlag(app, "lines", "Number of log lines to show", "50")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:17
	app = cli.Action(app, runAppAction)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:19
	err := cli.RunApp(app)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:20
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:21
		fmt.Println(fmt.Sprintf("{{\"error\": \"CLI Run failed: %v\"}}", err))
	}
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:23
func runAppAction(args cli.Args) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:24
	command := cli.GetString(args, "command")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:25
	name := ""
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:26
	lines := ""
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:27
	priority := ""
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:29
	switch command {
	case "sysinfo":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:31
		handleSysInfo()
	case "cpu":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:33
		handleCpu()
	case "memory":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:35
		handleMemory()
	case "disk":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:37
		handleDisk()
	case "services":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:39
		handleServices()
	case "service-status":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:41
		name = cli.GetString(args, "name")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:42
		if name == "" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:43
			fmt.Println("{{\"error\": \"--name is required for service-status\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:44
			return
		}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:45
		handleServiceStatus(name)
	case "service-logs":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:47
		name = cli.GetString(args, "name")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:48
		lines = cli.GetString(args, "lines")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:49
		if name == "" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:50
			fmt.Println("{{\"error\": \"--name is required for service-logs\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:51
			return
		}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:52
		handleServiceLogs(name, lines)
	case "processes":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:54
		handleProcesses()
	case "journal":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:56
		priority = cli.GetString(args, "priority")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:57
		lines = cli.GetString(args, "lines")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:58
		handleJournal(priority, lines)
	case "network":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:60
		handleNetwork()
	case "ports":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:62
		handlePorts()
	case "connections":
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:64
		handleConnections()
	default:
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:66
		fmt.Println("{{\"error\": \"Unknown command. Use --help for available commands.\"}}")
	}
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:68
func handleSysInfo() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:69
	cmd1 := shell.New("hostnamectl")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:70
	res1 := shell.Execute(cmd1)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:72
	cmd2 := shell.New("uptime")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:73
	res2 := shell.Execute(cmd2)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:79
	out := map[string]any{"action": "sysinfo", "hostnamectl": safeSmartString(shell.GetOutput(res1)), "uptime": safeSmartString(shell.GetOutput(res2))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:80
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:82
func handleCpu() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:83
	cmd1 := shell.New("lscpu")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:84
	res1 := shell.Execute(cmd1)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:86
	cmd2 := shell.New("cat", "/proc/loadavg")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:87
	res2 := shell.Execute(cmd2)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:93
	out := map[string]any{"action": "cpu", "lscpu": safeSmartString(shell.GetOutput(res1)), "loadavg": safeSmartString(shell.GetOutput(res2))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:94
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:96
func handleMemory() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:97
	cmd := shell.New("free", "-b")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:98
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:103
	out := map[string]any{"action": "memory", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:104
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:106
func handleDisk() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:107
	cmd := shell.New("df", "-h")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:108
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:113
	out := map[string]any{"action": "disk", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:114
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:116
func handleServices() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:117
	cmd := shell.New("systemctl", "list-units", "--type=service", "--no-pager")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:118
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:123
	out := map[string]any{"action": "services", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:124
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:126
func handleServiceStatus(name string) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:127
	cmd := shell.New("systemctl", "status", "--no-pager", name)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:128
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:136
	out := map[string]any{"action": "service_status", "service": name, "success": shell.Success(res), "output": safeSmartString(shell.GetOutput(res)), "error": safeSmartString(shell.GetError(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:137
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:139
func handleServiceLogs(name string, lines string) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:140
	cmd := shell.New("journalctl", "-u", name, "--no-pager", "-n", lines)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:141
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:147
	out := map[string]any{"action": "service_logs", "service": name, "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:148
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:150
func handleProcesses() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:151
	cmd := shell.New("ps", "aux", "--sort=-%cpu")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:152
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:157
	out := map[string]any{"action": "processes", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:158
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:160
func handleJournal(priority string, lines string) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:161
	cmd := shell.New("journalctl", "--no-pager", "-p", priority, "-n", lines)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:162
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:168
	out := map[string]any{"action": "journal", "priority": priority, "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:169
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:171
func handleNetwork() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:172
	cmd := shell.New("ip", "-j", "addr", "show")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:173
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:174
	output := safeSmartString(shell.GetOutput(res))
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:176
	if output == "" {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:177
		cmd = shell.New("ip", "addr", "show")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:178
		res = shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:179
		output = safeSmartString(shell.GetOutput(res))
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:184
	out := map[string]any{"action": "network", "output": output}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:185
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:187
func handlePorts() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:188
	cmd := shell.New("ss", "-tlnp")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:189
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:194
	out := map[string]any{"action": "ports", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:195
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:197
func handleConnections() {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:198
	cmd := shell.New("ss", "-tnp")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:199
	res := shell.Execute(cmd)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:204
	out := map[string]any{"action": "connections", "output": safeSmartString(shell.GetOutput(res))}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:205
	printJsonResult(out)
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:207
func safeSmartString(data []byte) string {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:208
	s, err := cast.SmartString(data)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:209
	if err != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:210
		return ""
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:211
	return s
}

//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:213
func printJsonResult(result any) {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:214
	out, jsonErr := json.Marshal(result)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:215
	if jsonErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:216
		fmt.Println("{{\"error\": \"Failed to marshal result\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:217
		return
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:219
	s, castErr := cast.SmartString(out)
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:220
	if castErr != nil {
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:221
		fmt.Println("{{\"error\": \"Failed to format output\"}}")
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:222
		return
	}
//line /var/home/tluker/repos/go/kukicha/cmd/ku-diag/main.kuki:224
	fmt.Println(s)
}
